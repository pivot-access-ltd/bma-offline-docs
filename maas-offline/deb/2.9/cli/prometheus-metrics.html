<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/prometheus-metrics.html">
	  &nbsp;UI-only&nbsp;
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  CLI-only
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="give-me-an-example-of-maas.html">
	    &ldquo;Give me an example&rdquo;
	  </a>
	</li>
	<li>
	  <a href="whats-new-in-maas.html">
	    What&rsquo;s new in 2.9
	  </a>
	</li>
	<li>
	  <a href="maas-requirements.html">
	    Requirements
	  </a>
	</li>
	<li>
	  <a href="maas-installation.html">
	    Installation
	  </a>
	</li>
	<li>
	  <a href="configuration-journey.html">
	    Configuration journey
	  </a>
	</li>
      <strong>
	<a href="controllers.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-communication.html">
	    Communication
	  </a>
	</li>
	<li>
	  <a href="rack-controllers.html">
	    Rack controllers
	  </a>
	</li>
	<li>
	  <a href="region-controllers.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="high-availability.html">
	    High availability
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machines.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="add-machines.html">
	    Add machines
	  </a>
	</li>
	<li>
	  <a href="power-management.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commission-machines.html">
	    Commission machines
	  </a>
	</li>
	<li>Testing
	</li>
	<li>
	  <a href="hardware-testing.html">
	    Hardware testing
	  </a>
	</li>
	<li>
	  <a href="network-testing.html">
	    Network testing
	  </a>
	</li>
	<li>
	  <a href="commissioning-and-hardware-testing-scripts.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="maas-tags.html">
	    Tags
	  </a>
	</li>
	<li>
	  <a href="custom-machine-setup.html">
	    Custom machine setup
	  </a>
	</li>
	<li>
	  <a href="kernel-boot-options.html">
	    Kernel boot options
	  </a>
	</li>
	<li>
	  <a href="resource-pools.html">
	    Resource pools
	  </a>
	</li>
	<li>
	  <a href="storage.html">
	    Storage
	  </a>
	</li>
	<li>
	  <a href="vmware-vmfs-datastores.html">
	    VMware VMFS datastores
	  </a>
	</li>
	<li>
	  <a href="ubuntu-kernels.html">
	    Ubuntu kernels
	  </a>
	</li>
      </ul>
      <strong>
	<a href="images.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="select-and-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="local-image-mirror.html">
	    Local image mirror
	  </a>
	</li>
	<li>
	  <a href="vmware-images.html">
	    VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="networking.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="subnet-management.html">
	    Subnet management
	  </a>
	</li>
	<li>
	  <a href="managing-dhcp.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="ip-ranges.html">
	    IP ranges
	  </a>
	</li>
	<li>
	  <a href="proxy.html">
	    Proxy
	  </a>
	</li>
	<li>
	  <a href="ntp-services.html">
	    NTP
	  </a>
	</li>
	<li>
	  <a href="network-discovery.html">
	    Network discovery
	  </a>
	</li>
	<li>
	  <a href="ipv6-addressing.html">
	    IPv6
	  </a>
	</li>
	<li>
	  <a href="configuring-tls-encryption.html">
	    SSL
	  </a>
	</li>
	<li>
	  <a href="managing-stp.html">
	    STP
	  </a>
	</li>
	<li>
	  <a href="availability-zones.html">
	    Availability zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="vm-hosting.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="vm-host-networking.html">
	    VM host networking
	  </a>
	</li>
	<li>
	  <a href="adding-a-vm-host.html">
	    Add a VM host
	  </a>
	</li>
	<li>
	  <a href="vm-host-storage-pools.html">
	    VM host storage pools
	  </a>
	</li>
	<li>
	  <a href="creating-and-deleting-vms.html">
	    Creating and deleting VMs
	  </a>
	</li>
      </ul>
      <strong>Operations
      </strong>
      <ul>
	<li>
	  <a href="prometheus-metrics.html">
	    Prometheus metrics
	  </a>
	</li>
	<li>
	  <a href="backup.html">
	    Backup
	  </a>
	</li>
	<li>
	  <a href="hardening-your-maas-installation.html">
	    MAAS security
	  </a>
	</li>
	<li>
	  <a href="maas-logging.html">
	    Logging
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="user-accounts.html">
	    User accounts
	  </a>
	</li>
	<li>
	  <a href="interactive-search.html">
	    Interactive search
	  </a>
	</li>
      </ul>
      <strong>
	<a href="concepts-and-terms.html">
	  Concepts &amp; terms
	</a>
      </strong>
      <ul>
	<li>
	  <a href="concepts-and-terms.html#heading--network-tutorial">
	    Brief network tutorial
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-cli.html">
	  CLI
	</a>
      </strong>
      <ul>
	<li>
	  <a href="common-cli-tasks.html">
	    The CLI cookbook
	  </a>
	</li>
	<li>
	  <a href="common-cli-tasks.html">
	    Common tasks
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="cli-kernel-management.html">
	    Kernel management
	  </a>
	</li>
	<li>
	  <a href="cli-image-management.html">
	    Image management
	  </a>
	</li>
	<li>
	  <a href="cli-interface-management.html">
	    Interface management
	  </a>
	</li>
	<li>
	  <a href="cli-advanced-tasks.html">
	    Advanced tasks
	  </a>
	</li>
	<li>
	  <a href="cli-composable-hardware.html">
	    Composable hardware
	  </a>
	</li>
	<li>
	  <a href="python-api-client.html">
	    API client
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api.html">
	  API documentation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication.html">
	    API authentication
	  </a>
	</li>
      </ul>
      <strong>
	<a href="troubleshooting.html">
	  Troubleshoot
	</a>
      </strong>
      <ul>
	<li>
	  <a href="getting-help.html">
	    Getting help
	  </a>
	</li>
	<li>
	  <a href="tips-tricks-and-traps.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="https://old-docs.maas.io/2.5/en/">
	    MAAS 2.5 (+ earlier) doc
	  </a>
	</li>
      </ul>
      <strong>
	<a href="whats-new-in-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="writing-guide.html">
	  Help improve these docs
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>Prometheus metrics</h1><!-- deb-2-7-cli
 deb-2-7-cli -->

<!-- deb-2-7-ui
 deb-2-7-ui -->

<!-- deb-2-8-cli
 deb-2-8-cli -->

<!-- deb-2-8-ui
 deb-2-8-ui -->

<!-- deb-2-9-ui
 deb-2-9-ui -->

<!-- snap-2-7-cli
 snap-2-7-cli -->

<!-- snap-2-7-ui
 snap-2-7-ui -->

<!-- snap-2-8-cli
 snap-2-8-cli -->

<!-- snap-2-8-ui
 snap-2-8-ui -->

<!-- snap-2-9-cli
 snap-2-9-cli -->

<!-- snap-2-9-ui
 snap-2-9-ui -->

<p>MAAS services can provide <a href="https://prometheus.io/">Prometheus</a> endpoints for collecting performance metrics.  These include:</p>
<ul>
<li>TFTP server file transfer latency</li>
<li>HTTP requests latency</li>
<li>Websocket requests latency</li>
<li>RPC calls (between MAAS services) latency</li>
<li>Per request DB queries counts</li>
</ul>
<p>All available metrics are prefixed with <code>maas_</code>, to make it easier to look them up in Prometheus and Grafana UIs.</p>
<h4>Quick questions you may have:</h4>
<ul>
<li><a href="#heading--enabling-prometheus-endpoints">How do I enable Prometheus endpoints?</a></li>
<li><a href="#heading--configuring-prometheus">How do I configure Prometheus endpoints?</a></li>
<li><a href="#heading--deploying-prometheus-and-grafana">How can I deploy Prometheus and Grafana?</a></li>
</ul>
<h2 id="heading--enabling-prometheus-endpoints">Enabling Prometheus endpoints</h2>

<p>Whenever you install the <code>python3-prometheus-client</code> library, Prometheus endpoints are exposed over HTTP by the <code>rackd</code> and <code>regiond</code> processes under the default <code>/metrics</code> path.</p>
<p><strong>NOTE:</strong> 
Currently, prometheus metrics are shared when rack and region controllers are running on the same machine, even though each service provides its own port.  You can safely only query one of the two ports if you&rsquo;re running both controllers.</p>
<!-- snap-2-7-ui snap-2-7-cli snap-2-8-ui snap-2-8-cli snap-2-9-ui snap-2-9-cli
For a snap-based MAAS installation, the libraries already included in the snap so that metrics will be available out of the box.
snap-2-7-ui snap-2-7-cli snap-2-8-ui snap-2-8-cli snap-2-9-ui snap-2-9-cli -->

<p>For a Debian-based MAAS installation, install the library and restart MAAS services as follows:</p>
<pre><code>sudo apt install python3-prometheus-client
sudo systemctl restart maas-rackd
sudo systemctl restart maas-regiond
</code></pre>
<p>MAAS also provides optional stats about resources registered with the MAAS server itself.</p>
<p>These include:</p>
<ul>
<li>The number of nodes by type, arch, &hellip;</li>
<li>Number of networks, spaces, fabrics, VLANs and subnets</li>
<li>Total counts for machines CPU cores, memory and storage</li>
<li>Counters for VM host resources</li>
</ul>
<p>After installing the <code>python3-prometheus-client</code> library as describe above, run the following to enable stats:</p>
<pre><code>maas $PROFILE maas set-config name=prometheus_enabled value=true
</code></pre>
<h2 id="heading--configuring-prometheus">Configuring Prometheus</h2>

<p>Once the <code>/metrics</code> endpoint is available in MAAS services, Prometheus can be configured to scrape metric values from these. You can configure this by adding a stanza like the following to the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">prometheus configuration^</a>:</p>
<pre><code class="yaml">    - job_name: maas
      static_configs:
        - targets:
          - &lt;maas-host1-IP&gt;:5239  # for regiond
          - &lt;maas-host1-IP&gt;:5249  # for rackd
          - &lt;maas-host2-IP&gt;:5239  # regiond-only
          - &lt;maas-host3-IP&gt;:5249  # rackd-only
</code></pre>

<p>If the MAAS installation includes multiple nodes, the <code>targets</code> entries must be adjusted accordingly, to match services deployed on each node.</p>
<p>If  you have enabled MAAS stats,  you must add an additional Prometheus job to the config:</p>
<pre><code class="yaml">    - job_name: maas
      metrics_path: /MAAS/metrics
      static_configs:
        - targets:
          - &lt;maas-host-IP&gt;:5240
</code></pre>

<p>In case of a multi-host deploy, adding a single IP for any of the MAAS hosts running <code>regiond</code> will suffice.</p>
<h2 id="heading--deploying-prometheus-and-grafana">Deploying Prometheus and Grafana</h2>

<p><a href="https://grafana.com/">Grafana^</a> and Prometheus can be easily deployed using <a href="https://jujucharms.com/">Juju^</a>.</p>
<p>The <a href="https://git.launchpad.net/~maas-committers/maas/+git/maas-performance">MAAS performance repo^</a> repository provides a sample <code>deploy-stack</code> script that will deploy and configure the stack on LXD containers.</p>
<p>First, you must install juju via:</p>
<pre><code>sudo snap install --classic juju
</code></pre>
<p>Then you can run the script from the repo:</p>
<pre><code>grafana/deploy-stack &lt;MAAS-IP&gt;
</code></pre>
<p>To follow the progress of the deployment, run the following:</p>
<pre><code>watch -c juju status --color
</code></pre>
<p>Once you deploy everything, the Grafana UI is accessible on port <code>3000</code> with the credentials <code>admin</code>/<code>grafana</code>. The Prometheus UI will be available on port <code>9090</code>.</p>
<p>The repository also provides some sample dashboard covering the most common use cases for graphs. These are available under <code>grafana/dashboards</code>.  You can import them from the Grafana UI or API.</p>
    </div>
  </body>
</html>