<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/maas-image-builder.html">
	  &nbsp;UI-only&nbsp;
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  CLI-only
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="give-me-an-example-of-maas.html">
	    &ldquo;Give me an example&rdquo;
	  </a>
	</li>
	<li>
	  <a href="whats-new-in-maas.html">
	    What&rsquo;s new in 2.9
	  </a>
	</li>
	<li>
	  <a href="maas-requirements.html">
	    Requirements
	  </a>
	</li>
	<li>
	  <a href="maas-installation.html">
	    Installation
	  </a>
	</li>
	<li>
	  <a href="configuration-journey.html">
	    Configuration journey
	  </a>
	</li>
      <strong>
	<a href="controllers.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-communication.html">
	    Communication
	  </a>
	</li>
	<li>
	  <a href="rack-controllers.html">
	    Rack controllers
	  </a>
	</li>
	<li>
	  <a href="region-controllers.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="high-availability.html">
	    High availability
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machines.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="add-machines.html">
	    Add machines
	  </a>
	</li>
	<li>
	  <a href="power-management.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commission-machines.html">
	    Commission machines
	  </a>
	</li>
	<li>Testing
	</li>
	<li>
	  <a href="hardware-testing.html">
	    Hardware testing
	  </a>
	</li>
	<li>
	  <a href="network-testing.html">
	    Network testing
	  </a>
	</li>
	<li>
	  <a href="commissioning-and-hardware-testing-scripts.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="maas-tags.html">
	    Tags
	  </a>
	</li>
	<li>
	  <a href="custom-machine-setup.html">
	    Custom machine setup
	  </a>
	</li>
	<li>
	  <a href="kernel-boot-options.html">
	    Kernel boot options
	  </a>
	</li>
	<li>
	  <a href="resource-pools.html">
	    Resource pools
	  </a>
	</li>
	<li>
	  <a href="storage.html">
	    Storage
	  </a>
	</li>
	<li>
	  <a href="vmware-vmfs-datastores.html">
	    VMware VMFS datastores
	  </a>
	</li>
	<li>
	  <a href="ubuntu-kernels.html">
	    Ubuntu kernels
	  </a>
	</li>
      </ul>
      <strong>
	<a href="images.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="select-and-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="local-image-mirror.html">
	    Local image mirror
	  </a>
	</li>
	<li>
	  <a href="vmware-images.html">
	    VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="networking.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="subnet-management.html">
	    Subnet management
	  </a>
	</li>
	<li>
	  <a href="managing-dhcp.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="ip-ranges.html">
	    IP ranges
	  </a>
	</li>
	<li>
	  <a href="proxy.html">
	    Proxy
	  </a>
	</li>
	<li>
	  <a href="ntp-services.html">
	    NTP
	  </a>
	</li>
	<li>
	  <a href="network-discovery.html">
	    Network discovery
	  </a>
	</li>
	<li>
	  <a href="ipv6-addressing.html">
	    IPv6
	  </a>
	</li>
	<li>
	  <a href="configuring-tls-encryption.html">
	    SSL
	  </a>
	</li>
	<li>
	  <a href="managing-stp.html">
	    STP
	  </a>
	</li>
	<li>
	  <a href="availability-zones.html">
	    Availability zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="vm-hosting.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="vm-host-networking.html">
	    VM host networking
	  </a>
	</li>
	<li>
	  <a href="adding-a-vm-host.html">
	    Add a VM host
	  </a>
	</li>
	<li>
	  <a href="vm-host-storage-pools.html">
	    VM host storage pools
	  </a>
	</li>
	<li>
	  <a href="creating-and-deleting-vms.html">
	    Creating and deleting VMs
	  </a>
	</li>
      </ul>
      <strong>Operations
      </strong>
      <ul>
	<li>
	  <a href="prometheus-metrics.html">
	    Prometheus metrics
	  </a>
	</li>
	<li>
	  <a href="backup.html">
	    Backup
	  </a>
	</li>
	<li>
	  <a href="hardening-your-maas-installation.html">
	    MAAS security
	  </a>
	</li>
	<li>
	  <a href="maas-logging.html">
	    Logging
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="user-accounts.html">
	    User accounts
	  </a>
	</li>
	<li>
	  <a href="interactive-search.html">
	    Interactive search
	  </a>
	</li>
      </ul>
      <strong>
	<a href="concepts-and-terms.html">
	  Concepts &amp; terms
	</a>
      </strong>
      <ul>
	<li>
	  <a href="concepts-and-terms.html#heading--network-tutorial">
	    Brief network tutorial
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-cli.html">
	  CLI
	</a>
      </strong>
      <ul>
	<li>
	  <a href="common-cli-tasks.html">
	    The CLI cookbook
	  </a>
	</li>
	<li>
	  <a href="common-cli-tasks.html">
	    Common tasks
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="cli-kernel-management.html">
	    Kernel management
	  </a>
	</li>
	<li>
	  <a href="cli-image-management.html">
	    Image management
	  </a>
	</li>
	<li>
	  <a href="cli-interface-management.html">
	    Interface management
	  </a>
	</li>
	<li>
	  <a href="cli-advanced-tasks.html">
	    Advanced tasks
	  </a>
	</li>
	<li>
	  <a href="cli-composable-hardware.html">
	    Composable hardware
	  </a>
	</li>
	<li>
	  <a href="python-api-client.html">
	    API client
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api.html">
	  API documentation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication.html">
	    API authentication
	  </a>
	</li>
      </ul>
      <strong>
	<a href="troubleshooting.html">
	  Troubleshoot
	</a>
      </strong>
      <ul>
	<li>
	  <a href="getting-help.html">
	    Getting help
	  </a>
	</li>
	<li>
	  <a href="tips-tricks-and-traps.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="https://old-docs.maas.io/2.5/en/">
	    MAAS 2.5 (+ earlier) doc
	  </a>
	</li>
      </ul>
      <strong>
	<a href="whats-new-in-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="writing-guide.html">
	  Help improve these docs
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>MAAS image builder</h1><!-- deb-2-7-cli
 deb-2-7-cli -->

<!-- deb-2-7-ui
 deb-2-7-ui -->

<!-- deb-2-8-cli
 deb-2-8-cli -->

<!-- deb-2-8-ui
 deb-2-8-ui -->

<!-- deb-2-9-ui
 deb-2-9-ui -->

<!-- snap-2-7-cli
 snap-2-7-cli -->

<!-- snap-2-7-ui
 snap-2-7-ui -->

<!-- snap-2-8-cli
 snap-2-8-cli -->

<!-- snap-2-8-ui
 snap-2-8-ui -->

<!-- snap-2-9-cli
 snap-2-9-cli -->

<!-- snap-2-9-ui
 snap-2-9-ui -->

<p>MAAS Image Builder is an alternative to <a href="https://www.packer.io/">packer</a> for creating MAAS images.  </p>
<p><strong>NOTE:</strong> 
In order to use MAAS Image Builder, you must purchase <a href="https://support.canonical.com/ua/s/article/How-to-access-the-MAAS-Image-Builder-tool">Ubuntu Advantage for Infrastructure</a>.</p>
<p>With the MAAS Image Builder, you can do five key operations:</p>
<ol>
<li><a href="#imib">install MAAS Image Builder</a> via a private Canonical PPA (which you can request)</li>
<li><a href="#bci">create custom CentOS images</a></li>
<li><a href="#bri">create custom RHEL images</a></li>
<li><a href="#bwi">create Windows images</a></li>
<li><a href="#doci">create other kinds of custom images</a></li>
</ol>
<p>You can customise most images as much or as little as you wish, then use them to commission machines with MAAS. </p>
<p><a name="imib"><h3>Install MAAS Image Builder</h3></a></p>
<p>To get MAAS Image Builder, you must be subscribed to a private PPA provided by Canonical Support to those customers who have purchased <a href="https://support.canonical.com/ua/s/article/How-to-access-the-MAAS-Image-Builder-tool">Ubuntu Advantage for Infrastructure</a>.  Note that the steps below will fail if you have not purchased Ubuntu Advantage and been subscribed to the private PPA by your Canonical support rep.</p>
<p>Once subscribed, you need to obtain your credentials at this external link:</p>
<p>https://launchpad.net/~/+archivesubscriptions</p>
<p>Also, you must add the repository with the <code>add-apt-repository</code> command.  Note: Be sure to substitute your unique URL in the command below:</p>
<pre><code>$ sudo add-apt-repository \
“https://LaunchpadID:Password@private-ppa.launchpad.net/maas-image-builder-partners/stable/ubuntu"
</code></pre>
<p>Once you have added the private PPA, you can install the Image Builder like this:</p>
<pre><code>$ sudo apt-get install maas-image-builder
</code></pre>
<p>All done? Great!  Now you can build and customise images for MAAS machines, as shown in the sections below.</p>
<p><a name="bci"><h3>Create custom CentOS images</h3></a></p>
<p>MAAS already provides the latest available CentOS 6, CentOS 7, and CentOS 8 for automatic download. If you need something else, though, MAAS Image Builder supports the ability to create various CentOS images.</p>
<h4>Network Requirements</h4>

<p>Access to the Internet is required, since you will need to start with one of these three sites:</p>
<ol>
<li>https://mirror.centos.org  - OS, updates, and extra repositories</li>
<li>https://download.fedoraproject.org  - EPEL</li>
<li>https://copr-be.cloud.fedoraproject.org - Canonical maintained cloud-init repository</li>
</ol>
<h4>Creating images behind a proxy</h4>

<p>MAAS Image Builder can create CentOS images behind a proxy &ndash; just set the ‘http_proxy’ environment variable to <em>your</em> particular proxy. Once deployed, <code>yum</code> will use this MAAS-configured proxy.</p>
<h4>Creating the images</h4>

<p><code>maas-image-builder</code> is designed to automate the process of generating the images for MAAS and <code>curtin</code>.  Here are some specific examples:</p>
<pre><code>$ sudo maas-image-builder -o centos6-amd64-root-tgz --arch amd64 centos --edition 6 
$ sudo maas-image-builder -o centos6-i386-root-tgz --arch i386 centos --edition 6
$ sudo maas-image-builder -o centos7-amd64-root-tgz --arch amd64 centos --edition 7
</code></pre>
<h4>Customising CentOS images</h4>

<p>Starting from MAAS Image Builder 1.0.4, customisation of CentOS images is now supported.  You can provide a custom kickstart, in <em>addition</em> to the kickstart that MAAS Image Builder uses to create the images. You can customise your image like this:</p>
<pre><code>$ sudo maas-image-builder -o centos7-amd64-root-tgz --arch amd64 centos --edition 7 --custom-kickstart ./custom.ks
</code></pre>
<h4>Uploading the image into MAAS</h4>

<p>Custom CentOS images can be uploaded to MAAS as shown in the command below.  <em>Do note</em> that the name <strong>must</strong> start with ‘centos’ and <strong>must</strong> be one line:</p>
<pre><code>maas admin boot-resources create name=centos/centos6-custom architecture=amd64/generic content@=./build-output/centos-amd64-root-tgz
</code></pre>
<p>You can use the MAAS WebUI to check that your custom CentOS image is valid and selectable for deployment.</p>
<p><a name="bri"><h3>Building RHEL images</h3></a></p>
<p>Currently, MAAS <em>only</em> supports RHEL as a custom image. In future versions of MAAS, RHEL will be natively supported.</p>
<h4>Some Requirements</h4>

<p>In order to create RHEL images, you will need access to these three sites:</p>
<ol>
<li>A RHEL DVD ISO - Contains all RHEL archives which are not available without a license</li>
<li>https://download.fedoraproject.org - Access to the EPEL repository to install required deps</li>
<li>https://copr-be.cloud.fedoraproject.org - Access to the Canonical maintained cloud-init copr repository</li>
</ol>
<h4>Creating images behind a proxy</h4>

<p>MAAS image builder supports creating RHEL images behind a proxy. To use a proxy when building a RHEL image, just set the ‘http_proxy’ environment variable to <em>your</em> local proxy. Once deployed, <code>yum</code> will use the MAAS-configured proxy.</p>
<h4>Creating the images</h4>

<p>To generate a usable RHEL image, <code>maas-image-builder</code> automates image generation; these images can be used by MAAS and <code>curtin</code>.</p>
<pre><code> $ sudo maas-image-builder -a amd64 -o rhel7-amd64-root-tgz rhel --rhel-iso blah.iso
</code></pre>
<h4>Install into MAAS</h4>

<p>The custom RHEL image can be uploaded to MAAS, but note that the name <strong>must</strong> start with ‘rhel’ and <strong>must</strong> be expressed as a single line, like this:</p>
<pre><code>maas admin boot-resources create name=rhel/7 title="RedHat Enterprise Linux 7" architecture=amd64/generic content@=rhel7-amd64-root-tgz
</code></pre>
<p><a name="bwi"><h3>Building Windows Images</h3></a></p>
<p>Since Windows is a proprietary operating system, MAAS can&rsquo;t download these images. You need to manually generate images to use with MAAS.  On the upside, the end result will be much simpler, since there are CLI and WebUI tools to upload a Windows ISO &ndash; which <em>helps</em> automate the process.</p>
<p><b>Hyper-V 2012 R2</b>
In this example, Windows Hyper-V 2012 R2 is used, but rest assured that multiple versions are supported. Download the Hyper-V 2012 R2 ISO from Microsoft, so it can be used in the image generation process.  You can obtain the download at:</p>
<p>http://technet.microsoft.com/en-US/evalcenter/dn205299.aspx</p>
<p>There are six other supported versions (for &ndash;windows-edition):</p>
<ol>
<li>win2012</li>
<li>win2012r2</li>
<li>win2012hv</li>
<li>win2012hvr2</li>
<li>win2016</li>
<li>win2016hv</li>
</ol>
<h4>Image Builder</h4>

<p>MAAS Image builder can automate the process of generating images for MAAS and <code>curtin</code>.  In this instance,  though, you need Windows drivers for your specific hardware.  You can obtain these windows drivers with the following command:</p>
<pre><code>sudo maas-image-builder -o windows-win2012hvr2-amd64-root-dd  windows \
--windows-iso ~/Downloads/2012hvr2.ISO \
--windows-edition win2012hvr2 [--windows-updates] \
[--windows-drivers &lt;folder/&gt;]  [--windows-language en-US]
</code></pre>
<p>As an example, consider:</p>
<pre><code>sudo maas-image-builder -o windows-win2012hvr2-amd64-root-dd windows \
--windows-iso win2012hvr2.iso  --windows-edition win2012hvr2 \
--windows-updates --windows-drivers ~/Win2012hvr2_x64/DRIVERS/  --windows-language en-US
</code></pre>
<p>Please note that this will not <em>install</em> any Windows updates. In order to obtain an up-to-date image of Windows, be sure provide the <code>&ndash;windows-updates</code> flag. This requires access to a bridged connection with a DHCP server, an interface that can be specified with <code>-i</code>.</p>
<p>Also note that you may be required to have specific Windows drivers for this image to work in your hardware. Be sure you inject those drivers when installing them. Those drivers are the default <code>*.inf</code> files.</p>
<h4>Debug</h4>

<p>You can debug the Windows installation process by connecting to <code>localhost:5901</code> using a VNC client.</p>
<h4>Install into MAAS</h4>

<p>The generated images need to be placed into the correct directories so MAAS can deploy them onto a node:</p>
<pre><code>maas admin boot-resources create name=windows/win2012hvr2 \
architecture=amd64/generic filetype=ddtgz \ 
content@=./build-output/windows-win2012hvr2-amd64-root-dd
</code></pre>
<p>Now, using the MAAS WebUI, a node can be selected to use Windows Hyper-V 2012 R2. This selection gets reset when a node is stopped, so make sure to set it <em>before</em> starting nodes. You can also set the default operating system (and release) in the settings menu, which removes the need to set it per-node.</p>
<p><a name="doci"><h3>Dealing with other custom images</h3></a></p>
<p>To install other custom images, use the following command sequence:</p>
<pre><code>maas &lt;user&gt; boot-resources create name=&lt;custom-image-codename&gt; title="Ubuntu Custom Image" \
architecture=amd64/generic content@=/location/of/custom/image/ubuntu-custom-root-tgz
</code></pre>
<p>As an example:</p>
<pre><code>maas admin boot-resources create name=custom1 \
title=”Ubuntu Custom Image” architecture=amd64/generic \
content@=/home/ubuntu/ubuntu-custom-root-tgz
</code></pre>
    </div>
  </body>
</html>