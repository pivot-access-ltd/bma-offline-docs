<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/tips-tricks-and-traps.html">
	  &nbsp;UI-only&nbsp;
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;>"
	  CLI-only
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="give-me-an-example-of-maas.html">
	    &ldquo;Give me an example&rdquo;
	  </a>
	</li>
	<li>
	  <a href="whats-new-in-maas.html">
	    What&rsquo;s new in 2.7
	  </a>
	</li>
	<li>
	  <a href="maas-requirements.html">
	    Requirements
	  </a>
	</li>
	<li>
	  <a href="maas-installation.html">
	    Installation
	  </a>
	</li>
	<li>
	  <a href="configuration-journey.html">
	    Configuration journey
	  </a>
	</li>
      <strong>
	<a href="controllers.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-communication.html">
	    Communication
	  </a>
	</li>
	<li>
	  <a href="rack-controllers.html">
	    Rack controllers
	  </a>
	</li>
	<li>
	  <a href="region-controllers.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="high-availability.html">
	    High availability
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machines.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="add-machines.html">
	    Add machines
	  </a>
	</li>
	<li>
	  <a href="power-management.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commission-machines.html">
	    Commission machines
	  </a>
	</li>
	<li>Testing
	</li>
	<li>
	  <a href="hardware-testing.html">
	    Hardware testing
	  </a>
	</li>
	<li>
	  <a href="network-testing.html">
	    Network testing
	  </a>
	</li>
	<li>
	  <a href="commissioning-and-hardware-testing-scripts.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="maas-tags.html">
	    Tags
	  </a>
	</li>
	<li>
	  <a href="custom-machine-setup.html">
	    Custom machine setup
	  </a>
	</li>
	<li>
	  <a href="kernel-boot-options.html">
	    Kernel boot options
	  </a>
	</li>
	<li>
	  <a href="resource-pools.html">
	    Resource pools
	  </a>
	</li>
	<li>
	  <a href="storage.html">
	    Storage
	  </a>
	</li>
	<li>
	  <a href="vmware-vmfs-datastores.html">
	    VMware VMFS datastores
	  </a>
	</li>
	<li>
	  <a href="ubuntu-kernels.html">
	    Ubuntu kernels
	  </a>
	</li>
      </ul>
      <strong>
	<a href="images.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="select-and-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="local-image-mirror.html">
	    Local image mirror
	  </a>
	</li>
	<li>
	  <a href="vmware-images.html">
	    VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="networking.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="subnet-management.html">
	    Subnet management
	  </a>
	</li>
	<li>
	  <a href="managing-dhcp.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="ip-ranges.html">
	    IP ranges
	  </a>
	</li>
	<li>
	  <a href="proxy.html">
	    Proxy
	  </a>
	</li>
	<li>
	  <a href="ntp-services.html">
	    NTP
	  </a>
	</li>
	<li>
	  <a href="network-discovery.html">
	    Network discovery
	  </a>
	</li>
	<li>
	  <a href="ipv6-addressing.html">
	    IPv6
	  </a>
	</li>
	<li>
	  <a href="configuring-tls-encryption.html">
	    SSL
	  </a>
	</li>
	<li>
	  <a href="managing-stp.html">
	    STP
	  </a>
	</li>
	<li>
	  <a href="availability-zones.html">
	    Availability zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="vm-hosting.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="vm-host-networking.html">
	    VM host networking
	  </a>
	</li>
	<li>
	  <a href="adding-a-vm-host.html">
	    Add a VM host
	  </a>
	</li>
	<li>
	  <a href="vm-host-storage-pools.html">
	    VM host storage pools
	  </a>
	</li>
	<li>
	  <a href="creating-and-deleting-vms.html">
	    Creating and deleting VMs
	  </a>
	</li>
      </ul>
      <strong>Operations
      </strong>
      <ul>
	<li>
	  <a href="prometheus-metrics.html">
	    Prometheus metrics
	  </a>
	</li>
	<li>
	  <a href="backup.html">
	    Backup
	  </a>
	</li>
	<li>
	  <a href="hardening-your-maas-installation.html">
	    MAAS security
	  </a>
	</li>
	<li>
	  <a href="maas-logging.html">
	    Logging
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="user-accounts.html">
	    User accounts
	  </a>
	</li>
	<li>
	  <a href="interactive-search.html">
	    Interactive search
	  </a>
	</li>
      </ul>
      <strong>
	<a href="concepts-and-terms.html">
	  Concepts &amp; terms
	</a>
      </strong>
      <ul>
	<li>
	  <a href="concepts-and-terms.html#heading--network-tutorial">
	    Brief network tutorial
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-cli.html">
	  CLI
	</a>
      </strong>
      <ul>
	<li>
	  <a href="common-cli-tasks.html">
	    The CLI cookbook
	  </a>
	</li>
	<li>
	  <a href="common-cli-tasks.html">
	    Common tasks
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="cli-kernel-management.html">
	    Kernel management
	  </a>
	</li>
	<li>
	  <a href="cli-image-management.html">
	    Image management
	  </a>
	</li>
	<li>
	  <a href="cli-interface-management.html">
	    Interface management
	  </a>
	</li>
	<li>
	  <a href="cli-advanced-tasks.html">
	    Advanced tasks
	  </a>
	</li>
	<li>
	  <a href="cli-composable-hardware.html">
	    Composable hardware
	  </a>
	</li>
	<li>
	  <a href="python-api-client.html">
	    API client
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api.html">
	  API documentation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication.html">
	    API authentication
	  </a>
	</li>
      </ul>
      <strong>
	<a href="troubleshooting.html">
	  Troubleshoot
	</a>
      </strong>
      <ul>
	<li>
	  <a href="getting-help.html">
	    Getting help
	  </a>
	</li>
	<li>
	  <a href="tips-tricks-and-traps.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="https://old-docs.maas.io/2.5/en/">
	    MAAS 2.5 (+ earlier) doc
	  </a>
	</li>
      </ul>
      <strong>
	<a href="whats-new-in-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="writing-guide.html">
	  Help improve these docs
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>Tips tricks and traps</h1><p>This section contains a collection of tips, tricks, and traps which may help solve unusual or infrequent issues that come up.</p>
<h4>What would you like to do?</h4>
<ol>
<li><a href="tips-tricks-and-traps.html#heading--migrating-maas">Migrate an existing snap installation to use a local PostgreSQL server</a></li>
<li><a href="tips-tricks-and-traps.html#heading--manual-export">Manually export the MAAS database</a></li>
<li><a href="tips-tricks-and-traps.html#heading--ibm-power-server-pxe-boot">Network boot an IBM Power server</a></li>
<li><a href="tips-tricks-and-traps.html#heading--maas-lxd-network-conflicts">Eliminate MAAS and LXD DNS &amp; DHCP conflicts</a></li>
<li><a href="tips-tricks-and-traps.html#heading--jq-machine-list">Try jq recipes using the CLI</a></li>
</ol>
<h2 id="heading--migrating-maas">Migrating an existing snap installation</h2>

<p>If you&rsquo;re currently running MAAS from a snap in <code>all</code> mode, you can easily migrate your database to a local PostgreSQL server with the following command:</p>
<pre><code>sudo /snap/maas/current/helpers/migrate-snap-database
</code></pre>
<p>This will install PostgreSQL from the archive and migrate the MAAS database to it. </p>
<p><strong>Note</strong> that if PostgreSQL is already installed on the machine, the script will move the current datadir out of the way and replace it with the one from the snap, after  confirmation with the user. If you want to keep the current database set and just import the MAAS database, you&rsquo;ll need to perform a manual dump/restore of the MAAS database, explained below.</p>
<p>The migration script will automatically adjust the snap configuration to use the new database.  Note, though, that the target database must be at least the same version level as the one currently used in the snap (PostgreSQL 10).  Consequently, the migration script only supports Ubuntu 18.04 (bionic) or later.</p>
<h2 id="heading--manual-export">Manually exporting the MAAS database</h2>

<p>If you want to export the database from the snap to an already setup PostgreSQL server, possibly on a different machine, you can manually export it from MAAS as follows. With MAAS running (as this ensures access to the database), run:</p>
<pre><code>export PGPASS=$(sudo awk -F':\\s+' '$1 == "database_pass" {print $2}' \
    /var/snap/maas/current/regiond.conf)
sudo pg_dump -U maas -h /var/snap/maas/common/postgres/sockets \
    -d maasdb -F t -f maasdb-dump.tar
</code></pre>
<p>This will produce a binary dump in <code>maasdb-dump.tar</code>.  You can then stop the MAAS snap via</p>
<pre><code>sudo snap stop maas
</code></pre>
<p>Before importing it to the new database server, you need to create a user and database for MAAS:</p>
<pre><code class="nohighlight">sudo -u postgres \
    psql -c &quot;CREATE USER maas WITH ENCRYPTED PASSWORD '&lt;password&gt;'&quot;
sudo -u postgres createdb maasdb -O maas
</code></pre>

<p>Also, make sure that remote access is set up for the newly created <code>maas</code> user in <code>/etc/postgresql/10/main/pg_hba.conf</code>.  The file should contain a line similar to:</p>
<pre><code>host    maasdb  maas    0/0     md5
</code></pre>
<p>Be sure to replace <code>0/0</code>, above, with the proper CIDR to restrict access to a specific subnet.  Finally, you can import the database dump with:</p>
<pre><code>sudo -u postgres pg_restore -d maasdb maasdb-dump.tar
</code></pre>
<p>To finish the process, you&rsquo;ll need to update the MAAS snap config to:</p>
<ol>
<li>update the database config in <code>/var/snap/maas/current/regiond.conf</code> with the proper <code>database_host</code> and <code>database_pass</code></li>
<li>change the content of <code>/var/snap/maas/common/snap_mode</code> from <code>all</code> to <code>region+rack</code></li>
</ol>
<p>Using a local PostgreSQL server is a little bit of work, but it provides great benefits in terms of MAAS scalability and performance.</p>
<h2 id="heading--ibm-power-server-pxe-boot">Network booting IBM Power servers</h2>

<p>Some IBM Power server servers have OPAL firmware which uses an embedded Linux distribution as the boot environment. All the PXE interactions are handled by <strong>Petitboot</strong>, which runs in the userspace of this embedded Linux rather than a PXE ROM on the NIC itself.</p>
<p>When no specific interface is assigned as the network boot device, petitboot has a known issue which is detailed in <a href="https://bugs.launchpad.net/ubuntu-power-systems/+bug/1852678">LP#1852678</a>, specifically comment #24, that can cause issues when deploying systems using MAAS, since in this case all active NICs are used for PXE boot with the same address.</p>
<p>So, when using IBM Power servers with multiple NICs that can network boot, it&rsquo;s strongly recommended to configure just a single <specific> NIC as the network boot device via <strong>Petitboot</strong>.</p>
<h2 id="heading--maas-lxd-network-conflicts">Resolve DNS conflicts between LXD and MAAS</h2>

<p>If you get into a situation where MAAS and LXD are both managing DNS on your MAAS network, there&rsquo;s a simple fix.  You can turn off LXD&rsquo;s DNS management with the following command:</p>
<pre><code>lxc network set lxdbr0 dns.mode=none
</code></pre>

<h2 id="heading--jq-machine-list">jq recipes using the CLI</h2>

<p>Here are some <code>jq</code> recipes to get some human-readable output from the MAAS CLI.</p>
<h3 id="heading--jqml-sh">Basic machine list</h3>

<p>This recipe, which we keep in a file called <code>jqml.sh</code>, prints a basic machine list</p>
<pre><code>#!/bin/bash
maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS",
"OWNER", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner, .pool.name,
.boot_interface.vlan.name, .boot_interface.vlan.fabric,
.boot_interface.links[0].subnet.name]) | @tsv' | column -t
</code></pre>
<p>For this to work, you need to <strong>only</strong> break lines in the jq string (&lsquo;&hellip;&rsquo;) or add backslashes if you break outside that boundary.</p>
<h3 id="heading--jqmltag-sh">Machine list with first tag added</h3>

<p>It&rsquo;s a good idea to keep your most important machine tag first, as it&rsquo;s the first one you&rsquo;ll see.  It makes scanning your list (UI or CLI/jq) much more efficient.  Here&rsquo;s a recipe that adds the first tag to the console-printed machine list.  We keep it in <code>jqmltag.sh</code>, but of course, you can call it whatever you want.</p>
<pre><code> #!/bin/bash
 maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS",
 "OWNER", "TAGS", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))),
 (.[] | [.hostname, .system_id, .power_state, .status_name, .owner // "-", 
 .tag_names[0] // "-", .pool.name,
 .boot_interface.vlan.name, .boot_interface.vlan.fabric,
 .boot_interface.links[0].subnet.name]) | @tsv' | column -t
</code></pre>
    </div>
  </body>
</html>