<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <a href="../maas-vanilla/custom-machine-setup-824.html" style="border-top:1px solid black; border-left:1px solid black; border-right:1px solid black;">
	Full
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <strong>
	<a href="../maas-ui-only/custom-machine-setup-824.html" style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;UI-only&nbsp;
	</a>
      </strong>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../maas-cli-only/custom-machine-setup-824.html" style="border-top:1px solid black; border-left:1px solid black; border-right:1px solid black;">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas-840.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="give-me-an-example-of-maas-1314.html">
	    &ldquo;Give me an example&rdquo;
	  </a>
	</li>
	<li>
	  <a href="explore-maas-787.html">
	    Explore MAAS
	  </a>
	</li>
	<li>
	  <a href="whats-new-in-maas-2-8-1655.html">
	    What&rsquo;s new in 2.8
	  </a>
	</li>
	<li>
	  <a href="https://maas.io/install">
	    Quick start
	  </a>
	</li>
      </ul>
      <strong>Installing MAAS
      </strong>
      <ul>
	<li>
	  <a href="maas-requirements-789.html">
	    Requirements
	  </a>
	</li>
	<li>
	  <a href="maas-installation-from-a-snap-773.html">
	    Installation
	  </a>
	</li>
	<li>
	  <a href="configuration-journey-781.html">
	    Configuration journey
	  </a>
	</li>
	<li>
	  <a href="installation-and-configuration-checklist-750.html">
	    Setup checklist
	  </a>
	</li>
      </ul>
      <strong>
	<a href="introduction-to-controllers-786.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-communication-783.html">
	    Communication
	  </a>
	</li>
	<li>
	  <a href="rack-controllers-771.html">
	    Rack controllers
	  </a>
	</li>
	<li>
	  <a href="region-controllers-772.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="high-availability-804.html">
	    High availability
	  </a>
	</li>
      </ul>
      <strong>
	<a href="introduction-to-machines-829.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="add-machines-821.html">
	    Add machines
	  </a>
	</li>
	<li>
	  <a href="power-management-830.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commission-machines-822.html">
	    Commission machines
	  </a>
	</li>
	<li>Testing
	</li>
	<li>
	  <a href="hardware-testing-826.html">
	    Hardware testing
	  </a>
	</li>
	<li>
	  <a href="network-testing-1267.html">
	    Network testing
	  </a>
	</li>
	<li>
	  <a href="commissioning-and-hardware-testing-scripts-833.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="deploy-machines-825.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="maas-tags-834.html">
	    Tags
	  </a>
	</li>
	<li>
	  <a href="custom-machine-setup-824.html">
	    Custom machine setup
	  </a>
	</li>
	<li>
	  <a href="kernel-boot-options-827.html">
	    Kernel boot options
	  </a>
	</li>
	<li>
	  <a href="resource-pools-831.html">
	    Resource pools
	  </a>
	</li>
	<li>
	  <a href="storage-775.html">
	    Storage
	  </a>
	</li>
	<li>
	  <a href="vmware-vmfs-datastores-780.html">
	    VMware VMFS datastores
	  </a>
	</li>
	<li>
	  <a href="ubuntu-kernels-828.html">
	    Ubuntu kernels
	  </a>
	</li>
      </ul>
      <strong>
	<a href="images-754.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="select-and-import-images-751.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="local-image-mirror-752.html">
	    Local image mirror
	  </a>
	</li>
	<li>
	  <a href="vmware-images-753.html">
	    VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="networking-768.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="subnet-management-766.html">
	    Subnet management
	  </a>
	</li>
	<li>
	  <a href="managing-dhcp-759.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="ip-ranges-760.html">
	    IP ranges
	  </a>
	</li>
	<li>
	  <a href="proxy-763.html">
	    Proxy
	  </a>
	</li>
	<li>
	  <a href="ntp-services-762.html">
	    NTP
	  </a>
	</li>
	<li>
	  <a href="network-discovery-758.html">
	    Network discovery
	  </a>
	</li>
	<li>
	  <a href="ipv6-addressing-761.html">
	    IPv6
	  </a>
	</li>
	<li>
	  <a href="configuring-tls-encryption-764.html">
	    SSL
	  </a>
	</li>
	<li>
	  <a href="managing-stp-765.html">
	    STP
	  </a>
	</li>
	<li>
	  <a href="availability-zones-820.html">
	    Availability zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="introduction-to-vm-hosting-1524.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="vm-host-networking-1526.html">
	    VM host networking
	  </a>
	</li>
	<li>
	  <a href="adding-a-vm-host-1549.html">
	    Add a VM host
	  </a>
	</li>
	<li>
	  <a href="vm-host-storage-pools-1525.html">
	    VM host storage pools
	  </a>
	</li>
	<li>
	  <a href="creating-and-deleting-vms-806.html">
	    Creating and deleting VMs
	  </a>
	</li>
      </ul>
      <strong>Operations
      </strong>
      <ul>
	<li>
	  <a href="prometheus-metrics-813.html">
	    Prometheus metrics
	  </a>
	</li>
	<li>
	  <a href="backup-792.html">
	    Backup
	  </a>
	</li>
	<li>
	  <a href="hardening-your-maas-installation-1381.html">
	    MAAS security
	  </a>
	</li>
	<li>
	  <a href="maas-logging-1468.html">
	    Logging
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs-1478.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="user-accounts-790.html">
	    User accounts
	  </a>
	</li>
	<li>
	  <a href="interactive-search-819.html">
	    Interactive search
	  </a>
	</li>
      </ul>
      <strong>
	<a href="concepts-and-terms-785.html">
	  Concepts &amp; terms
	</a>
      </strong>
      <ul>
	<li>
	  <a href="concepts-and-terms-785.html#heading--network-tutorial">
	    Brief network tutorial
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-cli-802.html">
	  CLI
	</a>
      </strong>
      <ul>
	<li>
	  <a href="common-cli-tasks-794.html">
	    Common tasks
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs-791.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="cli-kernel-management-799.html">
	    Kernel management
	  </a>
	</li>
	<li>
	  <a href="cli-image-management-797.html">
	    Image management
	  </a>
	</li>
	<li>
	  <a href="cli-interface-management-798.html">
	    Interface management
	  </a>
	</li>
	<li>
	  <a href="cli-tag-management-801.html">
	    Tag management
	  </a>
	</li>
	<li>
	  <a href="cli-resource-pool-management-800.html">
	    Resource pool management
	  </a>
	</li>
	<li>
	  <a href="cli-dhcp-snippet-management-796.html">
	    DHCP snippet management
	  </a>
	</li>
	<li>
	  <a href="cli-commissioning-and-hardware-testing-scripts-832.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="cli-advanced-tasks-793.html">
	    Advanced tasks
	  </a>
	</li>
	<li>
	  <a href="cli-composable-hardware-795.html">
	    Composable hardware
	  </a>
	</li>
	<li>
	  <a href="python-api-client-810.html">
	    API client
	  </a>
	</li>
      </ul>
      <strong>
	<a href="https://maas.io/docs/api">
	  API documentation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-742.html">
	    API authentication
	  </a>
	</li>
      </ul>
      <strong>
	<a href="troubleshooting-837.html">
	  Troubleshoot
	</a>
      </strong>
      <ul>
	<li>
	  <a href="getting-help-838.html">
	    Getting help
	  </a>
	</li>
	<li>
	  <a href="tips-tricks-and-traps-1506.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="https://old-docs.maas.io/2.5/en/">
	    MAAS 2.5 (+ earlier) doc
	  </a>
	</li>
      </ul>
      <strong>
	<a href="whats-new-in-maas-2-8-1655.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="writing-guide-747.html">
	  Help improve these docs
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>Custom machine setup</h1><p>During machine <a href="add-machines-821.html#heading--enlistment">enlistment</a>, <a href="deploy-machines-825.html">deployment</a>, <a href="commission-machines-822.html">commissioning</a> and machine installation, MAAS sends <a href="https://raw.githubusercontent.com/ravenac95/tempita/master/docs/index.txt">Tempita-derived</a> configuration files to the <a href="https://launchpad.net/cloud-init">cloud-init</a> process running on the target machine. MAAS refers to this process as <strong>preseeding</strong>.These preseed files are used to configure a machine&rsquo;s ephemeral and installation environments and can be modified or augmented to a custom machine configuration.</p>
<h4>Quick questions you may have:</h4>
<ul>
<li><a href="custom-machine-setup-824.html#heading--curtin">How do I customize machine setup with curtin?</a></li>
<li><a href="custom-machine-setup-824.html#heading--cloud-init">How do I customize machine setup with cloud-init?</a></li>
</ul>
<p>Customisation in MAAS happens in two ways:</p>
<ol>
<li><a href="https://launchpad.net/curtin">Curtin</a>, a preseeding system similar to Kickstart or d-i (Debian Installer), applies customisations during operating system (OS) image installation. MAAS performs these changes on deployment, during OS installation, but before the machine reboots into the installed OS. Curtin customisations are perfect for administrators who want their deployments to have identical setups all the time, every time. <a href="https://blog.ubuntu.com/2017/06/02/customising-maas-installs">This blog post</a> contains an excellent high-level overview of custom MAAS installs using Curtin.</li>
<li><a href="https://launchpad.net/cloud-init">Cloud-init</a>, a system for setting up machines immediately after instantiation. Curtin applies customisations after the first boot, when MAAS changes a machine&rsquo;s status to &lsquo;Deployed.&rsquo; Customisations are per-instances, meaning that user-supplied scripts must be re-specified on redeployment. Cloud-init customisations are the best way for MAAS users to customise their deployments, similar to how the various cloud services prepare VMs when launching instances.</li>
</ol>
<h2 id="heading--curtin">Curtin</h2>

<h3 id="heading--templates">Templates</h3>

<p>The <a href="https://raw.githubusercontent.com/ravenac95/tempita/master/docs/index.txt">Tempita</a> template files are found within the <code>/var/snap/maas/current/preseeds/</code> for the snap and <code>/etc/maas/preseeds/</code> directory for the debian package on the region controller. Each template uses a filename prefix that corresponds to a particular phase of MAAS machine deployment:</p>
<table>
<thead>
<tr>
<th align="center">Phase</th>
<th align="center">Filename prefix</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">1. Enlistment</td>
<td align="center">enlist</td>
</tr>
<tr>
<td align="center">2. Commissioning</td>
<td align="center">commissioning</td>
</tr>
<tr>
<td align="center">3. Installation</td>
<td align="center">curtin (<a href="https://launchpad.net/curtin">Curtin</a>)</td>
</tr>
</tbody>
</table>
<p>Additionally, the template for each phase typically consists of two files. The first is a higher-level file that often contains little more than a URL or a link to further credentials, while a second file contains the executable logic.</p>
<p>The <code>enlist</code> template, for example, contains only minimal variables, whereas <code>enlist_userdata</code> includes both user variables and initialisation logic.</p>
<p>[note]
Tempita’s inheritance mechanism is the reverse of what you might expect. Inherited files, such as <code>enlist_userdata</code>, become the new template which can then reference variables from the higher-level file, such as <code>enlist</code>.
[/note]</p>
<h3 id="heading--template-naming">Template naming</h3>

<p>MAAS interprets templates in lexical order by their filename.  This order allows for base configuration options and parameters to be overridden based on a combination of operating system, architecture, sub-architecture, release, and machine name.</p>
<p>Some earlier versions of MAAS only support Ubuntu. If the machine operating system is Ubuntu, then filenames without <code>{os}</code> will also be tried, to maintain backward compatibility.</p>
<p>Consequently, template files are interpreted in the following order:</p>
<ol>
<li>
<p><code>{prefix}_{os}_{node_arch}_{node_subarch}_{release}_{node_name}</code> or <code>{prefix}_{node_arch}_{node_subarch}_{release}_{node_name}</code></p>
</li>
<li>
<p><code>{prefix}_{os}_{node_arch}_{node_subarch}_{release}</code> or <code>{prefix}_{node_arch}_{node_subarch}_{release}</code></p>
</li>
<li>
<p><code>{prefix}_{os}_{node_arch}_{node_subarch}</code> or <code>{prefix}_{node_arch}_{node_subarch}</code></p>
</li>
<li>
<p><code>{prefix}_{os}_{node_arch}</code> or <code>{prefix}_{node_arch}</code></p>
</li>
<li>
<p><code>{prefix}_{os}</code></p>
</li>
<li>
<p><code>{prefix}</code></p>
</li>
<li>
<p><code>generic</code></p>
</li>
</ol>
<p>The machine needs to be the machine name, as shown in the web UI URL.</p>
<p>The prefix can be either <code>enlist</code>, <code>enlist_userdata</code>, <code>commissioning</code>, <code>curtin</code>, <code>curtin_userdata</code> or <code>preseed_master</code>. Alternatively, you can omit the prefix and the following underscore.</p>
<p>For example, to create a generic configuration template for Ubuntu 16.04 Xenial running on an x64 architecture, the file would need to be called <code>ubuntu_amd64_generic_xenial_node</code>.</p>
<p>To create the equivalent template for curtin_userdata, the file would be called <code>curtin_userdata_ubuntu_amd64_generic_xenial_node</code>.</p>
<p>[note]
Any file targetting a specific machine will replace the values and configuration held within any generic files. If those values are needed, you will need to copy these generic template values into your new file.
[/note]</p>
<h3 id="heading--configuration">Configuration</h3>

<p>You can customise the Curtin installation by either editing the existing <code>curtin_userdata</code> template or by adding a custom file as described above.</p>
<p>Curtin provides hooks to execute custom code before and after installation takes place. These hooks are named <code>early</code> and <code>late</code> respectively, and they can both be overridden to execute the Curtin configuration in the ephemeral environment. Additionally, the <code>late</code> hook can be used to execute a configuration for a machine being installed, a state known as in-target.</p>
<p>Curtin commands look like this:</p>
<pre><code>foo: ["command", "--command-arg", "command-arg-value"]
</code></pre>
<p>Each component of the given command makes up an item in an array. Note, however, that the following won&rsquo;t work:</p>
<pre><code>foo: ["sh", "-c", "/bin/echo", "foobar"]
</code></pre>
<p>This syntax won&rsquo;t work because the value of <code>sh</code>&lsquo;s <code>-c</code> argument is itself an entire command. The correct way to express this is:</p>
<pre><code>foo: ["sh", "-c", "/bin/echo foobar"]
</code></pre>
<p>The following is an example of an early command that will run before the installation takes place in the ephemeral environment. The command pings an external machine to signal that the installation is about to start:</p>
<pre><code class="bash">early_commands:
  signal: [&quot;wget&quot;, &quot;--no-proxy&quot;, &quot;http://example.com/&quot;, &quot;--post-data&quot;, &quot;system_id=&amp;signal=starting_install&quot;, &quot;-O&quot;, &quot;/dev/null&quot;]
</code></pre>

<p>The following is an example of two late commands that run after installation is complete. Both run in-target, on the machine being installed.</p>
<p>The first command adds a PPA to the machine. The second command creates a file containing the machine’s system ID:</p>
<pre><code class="bash">late_commands:
  add_repo: [&quot;curtin&quot;, &quot;in-target&quot;, &quot;--&quot;, &quot;add-apt-repository&quot;, &quot;-y&quot;, &quot;ppa:my/ppa&quot;]
  custom: [&quot;curtin&quot;, &quot;in-target&quot;, &quot;--&quot;, &quot;sh&quot;, &quot;-c&quot;, &quot;/bin/echo -en 'Installed ' &gt; /tmp/maas_system_id&quot;]
</code></pre>

<h2 id="heading--cloud-init">Cloud-init</h2>

<p>Using cloud-init to customise a machine after deployment is relatively easy. If you&rsquo;re not familiar with the MAAS command-line interface (CLI), start by reviewing the <a href="maas-cli-802.html">MAAS CLI</a> page.</p>
<p>After you&rsquo;re logged in, use the following command to deploy a machine with a custom script you&rsquo;ve written:</p>
<pre><code>maas $PROFILE machine deploy $SYSTEM_ID user_data=&lt;base-64-encoded-script&gt;
</code></pre>
<ul>
<li><code>$PROFILE</code>: Your MAAS login. E.g. <code>admin</code></li>
<li><code>$SYSTEM_ID</code>: The machine&rsquo;s <a href="common-cli-tasks-794.html#heading--determine-a-node-system-id">system ID</a>.</li>
<li><code>&lt;base-64-encoded-script&gt;</code>: A base-64 encoded copy of your customisation script. See below for an example.</li>
</ul>
<p>E.g.:</p>
<p>Suppose you would like to import an SSH key immediately after your machine deployment. You might use this script, called <code>import_key.sh</code>:</p>
<pre><code class="bash">#!/bin/bash
(
echo === $date ===
ssh-import-id foobar_user
) | tee /ssh-key-import.log
</code></pre>

<p>This script echos the date in addition to the output of the <code>ssh-import-key</code> command. It also adds that output to a file, <code>/ssh-key-import.log</code>.</p>
<p>Base-64 encoding is required because the MAAS command-line interacts with the MAAS API, and base-64 encoding allows MAAS to send the script inside a POST HTTP command.</p>
<p>Use the <code>base64</code> command to output a base-64 encoded version of your script:</p>
<pre><code>base64 -w0 ./import_key.sh
</code></pre>
<p>Putting it together:</p>
<pre><code>maas $PROFILE machine deploy $SYSTEM_ID user_data=$(base64 -w0 ./import_key.sh)
</code></pre>
<p>After MAAS deploys the machine, you&rsquo;ll find <code>/ssh-key-import.log</code> on the machine you deployed.</p>
<!-- LINKS -->
    </div>
  </body>
</html>