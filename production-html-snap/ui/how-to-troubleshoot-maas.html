<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;
      <strong>Offline docs
      </strong>
      <a href="https://maas.io/docs">(switch to live docs)
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  UI-only
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-troubleshoot-maas.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong>
      <p>
      <strong>
	<a href="tutorials.html">
	  Tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="bootstrap-maas.html">
	    Bootstrap MAAS
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="create-a-custom-image.html">
	    Create a custom image
	  </a>
	</li>
	<li>
	  <a href="get-fancy-cli-output.html">
	    Get fancy CLI output
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-do-a-fresh-install-of-maas.html">
	    Do a fresh install of MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-availability-zones.html">
	    Use availability zones
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-images.html">
	  How to use images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-images.html">
	    Customise images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-a-real-time-kernel.html">
	    Deploy a RT kernel
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-controllers.html">
	  How to manage controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-configure-controllers.html">
	    Configure controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-machines.html">
	  How to manage machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-virtual-machines.html">
	  How to use virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-virtual-machines.html">
	    Manage virtual machines
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-devices.html">
	  How to label devices
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-secure-maas.html">
	  How to secure MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-hashicorp-vault-with-maas.html">
	    Use Vault with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-operate-maas.html">
	  How to operate MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
	<li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-monitor-maas.html">
	    Monitor MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-audit-maas.html">
	    Audit MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-give-and-receive-help.html">
	  How to give and receive help
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-our-discourse-forum.html">
	    Use our discourse forum
	  </a>
	</li>
	<li>
	  <a href="how-to-contact-us">
	    Get support↗
	  </a>
	</li>
	<li>
	  <a href="how-to-request-new-features.html">
	    Request new features
	  </a>
	</li>
	<li>
	  <a href="how-to-review-and-report-bugs.html">
	    Review and report bugs
	  </a>
	</li>
	<li>
	  <a href="how-to-contribute-doc.html">
	    Contribute documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="general-reference.html">
	  General reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-settings-reference.html">
	    MAAS settings
	  </a>
	</li>
	<li>
	  <a href="https://launchpad.net/maas.html">
	    MAAS source code↗
	  </a>
	</li>
	<li>
	  <a href="how-to-help-improve-the-doc.html">
	    Doc style guide
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
	<li>
	  <a href="https://ubuntu.com/community/code-of-conduct">
	    Code of conduct↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api-reference.html">
	  API reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    Python API client
	  </a>
	</li>
	<li>
	  <a href="api">
	    API documentation↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-scripts-reference.html">
	  Scripts reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-reference.html">
	    Terraform
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-logs-reference.html">
	  Log reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="event-logs-reference.html">
	    Event logs
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs-reference.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="testing-logs-reference.html">
	    Testing logs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machine-parameters-reference.html">
	  Machine parameters reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="power-drivers-reference.html">
	    Power drivers
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="device-labelling-reference.html">
	    Device labelling
	  </a>
	</li>
      </ul>
      <strong>
	<a href=".html">
	  Explanation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="about-networking.html">
	    About networking
	  </a>
	</li>
	<li>
	  <a href="about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="about-virtual-machines.html">
	    About virtual machines
	  </a>
	</li>
	<li>
	  <a href="about-device-labels.html">
	    About device labels
	  </a>
	</li>
	<li>
	  <a href="about-maas-events.html">
	    About MAAS events
	  </a>
	</li>
	<li>
	  <a href="about-maas-audit-events.html">
	    About audit events
	  </a>
	</li>
	<li>
	  <a href="about-maas-logging.html">
	    About MAAS logging
	  </a>
	</li>
	<li>
	  <a href="about-maas-security.html">
	    About MAAS security
	  </a>
	</li>
	<li>
	  <a href="about-maas-performance.html">
	    About MAAS performance
	  </a>
	</li>
	<li>
	  <a href="about-ansible.html">
	    About Ansible
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>How to troubleshoot MAAS</h1><!-- "How to troubleshoot MAAS" -->
<p>This article may help you deal with some common problems.  It is organised by topic:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--Find-and-fix-a-leaked-MAAS-admin-API-key">Find and fix a leaked MAAS admin API key</a></li>
<li><a href="#heading--networking-issues">Networking issues</a></li>
<li><a href="#heading--machine-life-cycle-failures">Machine life-cycle failures</a></li>
<li><a href="#heading--custom-image-creation-problems">Custom image creation problems</a></li>
</ul>
<p><a href="#heading--Find-and-fix-a-leaked-MAAS-admin-API-key"><h2 id="heading--Find-and-fix-a-leaked-MAAS-admin-API-key">Find and fix a leaked MAAS admin API key</h2></a></p>
<p>MAAS hardware sync may leak the MAAS admin API key.  The simple solution for this is to:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>Rotate all admin tokens</li>
<li>Re-deploy all machines that have hardware sync enabled</li>
</ul>
<p>For users who don’t want to re-deploy, the following instructions explain how to manually swap the token.</p>
<p><a href="#heading--Manually-swapping-the-MAAS-admin-API-token"><h3 id="heading--Manually-swapping-the-MAAS-admin-API-token">Manually swapping the MAAS admin API token</h3></a></p>
<p>Check if you have any machines with Hardware Sync enabled.  The easiest way to do this is a database query:</p>
<pre><code class="language-nohighlight">select system_id 
from maasserver_node 
where enable_hw_sync = true;
</code></pre>
<p>On each of the reported machines there might be a leaked API key that belongs to the user with admin permissions. This will show only machines that do exist now. It is possible that such machines existed before, but were removed. We still do recommend you to rotate API keys.</p>
<p>Here, on one of the machines, we have a leaked API key <code>PMmKvCw26reY7SaDet:g5rY7FNDu2ZDKER5zL:pNAHKcpR7eLWA6g2RSxrqdgSXEKgTAMT</code>:</p>
<pre><code class="language-nohighlight">cat /lib/systemd/system/maas_hardware_sync.service

[Unit]
Description=MAAS Hardware Sync Service
Documentation=&lt;https://maas.io&gt;
Wants=maas_hardware_sync.timer
After=network.target

[Service]
Type=oneshot
ExecStartPre=/usr/bin/wget -O /usr/bin/maas-run-scripts &lt;http://10.100.0.10:5248/MAAS/maas-run-scripts&gt;
ExecStartPre=/bin/chmod 0755 /usr/bin/maas-run-scripts
ExecStartPre=/usr/bin/maas-run-scripts get-machine-token\
    '&lt;http://10.100.0.10:5248/MAAS'\&gt;
    'PMmKvCw26reY7SaDet:g5rY7FNDu2ZDKER5zL:pNAHKcpR7eLWA6g2RSxrqdgSXEKgTAMT'\
    knt4rm\
    /tmp/maas-machine-creds.yml
ExecStart=/usr/bin/maas-run-scripts report-results --config /tmp/maas-machine-creds.yml

[Install]
WantedBy=multi-user.target
</code></pre>
<p>Just to ensure this token actually belongs to an admin account, we can do another database query:</p>
<pre><code class="language-nohighlight">select u.username, u.email 
from auth_user u
left join piston3_consumer c 
on u.id = c.user_id
-- we need only the consumer key of the token. token.split(&quot;:&quot;)[0]
where key = 'PMmKvCw26reY7SaDet';
</code></pre>
<p>You should login into MAAS UI with an account owning a leaked API key, find a leaked API key and remove it. This is the most convinient way; it guarantees that all steps will be audited and all caches will be reset.  After API key is removed, MAAS CLI will stop working (if you were using the same token), so you will need to go through setting up the CLI credentials again.</p>
<p>The hardware sync feature will stop working as well.  Here are two options:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>Redeploy the machine, so it will use the new systemd template </li>
<li>Manually create a credentials file and modify <code>/lib/systemd/system/maas_hardware_sync.service</code> to match</li>
</ul>
<p><a href="#heading--networking-issues"><h2 id="heading--networking-issues">Networking issues</h2></a></p>
<p>The following networking issues may be creating problems for you:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--overlapping-subnets-can-break-deployments">Adding overlapping subnets in fabric can break deployments</a></li>
<li><a href="#heading--need-to-reconfigure-server-ip-address">Need to reconfigure server IP address</a></li>
<li><a href="#heading--ibm-power-server-pxe-boot">Network boot an IBM Power server</a></li>
<li><a href="#heading--maas-lxd-network-conflicts">Resolve MAAS/LXD DNS &amp; DHCP conflicts/network issues</a></li>
</ul>
<p>Please feel free to add other issues and solutions, if you have them.</p>
<p><a href="#heading--overlapping-subnets-can-break-deployments"><h3 id="heading--overlapping-subnets-can-break-deployments">Adding overlapping subnets in fabric can break deployments</h3></a></p>
<p><strong>Characteristic failure</strong>: A machine performs PXE boot, then gets trapped in a boot loop, causing deployment to fail.</p>
<p>MAAS does not currently prevent you from creating overlapping subnets, for example:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>subnet 1 = 192.168.48.0/24</li>
<li>subnet 2 = 192.168.48.0/22</li>
</ul>
<p>This can break deployments, because the controllers can&rsquo;t reliably determine which subnet should get a packet destined for one of the overlapping addresses. The IP range of one subnet should be unique compared to every other subnet on the same segment.</p>
<p>At least one way to cause this error is to edit a subnet in the <code>netplan</code> file.  MAAS will add the updated subnet, but may not drop the existing subnet, causing overlap.  You can fix this by deleting the subnet you do not want from the Web UI.</p>
<p>If you have a machine that PXE boots, but then fails deployment, either in an infinite boot loop or some unspecified failure, check your subnets to be sure you do not have overlap.  If so, delete the outdated subnet.</p>
<p><a href="#heading--need-to-reconfigure-server-ip-address"><h3 id="heading--need-to-reconfigure-server-ip-address">Need to reconfigure server IP address</h3></a></p>
<p>If you made a mistake during setup or you just need to reconfigure your MAAS server, you can simply run the setup again:</p>
<pre><code class="language-bash">sudo dpkg-reconfigure maas-region-controller
</code></pre>
<p><a href="#heading--Network-booting-IBM-Power-servers"><h3 id="heading--Network-booting-IBM-Power-servers">Network booting IBM Power servers</h3></a></p>
<p>Some IBM Power server servers have OPAL firmware which uses an embedded Linux distribution as the boot environment. All the PXE interactions are handled by <strong>Petitboot</strong>, which runs in the user space of this embedded Linux rather than a PXE ROM on the NIC itself.</p>
<p>When no specific interface is assigned as the network boot device, petitboot has a known issue which is detailed in <a href="https://bugs.launchpad.net/ubuntu-power-systems/+bug/1852678">LP#1852678</a><code>↗</code>, specifically comment #24, that can cause issues when deploying systems using MAAS, since in this case all active NICs are used for PXE boot with the same address.</p>
<p>So, when using IBM Power servers with multiple NICs that can network boot, it&rsquo;s strongly recommended to configure just a single <specific> NIC as the network boot device via <strong>Petitboot</strong>.</p>
<p><a href="#heading--Resolve-DNS-conflicts-between-LXD-and-MAAS"><h3 id="heading--Resolve-DNS-conflicts-between-LXD-and-MAAS">Resolve DNS conflicts between LXD and MAAS</h3></a></p>
<p>If you get into a situation where MAAS and LXD are both managing DNS on your MAAS network, there&rsquo;s a simple fix. You can turn off LXD&rsquo;s DNS management with the following command:</p>
<pre><code class="language-bash">lxc network set $LXD_BRIDGE_NAME dns.mode=none
</code></pre>
<p>You should also disable DHCP on IPv4 and IPv6 withing LXD:</p>
<pre><code class="language-bash">lxc network set $LXD_BRIDGE_NAME ipv4.dncp=false
lxc network set $LXD_BRIDGE_NAME ipv6.dhcp=false
</code></pre>
<p>Once you&rsquo;ve done this, you can check your work with the following command:</p>
<pre><code class="language-bash">lxc network show $LXD_BRIDGE_NAME
</code></pre>
<p><a href="#heading--machine-life-cycle-failures"><h2 id="heading--machine-life-cycle-failures">Machine life-cycle failures</h2></a></p>
<p>When attempting to run a machine through its life-cycle, you may have encountered one of these issues:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--nodes-hang-on-commissioning">Nodes hang on &ldquo;Commissioning&rdquo;</a></li>
<li><a href="#heading--node-deployment-fails">Node deployment fails</a></li>
<li><a href="#heading--nodes-fail-to-pxe-boot">Nodes fail to PXE boot</a></li>
<li><a href="#heading--cant-log-in-to-node">Can&rsquo;t log in to node</a></li>
<li><a href="#heading--commissioning-script-file-not-found">"File not found" when creating commissioning or node script with MAAS CLI</a></li>
<li><a href="#heading--machine-login-issues">Can&rsquo;t login to machine after deployment</a></li>
</ul>
<p>Please feel free to add other issues and solutions, if you have them.</p>
<p><a href="#heading--nodes-hang-on-commissioning"><h3 id="heading--nodes-hang-on-commissioning">Nodes hang on &ldquo;Commissioning&rdquo;</h3></a></p>
<p><a href="#heading--possible-cause-timing-issues"><h4 id="heading--possible-cause-timing-issues">Possible Cause: Timing issues</h4></a></p>
<p>Various parts of MAAS rely on OAuth to negotiate a connection to nodes. If the current time reported by the hardware clock on your node differs significantly from that on the MAAS server, the connection will not be made.</p>
<p><strong>SOLUTION:</strong> Check that the hardware clocks are consistent, and if necessary, adjust them. This can usually be done from within the system BIOS, without needing to install an OS.</p>
<p><a href="#heading--possible-cause-network-drivers"><h4 id="heading--possible-cause-network-drivers">Possible Cause: Network drivers</h4></a></p>
<p>Sometimes the hardware can boot from PXE, but fail to load correct drivers when booting the received image. This is sometimes the case when no open source drivers are available for the network hardware.</p>
<p><strong>SOLUTION:</strong> The best fix for this problem is to install a Linux-friendly network adaptor. It <em>is</em> theoretically possible to modify the boot image to include proprietary drivers, but it is not a straightforward task.</p>
<p><a href="#heading--node-deployment-fails"><h3 id="heading--node-deployment-fails">Node deployment fails</h3></a></p>
<p>When deployment fails the <a href="maas-glossary.html#heading--rescue-mode">Rescue mode</a> action can be used to boot ephemerally into the node, followed by an investigation.</p>
<p>As an example, an improperly configured PPA was added to MAAS which caused nodes to fail deployment. After entering Rescue mode and connecting via SSH, the following was discovered in file <code>/var/log/cloud-init-output.log</code>:</p>
<pre><code class="language-no-highlight">2016-11-28 18:21:48,982 - cc_apt_configure.py[ERROR]: failed to add apt GPG Key
to apt keyring
Traceback (most recent call last):
  File &quot;/usr/lib/python3/dist-packages/cloudinit/config/cc_apt_configure.py&quot;,
line 540, in add_apt_key_raw
    util.subp(['apt-key', 'add', '-'], data=key.encode(), target=target)
  File &quot;/usr/lib/python3/dist-packages/cloudinit/util.py&quot;, line 1836, in subp
    cmd=args)
cloudinit.util.ProcessExecutionError: Unexpected error while running command.
Command: ['apt-key', 'add', '-']
Exit code: 2
Reason: -
Stdout: ''
Stderr: 'gpg: no valid OpenPGP data found.\n'
</code></pre>
<p>In this instance, the GPG fingerprint was used instead of the GPG key. After rectifying this oversight, nodes were again able to successfully deploy.</p>
<p><a href="#heading--nodes-fail-to-pxe-boot"><h3 id="heading--nodes-fail-to-pxe-boot">Nodes fail to PXE boot</h3></a></p>
<p><a href="#heading--possible-cause-using-an-incorrectly-configured-vm"><h4 id="heading--possible-cause-using-an-incorrectly-configured-vm">Possible Cause: Using an incorrectly</a> configured VM</h4></p>
<p>Some virtual machine setups include emulation of network hardware that does not support PXE booting, and in most setups, you will need to explicitly set the VM to boot via PXE.</p>
<p><strong>SOLUTION</strong>: Consult the VM docs for details on PXE booting.</p>
<p><a href="#heading--possible-cause-dhcp-conflict"><h4 id="heading--possible-cause-dhcp-conflict">Possible Cause: DHCP conflict</h4></a></p>
<p>If you are using MAAS in a setup with an existing DHCP, <em>DO NOT SET UP THE MAAS DHCP SERVER</em> as this will cause no end of confusion to the rest of your network and most likely won&rsquo;t discover any nodes either.</p>
<p><strong>SOLUTION</strong>: You will need to configure your existing DHCP server to point to the MAAS server.</p>
<p><a href="#heading--cant-log-in-to-node"><h3 id="heading--cant-log-in-to-node">Can&rsquo;t log in to node</h3></a></p>
<p>Sometimes you may wish to log in directly to a node on your system. If you have set up Juju and MAAS, the node will automatically have SSH authentication enabled (and public keys installed) allowing you to log in. There is also an option in the MAAS web interface to add new SSH keys to the nodes (via Preferences in the drop down menu which appears when clicking your username in the top-right of the page).</p>
<p><a href="#heading--commissioning-script-file-not-found"><h3 id="heading--commissioning-script-file-not-found">"File not found" when creating commissioning or node script with MAAS CLI</h3></a></p>
<p>When creating a commissioning script with the MAAS CLI, like this:</p>
<pre><code class="language-nohighlight">maas $PROFILE commissioning-scripts create name=scriptname content@=/tmp/filename
</code></pre>
<p>you may receive a &ldquo;file not found&rdquo; error:</p>
<pre><code class="language-nohighlight">[Errno 2] No such file or directory: '/tmp/filename'
</code></pre>
<p>There are two possible sources of the error:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>
<p>You did not actually type the filename correctly, or the file does not exist in <code>/tmp</code>.  Check the spelling and make sure the file is actually present in <code>/tmp</code> (for example).</p>
</li>
<li>
<p>You are using the snap version of MAAS.  When using the MAAS snap, you may not use <code>/tmp</code> due to confinement rules.  Move the file to <code>/opt</code> or <code>/home/myhomdir</code> and try again.</p>
</li>
</ul>
<p>In fact, trying to upload the script from any directory owned by <code>root</code> will give a similar error.</p>
<p>Also note that <code>commissioning-scripts</code> is deprecated and may be removed at some future time.  Use the form <code>node-scripts</code> instead; consult the MAAS CLI built-in help for details.</p>
<p><a href="#heading--machine-login-issues"><h3 id="heading--machine-login-issues">Can&rsquo;t login to machine after deployment</h3></a></p>
<p>When everything seems to be right about your machine deployment, but you can&rsquo;t login, there&rsquo;s a chance you might not be using the right username.  You may have added your personal SSH key to MAAS, but your corresponding login doesn&rsquo;t seem to work; that&rsquo;s because the logins for the machines are generally related to the operating system, e.g.:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>
<p>For machines deploying Ubuntu, the username is <code>ubuntu</code>, and the login would be <code>ubuntu@$MACHINE_IP</code>.</p>
</li>
<li>
<p>For machines deploying CentOS 7, the username is <code>centos</code>, and the login would be <code>centos@$MACHINE_IP</code>.</p>
</li>
<li>
<p>For machines deploying CentOS 8, the username is <code>cloud-user</code>, and the login would be <code>cloud-user@$MACHINE_IP</code>.</p>
</li>
</ul>
<p>Note there is a trick for determining the correct machine login, which works on many different versions of Linux.  If you attempt to <code>ssh root@$MACHINE_IP</code>, this will fail, but often tells you which user you should be using. </p>
<p><a href="#heading--custom-image-creation-problems"><h2 id="heading--custom-image-creation-problems">Custom image creation problems</h2></a></p>
<p>You may have experienced these errors when trying to create custom images for MAAS:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--packer-not-found">Command &lsquo;packer&rsquo; not found</a></li>
<li><a href="#heading--no-rule-for-ovmf">No rule to make target &hellip;OVMF_VARS.fd</a></li>
<li><a href="#heading--failed-creating-qemu-driver">Failure to create QEMU driver</a></li>
</ul>
<p>Please feel free to add other issues and solutions, if you have them.</p>
<p><a href="#heading--packer-not-found"><h3 id="heading--packer-not-found">Command &lsquo;packer&rsquo; not found</h3></a></p>
<p>You might attempt to run <code>packer</code> and receive the following error:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~$ packer
Command 'packer' not found, but can be installed with:
sudo snap install packer  # version 1.0.0-2, or
sudo apt  install packer  # version 1.6.6+ds1-4
See 'snap info packer' for additional versions.
</code></pre>
<p>More likely, you attempt a <code>make</code> and receive this error:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~/mnt/Dropbox/src/git/packer-maas/ubuntu$ make
sudo rm -f -rf output-qemu custom-ubuntu*.gz
cp -v /usr/share/OVMF/OVMF_VARS.fd OVMF_VARS.fd
'/usr/share/OVMF/OVMF_VARS.fd' -&gt; 'OVMF_VARS.fd'
sudo PACKER_LOG=1 packer build ubuntu-lvm.json &amp;&amp; reset
sudo: packer: command not found
make: *** [Makefile:21: custom-ubuntu-lvm.dd.gz] Error 1
rm OVMF_VARS.fd
</code></pre>
<p>In both cases, the problem is the same: <code>packer</code> has not been installed. You can fix it by <a href="https://maas.io/docs/how-to-customise-images#heading--how-to-install-packer">following these instructions</a><code>↗</code>.</p>
<p><a href="#heading--no-rule-for-ovmf"><h3 id="heading--no-rule-for-ovmf">No rule to make target &hellip;OVMF_VARS.fd</h3></a></p>
<p>If you encounter an error like this:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~/mnt/Dropbox/src/git/packer-maas/ubuntu$ make
sudo rm -f -rf output-qemu custom-ubuntu*.gz
make: *** No rule to make target '/usr/share/OVMF/OVMF_VARS.fd', needed by 'OVMF_VARS.fd'.  Stop.
</code></pre>
<p>then you have forgotten to <a href="https://maas.io/docs/how-to-customise-images#heading--how-to-install-packer">install a needed dependency</a><code>↗</code>.</p>
<p><a href="#heading--failed-creating-qemu-driver"><h3 id="heading--failed-creating-qemu-driver">Failure to create QEMU driver</h3></a></p>
<p>If you encounter an error such as this one:</p>
<pre><code class="language-nohighlight">2022/06/04 17:04:47 machine readable: error-count []string{&quot;1&quot;}
==&gt; Some builds didn't complete successfully and had errors:
2022/06/04 17:04:47 machine readable: qemu,error []string{&quot;Failed creating Qemu driver: exec: \&quot;qemu-img\&quot;: executable file not found in $PATH&quot;}
==&gt; Builds finished but no artefacts were created.
Build 'qemu' errored after 880 microseconds: Failed creating Qemu driver: exec: &quot;qemu-img&quot;: executable file not found in $PATH
</code></pre>
<p>then you have forgotten to <a href="https://maas.io/docs/how-to-customise-images#heading--how-to-install-packer">install a needed dependency</a><code>↗</code>.</p>
<p><a href="#heading--misc-problems"><h2 id="heading--misc-problems">Miscellaneous issues</h2></a></p>
<p>Finally, you may be facing an issue which doesn&rsquo;t fit into any category, such as one of these:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--django-subarch-error">Subarchitecture error thrown by django</a></li>
<li><a href="#heading--forgot-maas-administrator-password">Forgot MAAS administrator password</a></li>
<li><a href="#heading--cant-find-maas-web-ui">Can&rsquo;t find MAAS web UI</a></li>
<li><a href="#heading--backdoor-image-login">Backdoor image login</a></li>
<li><a href="#heading--migrating-maas">Migrate an existing snap installation to use a local PostgreSQL server</a></li>
<li><a href="#heading--manual-export">Manually export the MAAS database</a></li>
<li><a href="#heading--jq-machine-list">Try jq recipes using the CLI</a></li>
</ul>
<p>Please feel free to add other issues and solutions, if you have them.</p>
<p><a href="#heading--django-subarch-error"><h3 id="heading--django-subarch-error">Subarchitecture error thrown by django</h3></a></p>
<p>Occasionally, you may encounter an error similar to this one:</p>
<pre><code>django.core.exceptions.ValidationError: ['Subarchitecture(&lt;value&gt;) must be generic when setting hwe_kernel.']
</code></pre>
<p>One potential solution for this problem is to specify a different commissioning kernel, such as upgrading from Xenial to Focal, etc.  </p>
<p><a href="#heading--forgot-maas-administrator-password"><h3 id="heading--forgot-maas-administrator-password">Forgot MAAS administrator password</h3></a></p>
<p>As long as you have sudo privileges the <code>maas</code> command can be used to change the password for a MAAS administrator on the MAAS region controller:</p>
<pre><code class="language-bash">sudo maas changepassword $PROFILE
</code></pre>
<p>where $PROFILE is the name of the user.</p>
<p><a href="#heading--cant-find-maas-web-ui"><h3 id="heading--cant-find-maas-web-ui">Can&rsquo;t find MAAS web UI</h3></a></p>
<p>By default, the web UI is located at <code>http://&lt;hostname&gt;:5240/MAAS/</code>. If you can&rsquo;t access it, there are a few things to try:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>Check that the web server is running - By default the web interface uses Apache, which runs under the service name <em>apache2</em>. To check it, on the MAAS server box you can run <code>sudo /etc/init.d/apache2 status</code>.</li>
<li>Check that the hostname is correct - It may seem obvious, but check that the hostname is being resolved properly. Try running a browser (even a text mode one like <code>elinks</code>) on the same box as the MAAS server and navigating to the page. If that doesn&rsquo;t work, try <code>http://127.0.0.1:5240/MAAS/</code>, which will always point at the local server.</li>
<li>If you are still getting &ldquo;404 - Page not found&rdquo; errors, check that the MAAS web interface has been installed in the right place. There should be a file present called <code>/usr/share/maas/maas/urls.py</code>.</li>
</ul>
<p><a href="#heading--backdoor-image-login"><h3 id="heading--backdoor-image-login">Backdoor image login</h3></a></p>
<p>Ephemeral images are used by MAAS to boot nodes during commissioning, as well as during deployment. By design, these images are not built to be edited or tampered with, instead they&rsquo;re used to probe the hardware and launch <a href="https://launchpad.net/cloud-init">cloud-init</a><code>↗</code>.</p>
<p>However, if you find yourself with no other way to access a node, especially if a node fails during commissioning, Linux-based ephemeral images can be modified to enable a <em>backdoor</em> that adds or resets a user&rsquo;s password. You can then login to check the <strong>cloud-init</strong> logs, for example, and troubleshoot the problem.</p>
<p>As images are constantly updated and refreshed, the backdoor will only ever be temporary, but it should help you login to see what may be going wrong with your node.</p>
<p><a href="#heading--extract-the-cloud-image"><h4 id="heading--extract-the-cloud-image">Extract the cloud image</h4></a></p>
<p>First, download the cloud image that corresponds to the architecture of your node. The <em>Images</em> page of the web UI lists the images currently being cached by MAAS. Images can be downloaded from <a href="https://cloud-images.ubuntu.com/">https://cloud-images.ubuntu.com/</a><code>↗</code>.</p>
<p>For example:</p>
<pre><code class="language-bash">wget https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-root.tar.gz
</code></pre>
<p>With the image downloaded, extract its contents so that the <em>shadow</em> password file can be edited:</p>
<pre><code class="language-bash">mkdir xenial
sudo tar -C xenial -xpSf xenial-server-cloudimg-amd64-root.tar.gz --numeric-owner --xattrs &quot;--xattrs-include=*&quot;
</code></pre>
<p><strong>NOTE:</strong> 
<code>sudo</code> is required when extracting the image filesystem and when making changes to the files extracted from the image filesystem.</p>
<p><a href="#heading--generate-password-hash"><h4 id="heading--generate-password-hash">Generate password hash</h4></a></p>
<p>Now generate a hashed password. Use the following Python 3 command, replacing <strong>ubuntu</strong> with the password you wish to use:</p>
<pre><code class="language-bash">python3 -c 'import crypt; print(crypt.crypt(&quot;ubuntu&quot;, crypt.mksalt(crypt.METHOD_SHA512)))'
</code></pre>
<p>Output from the previous command looks like the following:</p>
<pre><code class="language-no-highlight">$6$AaHblHl5KGrWBmPV$20ssynyY0EhcT9AwZgA2sTdYt4Bvd97bX7PjeyqVLKun2Hk3NBa8r7efM2duK7pi2dlnd5tG76I0dTUvjb6hx0
</code></pre>
<p>Open the <code>xenial/etc/shadow</code> file extracted from the image with a text editor and insert the password hash into the <em>root</em> user line of <code>etc/shadow</code>, between the first and second colons:</p>
<pre><code class="language-no-highlight">root:$6$AaHblHl5KGrWBmPV$20ssynyY0EhcT9AwZgA2sTdYt4Bvd97bX7PjeyqVLKun2Hk3NBa8r7efM2duK7pi2dlnd5tG76I0dTUvjb6hx0:17445:0:99999:7:::
</code></pre>
<p>Save the file and exit the text editor.</p>
<p><a href="#heading--rebuild-squashfs-image"><h4 id="heading--rebuild-squashfs-image">Rebuild SquashFS image</h4></a></p>
<p>Recent versions of MAAS use SquashFS to hold the ephemeral image filesystem. The final step is to use the following command to create a SquashFS file called <code>xenial-customized.squashfs</code> that contains the modified shadow file:</p>
<pre><code class="language-bash">sudo mksquashfs xenial/ xenial-customized.squashfs -xattrs -comp xz
</code></pre>
<p>The output should look like the following:</p>
<pre><code class="language-no-highlight">Parallel mksquashfs: Using 2 processors
Creating 4.0 filesystem on xenial-customized.squashfs, block size 131072.
[=======]  2516/26975   9%
</code></pre>
<p>You now have an ephemeral image with a working root login that can replace an image locally cached by MAAS.</p>
<p><a href="#heading--use-the-custom-image"><h4 id="heading--use-the-custom-image">Use the custom image</h4></a></p>
<p>Images are synchronised by the region controller and stored on the rack controller in <code>/var/lib/maas/boot-resources/</code>, with the <em>current</em> directory linking to the latest synchronised images.</p>
<p>For example, the latest low-latency Ubuntu 16.04 image can be found in the following directory:</p>
<pre><code class="language-bash">cd /var/lib/maas/boot-resources/current/ubuntu/amd64/ga-16.04-lowlatency/xenial/stable
</code></pre>
<p>To replace the original, substitute the <em>squashfs</em> file with the custom image generated earlier, making sure the new owner is <em>maas</em>:</p>
<pre><code class="language-bash">mv squashfs squashfs_original
cp /home/ubuntu/xenial-customized.squashfs .
chown maas:maas squashfs
</code></pre>
<p>You can now use this image to commission or deploy a node and access the root account with the backdoor password, such as by deploying the same specific image from the web UI to the node you wish to troubleshoot.</p>
<p><a href="#heading--Migrating-an-existing-snap-installation"><h3 id="heading--Migrating-an-existing-snap-installation">Migrating an existing snap installation</h3></a></p>
<p>If you&rsquo;re currently running MAAS from a snap in <code>all</code> mode, you can easily migrate your database to a local PostgreSQL server with the following command:</p>
<pre><code>sudo /snap/maas/current/helpers/migrate-vd Snapatabase
</code></pre>
<p>This will install PostgreSQL from the archive and migrate the MAAS database to it. </p>
<p><strong>Note</strong> that if PostgreSQL is already installed on the machine, the script will move the current datadir out of the way and replace it with the one from the snap, after  confirmation with the user. If you want to keep the current database set and just import the MAAS database, you&rsquo;ll need to perform a manual dump/restore of the MAAS database, explained below.</p>
<p>The migration script will automatically adjust the snap configuration to use the new database.  Note, though, that the target database must be at least the same version level as the one currently used in the snap (PostgreSQL 10).  Consequently, the migration script only supports Ubuntu 18.04 (bionic) or later.</p>
<p><a href="#heading--Manually-exporting-the-MAAS-database"><h3 id="heading--Manually-exporting-the-MAAS-database">Manually exporting the MAAS database</h3></a></p>
<p>If you want to export the database from the snap to an already setup PostgreSQL server, possibly on a different machine, you can manually export it from MAAS as follows. With MAAS running (as this ensures access to the database), run:</p>
<pre><code>export PGPASS=$(sudo awk -F':\\s+' '$1 == "database_pass" {print $2}' \
    /var/snap/maas/current/regiond.conf)
sudo pg_dump -U maas -h /var/snap/maas/common/postgres/sockets \
    -d maasdb -F t -f maasdb-dump.tar
</code></pre>
<p>This will produce a binary dump in <code>maasdb-dump.tar</code>.  You can then stop the MAAS snap via</p>
<pre><code>sudo snap stop maas
</code></pre>
<p>Before importing it to the new database server, you need to create a user and database for MAAS:</p>
<pre><code class="language-nohighlight">sudo -u postgres \
    psql -c &quot;CREATE USER maas WITH ENCRYPTED PASSWORD '&lt;password&gt;'&quot;
sudo -u postgres createdb maasdb -O maas
</code></pre>
<p>Also, make sure that remote access is set up for the newly created <code>maas</code> user in <code>/etc/postgresql/10/main/pg_hba.conf</code>.  The file should contain a line similar to:</p>
<pre><code>host    maasdb  maas    0/0     md5
</code></pre>
<p>Be sure to replace <code>0/0</code>, above, with the proper CIDR to restrict access to a specific subnet.  Finally, you can import the database dump with:</p>
<pre><code>sudo -u postgres pg_restore -d maasdb maasdb-dump.tar
</code></pre>
<p>To finish the process, you&rsquo;ll need to update the MAAS snap config to:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>update the database config in <code>/var/snap/maas/current/regiond.conf</code> with the proper <code>database_host</code> and <code>database_pass</code></li>
<li>change the content of <code>/var/snap/maas/common/snap_mode</code> from <code>all</code> to <code>region+rack</code></li>
</ul>
<p>Using a local PostgreSQL server is a little bit of work, but it provides great benefits in terms of MAAS scalability and performance.</p>
<p><a href="#heading--jq-recipes-using-the-CLI"><h3 id="heading--jq-recipes-using-the-CLI">jq recipes using the CLI</h3></a></p>
<p>Here are some <code>jq</code> recipes to get some human-readable output from the MAAS CLI.</p>
<p><a href="#heading--Basic-machine-list"><h4 id="heading--Basic-machine-list">Basic machine list</h4></a></p>
<p>This recipe, which we keep in a file called <code>jqml.sh</code>, prints a basic machine list</p>
<pre><code>#!/bin/bash
maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS",
"OWNER", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner, .pool.name,
.boot_interface.vlan.name, .boot_interface.vlan.fabric,
.boot_interface.links[0].subnet.name]) | @tsv' | column -t
</code></pre>
<p>For this to work, you need to <strong>only</strong> break lines in the jq string (&lsquo;&hellip;&rsquo;) or add backslashes if you break outside that boundary.</p>
<p><a href="#heading--Machine-list-with-first-tag-added"><h4 id="heading--Machine-list-with-first-tag-added">Machine list with first tag added</h4></a></p>
<p>It&rsquo;s a good idea to keep your most important machine tag first, as it&rsquo;s the first one you&rsquo;ll see.  It makes scanning your list (UI or CLI/jq) much more efficient.  Here&rsquo;s a recipe that adds the first tag to the console-printed machine list.  We keep it in <code>jqmltag.sh</code>, but of course, you can call it whatever you want.</p>
<pre><code> #!/bin/bash
 maas admin machines read | jq -r '(["HOSTNAME","SYSID","POWER","STATUS",
 "OWNER", "TAGS", "POOL", "VLAN","FABRIC","SUBNET"] | (., map(length*"-"))),
 (.[] | [.hostname, .system_id, .power_state, .status_name, .owner // "-", 
 .tag_names[0] // "-", .pool.name,
 .boot_interface.vlan.name, .boot_interface.vlan.fabric,
 .boot_interface.links[0].subnet.name]) | @tsv' | column -t
</code></pre>
    </div>
  </body>
</html>