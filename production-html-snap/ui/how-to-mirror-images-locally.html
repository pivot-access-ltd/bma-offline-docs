<!DOCTYPE html>
    <html>
    <body>
    <div class="container">
    <h1>How to mirror images locally</h1><!-- "How to mirror images locally" -->
<p>Mirroring images is worthy of consideration.  The SimpleStreams protocol delivers Images to MAAS, which is especially useful when your Internet link is slow or unreliable. In this mirrored configuration, images will be instantly available when MAAS requests them.</p>
<p>Canonical provides two SimpleStreams for MAAS images: candidate and stable. Both streams contain Ubuntu images, CentOS images, bootloaders extracted from the Ubuntu archive, and release notifications. Either stream can be used in any version of MAAS greater than 2.1, but not all images are supported in older versions.</p>
<h4>This article will tell you:</h4>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--candidate-stream">About the candidate stream</a></li>
<li><a href="#heading--stable-stream">About the stable stream</a></li>
<li><a href="#heading--daily-stream">About the retired daily stream</a></li>
<li><a href="#heading--changing-the-stream">How to change the stream with the UI</a></li>
<li><a href="#heading--changing-stream-with-cli">How to change the stream with the CLI</a></li>
<li><a href="#heading--set-up-local-mirror">How to set up a local image mirror</a></li>
</ul>
<p><a href="#heading--candidate-stream"><h2 id="heading--candidate-stream">About the candidate stream</h2></a></p>
<p>The candidate stream contains images and bootloaders which have not been explicitly tested with MAAS. Canonical&rsquo;s automated build process dumps all images and bootloaders here before they are tested with MAAS. This stream is useful when testing a bug fix before an image or bootloader has been promoted to stable. Think of the candidate stream as a preview: it should never be used in a production environment; and users are encouraged to provide feedback on any issues they find with this stream.</p>
<p>This stream is available <a href="http://images.maas.io/ephemeral-v3/candidate">here</a>.</p>
<p><a href="#heading--stable-stream"><h2 id="heading--stable-stream">About the stable stream</h2></a></p>
<p>The stable stream contains images and bootloaders which have been tested with the latest version of MAAS. This is the default stream which should be used in production environments.  This stream is available <a href="http://images.maas.io/ephemeral-v3/stable">here</a>.</p>
<p><a href="#heading--daily-stream"><h2 id="heading--daily-stream">About the retired daily stream</h2></a></p>
<p>Previously there was only one MAAS stream available, daily. This stream has been replaced by the stable stream. Any client using this stream will be automatically redirected to the stable stream.</p>
<p><a href="#heading--changing-the-stream"><h2 id="heading--changing-the-stream">How to change the stream with the UI</h2></a></p>
<p>To switch to the candidate stream simply select &ldquo;custom&rdquo; on the images page, set the URL to <code>http://images.maas.io/ephemeral-v3/candidate</code>, and click &ldquo;Connect&rdquo;</p>
<p><a href="https://discourse.maas.io/uploads/default/original/1X/0588c8d2e5792edad3f53e90e38e9990a6d86d9a.jpeg" target = "_blank"><img src="https://discourse.maas.io/uploads/default/original/1X/0588c8d2e5792edad3f53e90e38e9990a6d86d9a.jpeg"></a></p>
<p>MAAS uses the stable stream by default. To switch back to it simply select <code>maas.io</code> on the images page</p>
<p><a href="https://discourse.maas.io/uploads/default/original/1X/5e20342f04e30f96ac0e29a5bd3117aa71dacd40.jpeg" target = "_blank"><img src="https://discourse.maas.io/uploads/default/original/1X/5e20342f04e30f96ac0e29a5bd3117aa71dacd40.jpeg"></a></p>
<p><a href="#heading--changing-stream-with-cli"><h2 id="heading--changing-stream-with-cli">How to change the stream with the CLI</h2></a></p>
<p>To switch to a stream with the CLI, enter the following commands:</p>
<pre><code>BOOT_SOURCE_ID=$(maas $PROFILE boot-sources read | jq '.[] | select(.url | contains(&quot;images.maas.io/ephemeral-v3&quot;)) | .id')
maas $PROFILE boot-source update $BOOT_SOURCE_ID url=$STREAM_URL
</code></pre>
<p><a href="#heading--set-up-local-mirror"><h2 id="heading--set-up-local-mirror">How to set up a local mirror</h2></a></p>
<p>To use mirroring, you begin by installing the necessary software on the host that will house the mirror:</p>
<pre><code class="language-bash">sudo apt install simplestreams
</code></pre>
<p>First define some variables to unclutter eventual CLI commands:</p>
<pre><code class="language-bash">KEYRING_FILE=/usr/share/keyrings/ubuntu-cloudimage-keyring.gpg
IMAGE_SRC=https://images.maas.io/ephemeral-v3/stable
IMAGE_DIR=/var/www/html/maas/images/ephemeral-v3/stable
</code></pre>
<p>The below example selects all available kernels that are compatible with either Ubuntu 18.04 (Bionic) and Ubuntu 20.04 (Focal) for the amd64 architecture, resulting in a download of approximately 3.1 GB. The second command mirrors the bootloaders.</p>
<pre><code class="language-bash">sudo sstream-mirror --keyring=$KEYRING_FILE $IMAGE_SRC $IMAGE_DIR \
    'arch=amd64' 'release~(bionic|focal)' --max=1 --progress
sudo sstream-mirror --keyring=$KEYRING_FILE $IMAGE_SRC $IMAGE_DIR \
    'os~(grub*|pxelinux)' --max=1 --progress
</code></pre>
<p>To know in advance what the <code>sstream-mirror</code> command will grab, or if you want to save bandwidth and time by avoiding bad selections, include the <code>--dry-run</code> option. When you are satisfied, remove that option to initiate the download.</p>
<p>MAAS will write the images to disk in the directory defined by the variable &lsquo;IMAGE_DIR&rsquo; above, and the &lsquo;location&rsquo; of the new boot source will be:</p>
<p><code>URL=http://&lt;myserver&gt;/maas/images/ephemeral-v3/stable/</code></p>
<p>Where <code>&lt;myserver&gt;</code> identifies your server&rsquo;s hostname or IP address.</p>
<p>Verify the availability of the images by visiting the above URL.</p>
<p>The final <code>sstream-mirror</code> command should be invoked at regular intervals (i.e. with <code>cron</code>) to ensure the mirror contains the latest images.</p>
    </div>
    </body>
    </html>
    