<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;
      <strong>Offline docs
      </strong>
      <a href="https://maas.io/docs">(switch to live docs)
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  UI-only
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-employ-vmware-images.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong>
      <p>
      <strong>
	<a href="tutorials.html">
	  Tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="bootstrap-maas.html">
	    Bootstrap MAAS
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="create-a-custom-image.html">
	    Create a custom image
	  </a>
	</li>
	<li>
	  <a href="get-fancy-cli-output.html">
	    Get fancy CLI output
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-do-a-fresh-install-of-maas.html">
	    Do a fresh install of MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-availability-zones.html">
	    Use availability zones
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-images.html">
	  How to use images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-images.html">
	    Customise images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-a-real-time-kernel.html">
	    Deploy a RT kernel
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-controllers.html">
	  How to manage controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-configure-controllers.html">
	    Configure controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-machines.html">
	  How to manage machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-virtual-machines.html">
	  How to use virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-virtual-machines.html">
	    Manage virtual machines
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-devices.html">
	  How to label devices
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-secure-maas.html">
	  How to secure MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-hashicorp-vault-with-maas.html">
	    Use Vault with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-operate-maas.html">
	  How to operate MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
	<li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-monitor-maas.html">
	    Monitor MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-audit-maas.html">
	    Audit MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-give-and-receive-help.html">
	  How to give and receive help
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-our-discourse-forum.html">
	    Use our discourse forum
	  </a>
	</li>
	<li>
	  <a href="how-to-contact-us">
	    Get support↗
	  </a>
	</li>
	<li>
	  <a href="how-to-request-new-features.html">
	    Request new features
	  </a>
	</li>
	<li>
	  <a href="how-to-review-and-report-bugs.html">
	    Review and report bugs
	  </a>
	</li>
	<li>
	  <a href="how-to-contribute-doc.html">
	    Contribute documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="general-reference.html">
	  General reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-settings-reference.html">
	    MAAS settings
	  </a>
	</li>
	<li>
	  <a href="https://launchpad.net/maas.html">
	    MAAS source code↗
	  </a>
	</li>
	<li>
	  <a href="how-to-help-improve-the-doc.html">
	    Doc style guide
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
	<li>
	  <a href="https://ubuntu.com/community/code-of-conduct">
	    Code of conduct↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api-reference.html">
	  API reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    Python API client
	  </a>
	</li>
	<li>
	  <a href="api">
	    API documentation↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-scripts-reference.html">
	  Scripts reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-reference.html">
	    Terraform
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-logs-reference.html">
	  Log reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="event-logs-reference.html">
	    Event logs
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs-reference.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="testing-logs-reference.html">
	    Testing logs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machine-parameters-reference.html">
	  Machine parameters reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="power-drivers-reference.html">
	    Power drivers
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="device-labelling-reference.html">
	    Device labelling
	  </a>
	</li>
      </ul>
      <strong>
	<a href=".html">
	  Explanation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="about-networking.html">
	    About networking
	  </a>
	</li>
	<li>
	  <a href="about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="about-virtual-machines.html">
	    About virtual machines
	  </a>
	</li>
	<li>
	  <a href="about-device-labels.html">
	    About device labels
	  </a>
	</li>
	<li>
	  <a href="about-maas-events.html">
	    About MAAS events
	  </a>
	</li>
	<li>
	  <a href="about-maas-audit-events.html">
	    About audit events
	  </a>
	</li>
	<li>
	  <a href="about-maas-logging.html">
	    About MAAS logging
	  </a>
	</li>
	<li>
	  <a href="about-maas-security.html">
	    About MAAS security
	  </a>
	</li>
	<li>
	  <a href="about-maas-performance.html">
	    About MAAS performance
	  </a>
	</li>
	<li>
	  <a href="about-ansible.html">
	    About Ansible
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>How to employ VMWare images</h1><!-- "How to employ VMWare images" -->
<p>MAAS 2.5 and above can deploy VMware ESXi as a custom image. MAAS cannot directly deploy the VMware ESXi ISO; you must create a specialised image from an official VMWare ISO. To automate the image creation process, Canonical <a href="https://github.com/canonical/packer-maas">hosts a repository</a><code>↗</code> with community-contributed <a href="https://www.packer.io/">packer</a><code>↗</code> templates.</p>
<p>This article will tell you:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--prerequisites-to-create-the-images">About the prerequisites for creating a VMWare image</a></li>
<li><a href="#heading--features-and-limitations">About the features and limitations of VMWare images in MAAS</a></li>
<li><a href="#heading--customising-the-image">How to customise VMWare images</a></li>
<li><a href="#heading--building-an-image">How to build a VMWare image</a></li>
<li><a href="#heading--uploading-an-image">How to upload a VMWare image</a></li>
</ul>
<p><strong>NOTE:</strong> 
VMware <a href="https://kb.vmware.com/s/article/84280">does not support cloning boot devices</a> - you may run into issues triggered by non-unique UUID.  <a href="https://kb.vmware.com/s/article/84349">One such issue</a><code>↗</code> may lead to data corruption on VMFS datastores when using cloned boot devices.</p>
<p><a href="#heading--prerequisites-to-create-the-images"><h2 id="heading--prerequisites-to-create-the-images">About the prerequisites for creating a VMWare image</h2></a></p>
<p>The following are required in order to create and deploy a VMWare image:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>MAAS 2.5.0+</li>
<li>A physical machine running Ubuntu 18.04+</li>
<li><strong>CPU</strong>: 4 2GHz cores</li>
<li><strong>Memory</strong>: 8 GB RAM (16 GB RAM recommended)</li>
<li><strong>Disk space</strong>: 11 GB</li>
<li><a href="https://my.vmware.com/en/web/vmware/evalcenter?p=free-esxi6">The VMWare ESXi ISO</a><code>↗</code></li>
<li><a href="https://www.packer.io/intro/getting-started/install.html">Packer - https://www.packer.io/intro/getting-started/install.html</a><code>↗</code></li>
<li>Procedure was tested with precompiled 64-bit Packer 1.3.4 Linux binaries</li>
<li><a href="https://github.com/canonical/packer-maas">Packer template</a> <code>↗</code> for MAAS custom image</li>
</ul>
<p><a href="#heading--features-and-limitations"><h2 id="heading--features-and-limitations">About the features and limitations of VMWare images in MAAS</h2></a></p>
<p><a href="#heading--no-cloning-support"><h3 id="heading--no-cloning-support">About cloning VMWare images</h3></a></p>
<p>VMware <a href="https://kb.vmware.com/s/article/84280">does not support cloning boot devices</a><code>↗</code> - you may run into issues triggered by non-unique UUID.  <a href="https://kb.vmware.com/s/article/84349">One such issue</a><code>↗</code> may lead to data corruption on VMFS datastores when using cloned boot devices.</p>
<p><a href="#heading--networking"><h3 id="heading--networking">About VMWare images and MAAS networking</h3></a></p>
<p>The following apply to VMWare image creation, with respect to MAAS networking:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>VMware ESXi does not support Linux bridges</li>
<li>Bonds - MAAS maps the following bond modes to VMware ESXi NIC team sharing with load balancing as follows:</li>
<li>balance-rr - portid</li>
<li>active-backup - explicit</li>
<li>802.3ad - iphash, LACP rate and XMIT hash policy settings are ignored.</li>
<li>No other bond modes are currently supported.</li>
<li>VMware ESXi does not allow VMs to use a PortGroup that has a VMK attached to it. All configured devices will have a VMK attached. To use a vSwitch with VMs, you must leave a device or alias unconfigured in MAAS.</li>
</ul>
<p><a href="#heading--storage"><h3 id="heading--storage">About VMWare images and MAAS storage</h3></a></p>
<p>Custom storage configuration is not supported because VMware ESXi expects specific disk formats. MAAS will extend datastore1 to the full size of the deployment disk. After deployment, VMware tools may be used to access the other disks.</p>
<p><a href="#heading--esxi-hardware-support"><h3 id="heading--esxi-hardware-support">About ESXi Hardware Support</h3></a></p>
<p>VMware has <a href="https://www.vmware.com/resources/compatibility/search.php">very specific hardware requirements</a><code>↗</code>. In particular, running VMware ESXi is not supported in a virtual machine or MAAS virsh Pod.</p>
<p><a href="#heading--customising-the-image"><h2 id="heading--customising-the-image">How to customise VMWare images</h2></a></p>
<p>The image may be customize by modifying packer-maas/vmware-esxi/http/vmware-esxi-ks.cfg see Installation and Upgrade Scripts in the <a href="https://docs.vmware.com/en/VMware-vSphere/6.7/vsphere-esxi-67-installation-setup-guide.pdf">VMware ESXi installation and Setup manual</a><code>↗</code> for more information.</p>
<p><a href="#heading--building-an-image"><h2 id="heading--building-an-image">How to build a VMWare image</h2></a></p>
<p>Before an image is built the nbd kernel module must be loaded</p>
<pre><code>sudo modprobe nbd
</code></pre>
<p>Once the nbd kernel module is loaded your current working directory must be in the packer-maas/vmware-esxi directory</p>
<pre><code>cd /path/to/packer-maas/vmware-esxi
</code></pre>
<p>You can now start the image building process using packer with the following command:</p>
<pre><code>sudo packer build -var
'vmware_esxi_iso_path=/path/to/VMware-VMvisor-Installer-6.7.0-8169922.x86_64.iso'
vmware-esxi.json
</code></pre>
<p><a href="#heading--uploading-an-image"><h2 id="heading--uploading-an-image">How to upload a VMWare image</h2></a></p>
<p>Once you have created the image, upload it to MAAS, using the CLI, with the following command:</p>
<pre><code>maas $PROFILE boot-resources create name='esxi/6.7' title='VMware ESXi 6.7'
architecture='amd64/generic' filetype='ddgz' content@=vmware-esxi.dd.gz
</code></pre>
    </div>
  </body>
</html>