<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;UI-only&nbsp;
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/create-a-custom-image.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Home
	</a>
      </strong>
      <p/>
      <strong>
	  Tutorials
      </strong>
      <ul>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="maas-cli-tutorial.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="using-jq-with-the-maas-cli.html">
	    Using jq with the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	  How to get MAAS running
      </strong>
      <ul>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshooting
	  </a>
	</li>
      </ul>
      <strong>
	  How to configure networking
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-addresses.html">
	    Manage IP addresses
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
      </ul>
      <strong>
	  How to choose images
      </strong>
      <ul>
	<li>
	  <a href="how-to-import-images.html">
	    Import images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-custom-images.html">
	    Create custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	  How to deploy MAAS
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-controllers.html">
	    Manage controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Commission and deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	  How to use tags
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-tags.html">
	    Work with tags
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-annotations.html">
	    Work with annotations
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	  How to operate MAAS
      </strong>
      <ul>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
	  <li>
	    <a href="how-to-set-up-maas-metrics.html">
	      Set up MAAS metrics
	    </a>
	  </li>
	  <li>
	    <a href="how-to-work-with-audit-event-logs.html">
	      Work with audit event logs
	    </a>
	  </li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade older versions
	  </a>
	</li>
      </ul>
      <strong>
	  Reference
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="audit-event-log-reference.html">
	    Audit event log reference
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API documentation
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
	<li>
	  <a href="how-to-get-help.html">
	    Getting help
	  </a>
	</li>
      </ul>
      <strong>
	  Explanations
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    MAAS
	  </a>
	</li>
	<li>
	  <a href="about-tcp-ip-networks.html">
	    TCP/IP networks
	  </a>
	</li>
	<li>
	  <a href="about-cloud-networks.html">
	    Cloud networks
	  </a>
	</li>
	<li>
	  <a href="about-dhcp.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="about-networking.html">
	    MAAS networking
	  </a>
	</li>
	<li>
	  <a href="about-images.html">
	    Images
	  </a>
	</li>
	<li>
	  <a href="about-creating-custom-images.html">
	    Custom images
	  </a>
	</li>
	<li>
	  <a href="about-controllers.html">
	    Controllers
	  </a>
	</li>
	<li>
	  <a href="about-machines.html">
	    Machines
	  </a>
	</li>
	<li>
	  <a href="about-customising-machines.html">
	    Customising machines
	  </a>
	</li>
	<li>
	  <a href="about-vm-hosting.html">
	    VM hosting
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>Create a custom image</h1><!-- "Create a custom image" -->
<p>When we talk about creating custom OS images for MAAS, it feels like something that&rsquo;s about to get really complex.  But with packer-maas, that&rsquo;s often not the case.</p>
<p>Let&rsquo;s see if we can&rsquo;t create and deploy a custom Ubuntu image with packer, just to see how easy it can be.</p>
<p><href id="#heading--install-maas"><h2 id="heading--install-maas">First, install MAAS</h2></a></p>
<p>If we&rsquo;re going to create custom images for MAAS, then first, we&rsquo;ll need MAAS!  You can use <a href="https://maas.io/docs/how-to-use-the-maas-cli">this tutorial</a> to accomplish that, and get a feel for MAAS while you&rsquo;re at it.</p>
<p><href id="#heading--install-packer"><h2 id="heading--install-packer">Install packer</h2></a></p>
<p>The next step is to install the tool <code>packer</code>, which will do the heavy lifting for us.  Packer is easily installed from its Debian package:</p>
<pre><code class="language-nohighlight">sudo apt install packer
</code></pre>
<p>This should install with no additional prompts.</p>
<p><href id="#heading--install-dependencies"><h2 id="heading--install-dependencies">Install dependencies</h2></a></p>
<p>We&rsquo;re going to create a &ldquo;custom&rdquo; Ubuntu image for this build, so we&rsquo;ll want to install a few dependencies.  Enter the following commands.  Don&rsquo;t worry about any output between commands:</p>
<pre><code class="language-nohighlight">sudo apt install qemu-utils
sudo apt install qemu-system
sudo apt install ovmf
sudo apt install cloud-image-utils
</code></pre>
<p><href id="#heading--get-the-packer-templates"><h2 id="heading--get-the-packer-templates">Get the packer templates</h2></a></p>
<p>Packer uses &ldquo;templates&rdquo;, which are very much like scripts that build your custom image.  You can obtain the packer templates by cloning the <a href="https://github.com/canonical/packer-maas.git">packer-maas github repository</a>, like this:</p>
<pre><code class="language-nohighlight">cd ~
mkdir -p tmp/git
cd tmp/git
git clone https://github.com/canonical/packer-maas.git
</code></pre>
<p>Make sure to pay attention to where the repository is cloned, in this case, <code>tmp/git</code> in your home directory.  The packer template in this cloned repository creates a Ubuntu AMD64 image for use with MAAS.</p>
<p><href id="#heading--build-an-image"><h2 id="heading--build-an-image">Build an Ubuntu image</h2></a></p>
<p>Now that we have that, let&rsquo;s build a custom Ubuntu image that we can deploy with MAAS.  Use these commands to do that:</p>
<pre><code class="language-nohighlight">cd ~/tmp/git/packer-maas/ubuntu
make custom-ubuntu-lvm.dd.gz
</code></pre>
<p>This <code>make</code> will run for a couple of minutes before attempting to boot the image.  While waiting for the image to boot, you will see terminal messages similar to this one for upwards of three to five minutes:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:46 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] SSH handshake err: ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] Detected authentication error. Increasing handshake attempts.
</code></pre>
<p>That&rsquo;s expected.  Eventually, you should see a successful SSH connection:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:57 packer-builder-qemu plugin: [INFO] Attempting SSH connection to 127.0.0.1:2351...
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] reconnecting to TCP connection for SSH
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:51:17 packer-builder-qemu plugin: [DEBUG] handshake complete!
</code></pre>
<p>After this, a few more commands will run.  Eventually the terminal screen will clear and show just one line, as follows:</p>
<pre><code class="language-nohighlight">rm OVMF_VARS.fd
</code></pre>
<p>That means you&rsquo;ve successfully built the image!  Just to prove it to ourselves, let&rsquo;s take a couple of additional steps.</p>
<p><href id="#heading--validate-the-build"><h2 id="heading--validate-the-build">Validate the build</h2></a></p>
<p>You can check the validity of the operation with a simple <code>ls</code> command in <code>~/tmp/git/packer-maas/ubuntu</code> (where you ran the <code>make</code> command), like this:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~/mnt/Dropbox/src/git/packer-maas/ubuntu$ ls
custom-ubuntu-lvm.dd.gz  packages      seeds-lvm.iso     user-data-lvm
http                     packer_cache  ubuntu-flat.json
Makefile                 README.md     ubuntu-lvm.json
meta-data                scripts       user-data-flat
</code></pre>
<p>See the <code>custom-ubuntu-lvm.dd.gz</code> file?  That&rsquo;s our image, ready to try out.</p>
<p><href id="#heading--upload-to-maas"><h2 id="heading--upload-to-maas">Upload the image to MAAS</h2></a></p>
<p>You can upload your newly-created image with the following command:</p>
<pre><code class="language-nohighlight">$ maas admin boot-resources create \
    name='custom/ubuntu-raw' \
    title='Ubuntu Custom RAW' \
    architecture='amd64/generic' \
    filetype='ddgz' \
    content@=custom-ubuntu-lvm.dd.gz
</code></pre>
<p><href id="#heading--deploy-your-image"><h2 id="heading--deploy-your-image">Deploy the image in MAAS</h2></a></p>
<p>What good is an image if we can&rsquo;t deploy it?  Pick one of the VMs you created in the <a href="https://maas.io/docs/how-to-use-the-maas-cli">last tutorial</a> and deploy your new OS image to it.  Then use a command like this one to see it running:</p>
<pre><code class="language-nohighlight">maas admin machines read | jq -r '([&quot;HOSTNAME&quot;,&quot;SYSID&quot;,&quot;POWER&quot;,&quot;STATUS&quot;,
&quot;OWNER&quot;, &quot;OS&quot;, &quot;DISTRO&quot;] | (., map(length*&quot;-&quot;))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner // &quot;-&quot;,
.osystem, .distro_series]) | @tsv' | column -t

HOSTNAME     SYSID   POWER  STATUS    OWNER  OS      DISTRO
--------     -----   -----  ------    -----  --      ------
valued-moth  e86c7h  on     Deployed  admin  ubuntu  focal
open-gannet  nk7x8y  on     Deployed  admin  custom  ubuntu-raw
</code></pre>
<p>It&rsquo;s the machine named <code>open-gannet</code> in the listing above, but your machine name and $SYSID will be unique to your instance.</p>
<p><href id="#heading--thats-all-there-is-to-it"><h2 id="heading--thats-all-there-is-to-it">That&rsquo;s all there is to it!</h2></a></p>
<p>In a few simple steps, you&rsquo;ve used packer to create a custom Ubuntu image, upload it to a running MAAS, and deploy it.  There are many different custom images that can be deployed with MAAS &ndash; check <a href="https://maas.io/docs/how-to-create-custom-images">this guide</a> to learn more.</p>
    </div>
  </body>
</html>