<!DOCTYPE html>
    <html>
    <body>
    <div class="container">
    <h1>How to set up LXD</h1><!-- "How to set up LXD" -->
<p>LXD and MAAS are separate products, and it&rsquo;s useful to allow them to interact as equals, covering a much wider range of use cases.  To allow each of them to follow their own operational models, but still allow them to work together, we&rsquo;ve taken advantage of LXD projects.</p>
<p><a href="#heading--lxd-setup"><h2 id="heading--lxd-setup">How to make LXD available for VM hosting</h2></a></p>
<p>Assuming that you want to use LXD VM hosts, you need to install the correct version of LXD. Prior to the release of Ubuntu 20.04 LXD was installed using Debian packages. The Debian packaged version of LXD is too old to use with MAAS. If this is the case, you’ll need to remove the LXD Debian packages and install the Snap version.  Note that you cannot install both Debian and snap versions, as this creates a conflict.</p>
<p><a href="#heading--reinstalling-lxd"><h3 id="heading--reinstalling-lxd">How to remove older versions of LXD</h3></a></p>
<p>If you&rsquo;re on a version of Ubuntu older than 20.04, or you have the Debian version of LXD, start the uninstall process with the following command:</p>
<pre><code class="language-nohighlight">sudo apt-get purge -y *lxd* *lxc*
</code></pre>
<p>This command should result in output that looks something like this:</p>
<pre><code class="language-nohighlight">Reading package lists... Done
Building dependency tree      
Reading state information... Done
Note, selecting 'lxde-core' for glob '*lxd*'
Note, selecting 'python-pylxd-doc' for glob '*lxd*'
Note, selecting 'python3-pylxd' for glob '*lxd*'
Note, selecting 'python-nova-lxd' for glob '*lxd*'
Note, selecting 'lxde-common' for glob '*lxd*'
Note, selecting 'lxde-icon-theme' for glob '*lxd*'
Note, selecting 'lxde-settings-daemon' for glob '*lxd*'
Note, selecting 'lxde' for glob '*lxd*'
Note, selecting 'lxdm' for glob '*lxd*'
Note, selecting 'lxd' for glob '*lxd*'
Note, selecting 'lxd-tools' for glob '*lxd*'
Note, selecting 'python-pylxd' for glob '*lxd*'
Note, selecting 'lxdm-dbg' for glob '*lxd*'
Note, selecting 'lxde-session' for glob '*lxd*'
Note, selecting 'nova-compute-lxd' for glob '*lxd*'
Note, selecting 'openbox-lxde-session' for glob '*lxd*'
Note, selecting 'python-nova.lxd' for glob '*lxd*'
Note, selecting 'lxd-client' for glob '*lxd*'
Note, selecting 'openbox-lxde-session' instead of 'lxde-session'
Note, selecting 'lxctl' for glob '*lxc*'
Note, selecting 'lxc-common' for glob '*lxc*'
Note, selecting 'python3-lxc' for glob '*lxc*'
Note, selecting 'libclxclient-dev' for glob '*lxc*'
Note, selecting 'lxc-templates' for glob '*lxc*'
Note, selecting 'lxc1' for glob '*lxc*'
Note, selecting 'lxc-dev' for glob '*lxc*'
Note, selecting 'lxc' for glob '*lxc*'
Note, selecting 'liblxc1' for glob '*lxc*'
Note, selecting 'lxc-utils' for glob '*lxc*'
Note, selecting 'vagrant-lxc' for glob '*lxc*'
Note, selecting 'libclxclient3' for glob '*lxc*'
Note, selecting 'liblxc-dev' for glob '*lxc*'
Note, selecting 'nova-compute-lxc' for glob '*lxc*'
Note, selecting 'python-lxc' for glob '*lxc*'
Note, selecting 'liblxc-common' for glob '*lxc*'
Note, selecting 'golang-gopkg-lxc-go-lxc.v2-dev' for glob '*lxc*'
Note, selecting 'lxcfs' for glob '*lxc*'
Note, selecting 'liblxc-common' instead of 'lxc-common'
Package 'golang-gopkg-lxc-go-lxc.v2-dev' is not installed, so not removed
Package 'libclxclient-dev' is not installed, so not removed
Package 'libclxclient3' is not installed, so not removed
Package 'lxc-templates' is not installed, so not removed
Package 'lxctl' is not installed, so not removed
Package 'lxde' is not installed, so not removed
Package 'lxde-common' is not installed, so not removed
Package 'lxde-core' is not installed, so not removed
Package 'lxde-icon-theme' is not installed, so not removed
Package 'lxde-settings-daemon' is not installed, so not removed
Package 'lxdm' is not installed, so not removed
Package 'lxdm-dbg' is not installed, so not removed
Package 'openbox-lxde-session' is not installed, so not removed
Package 'python-lxc' is not installed, so not removed
Package 'python3-lxc' is not installed, so not removed
Package 'vagrant-lxc' is not installed, so not removed
Package 'liblxc-dev' is not installed, so not removed
Package 'lxc-dev' is not installed, so not removed
Package 'nova-compute-lxc' is not installed, so not removed
Package 'nova-compute-lxd' is not installed, so not removed
Package 'python-nova-lxd' is not installed, so not removed
Package 'python-pylxd' is not installed, so not removed
Package 'python-pylxd-doc' is not installed, so not removed
Package 'lxc' is not installed, so not removed
Package 'lxc-utils' is not installed, so not removed
Package 'lxc1' is not installed, so not removed
Package 'lxd-tools' is not installed, so not removed
Package 'python-nova.lxd' is not installed, so not removed
Package 'python3-pylxd' is not installed, so not removed
The following packages were automatically installed and are no longer required:
  dns-root-data dnsmasq-base ebtables libuv1 uidmap xdelta3
Use 'sudo apt autoremove' to remove them.
The following packages will be REMOVED:
  liblxc-common* liblxc1* lxcfs* lxd* lxd-client*
0 upgraded, 0 newly installed, 5 to remove and 21 not upgraded.
After this operation, 34.1 MB disk space will be freed.
(Reading database ... 67032 files and directories currently installed.)
Removing lxd (3.0.3-0ubuntu1~18.04.1) ...
Removing lxd dnsmasq configuration
Removing lxcfs (3.0.3-0ubuntu1~18.04.2) ...
Removing lxd-client (3.0.3-0ubuntu1~18.04.1) ...
Removing liblxc-common (3.0.3-0ubuntu1~18.04.1) ...
Removing liblxc1 (3.0.3-0ubuntu1~18.04.1) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for libc-bin (2.27-3ubuntu1) ...
(Reading database ... 66786 files and directories currently installed.)
Purging configuration files for liblxc-common (3.0.3-0ubuntu1~18.04.1) ...
Purging configuration files for lxd (3.0.3-0ubuntu1~18.04.1) ...
Purging configuration files for lxcfs (3.0.3-0ubuntu1~18.04.2) ...
Processing triggers for systemd (237-3ubuntu10.40) ...
Processing triggers for ureadahead (0.100.0-21) ...
</code></pre>
<p>You should also autoremove packages no longer needed by LXD:</p>
<pre><code class="language-nohighlight">$ sudo apt-get autoremove -y
</code></pre>
<p>Output from this command should be similar to:</p>
<pre><code class="language-nohighlight">Reading package lists... Done
Building dependency tree      
Reading state information... Done
The following packages will be REMOVED:
  dns-root-data dnsmasq-base ebtables libuv1 uidmap xdelta3
0 upgraded, 0 newly installed, 6 to remove and 21 not upgraded.
After this operation, 1860 kB disk space will be freed.
(Reading database ... 66769 files and directories currently installed.)
Removing dns-root-data (2018013001) ...
Removing dnsmasq-base (2.79-1) ...
Removing ebtables (2.0.10.4-3.5ubuntu2.18.04.3) ...
Removing libuv1:amd64 (1.18.0-3) ...
Removing uidmap (1:4.5-1ubuntu2) ...
Removing xdelta3 (3.0.11-dfsg-1ubuntu1) ...
Processing triggers for man-db (2.8.3-2ubuntu0.1) ...
Processing triggers for libc-bin (2.27-3ubuntu1) ...
</code></pre>
<p>Now install LXD from the Snap:</p>
<pre><code class="language-nohighlight">$ sudo snap install lxd
2020-05-20T22:02:57Z INFO Waiting for restart...
lxd 4.1 from Canonical✓ installed
</code></pre>
<p><a href="#heading--newer-lxd"><h3 id="heading--newer-lxd">R\How to refresh LXD on 20.04</h3></a></p>
<p>If you are on 20.04 or above LXD should be installed by default, but it&rsquo;s a good idea to make sure it&rsquo;s up to date:</p>
<pre><code class="language-nohighlight">$ sudo snap refresh
All snaps up to date.
</code></pre>
<p><a href="#heading--lxd-init"><h3 id="heading--lxd-init">How to initialise LXD prior to use</h3></a></p>
<p>Once LXD is installed it needs to be configured with <code>lxd init</code> before first use:</p>
<pre><code class="language-nohighlight">$ sudo lxd init
</code></pre>
<p>Your interactive output should look something like the following. Note a few points important points about these questions:</p>
<ol>
<li>
<p><code>Would you like to use LXD clustering? (yes/no) [default=no]: no</code> - support for LXD clusters was added in MAAS v3.1.</p>
</li>
<li>
<p><code>Name of the storage back-end to use (btrfs, dir, lvm, zfs, ceph) [default=zfs]: dir</code> - testing has primarily been with dir; other options should work, but less testing has been done, so use at your own risk.</p>
</li>
<li>
<p><code>Would you like to connect to a MAAS server? (yes/no) [default=no]: no</code> - When LXD is connected to MAAS containers or virtual machines created by LXD will be automatically added to MAAS as devices.  This feature should work, but has limited testing thus far.</p>
</li>
<li>
<p><code>Would you like to configure LXD to use an existing bridge or host interface? (yes/no) [default=no]: yes</code> - The bridge LXD creates is isolated and not managed by MAAS. If this bridge is used, you would be able to add the LXD VM host and compose virtual machines, but commissioning, deploying, and any other MAAS action which uses the network will fail &ndash; so <code>yes</code> is the correct answer here.</p>
</li>
<li>
<p><code>Name of the existing bridge or host interface: br0</code> - br0 is the name of the bridge the user configured (see sections above) which is connected to a MAAS-managed network.</p>
</li>
<li>
<p><code>Trust password for new clients:</code> - This is the password the user will enter when connecting with MAAS.</p>
</li>
</ol>
<pre><code class="language-nohighlight">Would you like to use LXD clustering? (yes/no) [default=no]: no
Do you want to configure a new storage pool? (yes/no) [default=yes]: yes
Name of the new storage pool [default=default]:  
Name of the storage back-end to use (btrfs, dir, lvm, zfs, ceph) [default=zfs]: dir
Would you like to connect to a MAAS server? (yes/no) [default=no]: no
Would you like to create a new local network bridge? (yes/no) [default=yes]: no
Would you like to configure LXD to use an existing bridge or host interface? (yes/no) [default=no]: yes
Name of the existing bridge or host interface: br0
Would you like LXD to be available over the network? (yes/no) [default=no]: yes
Address to bind LXD to (not including port) [default=all]:
Port to bind LXD to [default=8443]:
Trust password for new clients:
Again:
Would you like stale cached images to be updated automatically? (yes/no) [default=yes]
Would you like a YAML &quot;lxd init&quot; preseed to be printed? (yes/no) [default=no]:
</code></pre>
<p>After initialising LXD, you will also want to make sure that LXD is not trying to provide DHCP for the new local network bridge.  You can check this with the following command:</p>
<pre><code class="language-nohighlight">lxc network show lxdbr0
</code></pre>
<p>If you didn&rsquo;t accept the default bridge name (lxdbr0), substitute your name for that new bridge in the command above. This will produce output something like this:</p>
<pre><code class="language-nohighlight">config:
  dns.mode: managed
  ipv4.address: 10.146.214.1/24
  ipv4.dhcp: &quot;true&quot;
  ipv4.nat: &quot;true&quot;
  ipv6.address: fd42:c560:ee59:bb2::1/64
  ipv6.dhcp: &quot;true&quot;
  ipv6.nat: &quot;true&quot;
description: &quot;&quot;
name: lxdbr0
type: bridge
used_by:
- /1.0/profiles/default
managed: true
status: Created
locations:
- none
</code></pre>
<p>There is a <a href="https://github.com/lxc/lxd/blob/master/doc/networks.md">quick tutorial</a> on the possible settings here.  For simplicity, to turn off LXD-provided DHCP, you need to change three settings, as follows:</p>
<pre><code class="language-nohighlight">lxc network set lxdbr0 dns.mode=none
lxc network set lxdbr0 ipv4.dhcp=false
lxc network set lxdbr0 ipv6.dhcp=false
</code></pre>
<p>You can check your work by repeating the <code>show</code> command:</p>
<pre><code class="language-nohighlight">$ lxc network show lxdbr0
config:
  dns.mode: none
  ipv4.address: 10.146.214.1/24
  ipv4.dhcp: &quot;false&quot;
  ipv4.nat: &quot;true&quot;
  ipv6.address: fd42:c560:ee59:bb2::1/64
  ipv6.dhcp: &quot;false&quot;
  ipv6.nat: &quot;true&quot;
description: &quot;&quot;
name: lxdbr0
type: bridge
used_by:
- /1.0/profiles/default
managed: true
status: Created
locations:
- none
</code></pre>
<p>Once that&rsquo;s done, the LXD host is now ready to be added to MAAS as an LXD VM host. Upon adding the VM host, its own commissioning information will be refreshed.</p>
<p>When composing a virtual machine with LXD, MAAS uses either the &lsquo;maas&rsquo; LXD profile, or (if that doesn&rsquo;t exist) the &lsquo;default&rsquo; LXD profile. The profile is used to determine which bridge to use. Users may also add additional LXD options to the profile which are not yet supported in MAAS.</p>
    </div>
    </body>
    </html>
    