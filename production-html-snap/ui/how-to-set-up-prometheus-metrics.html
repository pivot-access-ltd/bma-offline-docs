<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-set-up-how-to-set-up-prometheus-metrics.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-set-up-how-to-set-up-prometheus-metrics.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="../maas-documentation-25.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-the-maas-cli.html">
	    Use the MAAS CLI
	  </a>
	</li>
      <strong>
	<a href="about-controllers.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-racks.html">
	    Manage racks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-regions.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-machines.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-vm-hosting.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-networking.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machine-interfaces.html">
	    Manage interfaces
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-dhcp.html">
	    Manage DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-ranges.html">
	    Manage IP ranges
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-proxies.html">
	    Manage proxies
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-ntp.html">
	    Set up NTP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-images.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="how-to-build-maas-images.html">
	    Build MAAS images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-a-custom-ubuntu-image.html">
	    Create custom Ubuntu images
	  </a>
	</li>
	<li>
	  <a href="how-to-use-image-streams.html">
	    Use image streams
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-tags-and-annotations.html">
	  Tags
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-tags.html">
	    Manage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
	<p/>
	<strong>
	  Operations
	</strong>
	<ul>
	  <li>
	    <a href="how-to-set-up-prometheus-metrics.html">
	      Set up Prometheus
	    </a>
	  </li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Reference
      </strong>
      <ul>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API reference
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-troubleshoot-maas.html">
	  Troubleshooting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-get-help.html">
	    Get help
	  </a>
	</li>
	<li>
	  <a href="tips-and-tricks.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="what-is-new-with-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="how-to-contact-us.html">
	  Contact us
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to set up Prometheus metrics</h1><p>MAAS services can provide <a href="https://prometheus.io/">Prometheus</a> endpoints for collecting performance metrics.  These include five endpoints of particular interest to MAAS users:</p>
<ol>
<li>TFTP server file transfer latency</li>
<li>HTTP requests latency</li>
<li>Websocket requests latency</li>
<li>RPC calls (between MAAS services) latency</li>
<li>Per request DB queries counts</li>
</ol>
<p>All available metrics are prefixed with <code>maas_</code>, to make it easier to look them up in Prometheus and Grafana UIs.</p>
<h4>Three questions you may have:</h4>
<ol>
<li><a href="#heading--enabling-prometheus-endpoints">How do I enable Prometheus endpoints?</a></li>
<li><a href="#heading--configuring-prometheus">How do I configure Prometheus endpoints?</a></li>
<li><a href="#heading--deploying-prometheus-and-grafana">How can I deploy Prometheus and Grafana?</a></li>
</ol>
<p><a href="#heading--enabling-prometheus-endpoints"><h2 id="heading--enabling-prometheus-endpoints">Enabling Prometheus endpoints</h2></a></p>
<p>Whenever you install the <code>python3-prometheus-client</code> library, Prometheus endpoints are exposed over HTTP by the <code>rackd</code> and <code>regiond</code> processes under the default <code>/metrics</code> path.</p>
<p>[note]
Currently, prometheus metrics are shared when rack and region controllers are running on the same machine, even though each service provides its own port.  You can safely only query one of the two ports if you&rsquo;re running both controllers.
[/note]</p>
<p>For a snap-based MAAS installation, the libraries already included in the snap so that metrics will be available out of the box.</p>
<p><a href="#heading--configuring-prometheus"><h2 id="heading--configuring-prometheus">Configuring Prometheus</h2></a></p>
<p>Once the <code>/metrics</code> endpoint is available in MAAS services, Prometheus can be configured to scrape metric values from these. You can configure this by adding a stanza like the following to the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">prometheus configuration</a>:</p>
<pre><code class="language-yaml">    - job_name: maas
      static_configs:
        - targets:
          - &lt;maas-host1-IP&gt;:5239  # for regiond
          - &lt;maas-host1-IP&gt;:5249  # for rackd
          - &lt;maas-host2-IP&gt;:5239  # regiond-only
          - &lt;maas-host3-IP&gt;:5249  # rackd-only
</code></pre>
<p>If the MAAS installation includes multiple nodes, the <code>targets</code> entries must be adjusted accordingly, to match services deployed on each node.</p>
<p>If  you have enabled MAAS stats,  you must add an additional Prometheus job to the config:</p>
<pre><code class="language-yaml">    - job_name: maas
      metrics_path: /MAAS/metrics
      static_configs:
        - targets:
          - &lt;maas-host-IP&gt;:5240
</code></pre>
<p>In case of a multi-host deploy, adding a single IP for any of the MAAS hosts running <code>regiond</code> will suffice.</p>
<p><a href="#heading--deploying-prometheus-and-grafana"><h2 id="heading--deploying-prometheus-and-grafana">Deploying Prometheus and Grafana</h2></a></p>
<p><a href="https://grafana.com/">Grafana</a> and Prometheus can be easily deployed using Juju.</p>
<p>The <a href="https://git.launchpad.net/~maas-committers/maas/+git/maas-performance">MAAS performance repo</a> repository provides a sample <code>deploy-stack</code> script that will deploy and configure the stack on LXD containers.</p>
<p>First, you must install juju via:</p>
<pre><code>sudo snap install --classic juju
</code></pre>
<p>Then you can run the script from the repo:</p>
<pre><code>grafana/deploy-stack &lt;MAAS-IP&gt;
</code></pre>
<p>To follow the progress of the deployment, run the following:</p>
<pre><code>watch -c juju status --color
</code></pre>
<p>Once you deploy everything, the Grafana UI is accessible on port <code>3000</code> with the credentials <code>admin</code>/<code>grafana</code>. The Prometheus UI will be available on port <code>9090</code>.</p>
<p>The repository also provides some sample dashboard covering the most common use cases for graphs. These are available under <code>grafana/dashboards</code>.  You can import them from the Grafana UI or API.</p>
    </div>
  </body>
</html>