<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-create-a-custom-ubuntu-image.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-the-maas-cli.html">
	    Use the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	Controllers
      </strong>
      <ul>
	<li>
	  <a href="about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-racks.html">
	    Manage racks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-regions.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	Machines
      </strong>
      <ul>
	<li>
	  <a href="about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
      </ul>
      <strong>
	VM hosting
      </strong>
      <ul>
	<li>
	  <a href="about-vm-hosting.html">
	    About VM hosting
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	Networking fundamentals
      </strong>
      <ul>
	<li>
	  <a href="about-tcp-ip-networks.html">
	    About TCP/IP networks
	  </a>
	</li>
	<li>
	  <a href="about-cloud-networks.html">
	    About cloud networks
	  </a>
	</li>
	<li>
	  <a href="about-dhcp.html">
	    About DHCP
	  </a>
	</li>
      </ul>
      <strong>
	MAAS Networking
      </strong>
      <ul>
	<li>
	  <a href="about-networking.html">
	    About MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machine-interfaces.html">
	    Manage interfaces
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-dhcp.html">
	    Manage DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-ranges.html">
	    Manage IP ranges
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-proxies.html">
	    Manage proxies
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-ntp.html">
	    Set up NTP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Images
      </strong>
      <ul>
	<li>
	  <a href="about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="how-to-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="how-to-build-maas-images.html">
	    Build MAAS images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-a-custom-ubuntu-image.html">
	    Create custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-use-image-streams.html">
	    Use image streams
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	Tags
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-tags.html">
	    Work with tags
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-annotations.html">
	    Work with annotations
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
	<p/>
	<strong>
	  Operations
	</strong>
	<ul>
	  <li>
	    <a href="how-to-set-up-maas-metrics.html">
	      Set up MAAS metrics
	    </a>
	  </li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Reference
      </strong>
      <ul>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API documentation
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-troubleshoot-maas.html">
	  Troubleshooting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-get-help.html">
	    Get help
	  </a>
	</li>
	<li>
	  <a href="tips-and-tricks.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="what-is-new-with-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="how-to-contact-us.html">
	  Contact us
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to create a custom Ubuntu image</h1><!-- "How to create a custom Ubuntu image" -->

<p>MAAS supports deploying custom OS images.  Canonical provides both <a href="https://launchpad.net/maas-image-builder">lp:maas-image-builder</a> and <a href="https://github.com/canonical/packer-maas">gh:canonical/packer-maas</a> to support creating custom images. These custom images can include static Ubuntu images, created with whatever tool you choose, and deployed as described below. Even so, Canonical suggests <a href="how-to-customise-machines.html">customising machines</a> using cloud-init user_data or Curtin preseed data whenever possible.</p>
<p>This article will help you learn:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--about-static-ubuntu-images">About static Ubuntu images</a></li>
<li><a href="#heading--about-uploading-hand-built-ubuntu-images">About uploading hand-built Ubuntu images</a></li>
<li><a href="#heading--about-how-maas-handles-these-images">About how MAAS handles these images</a></li>
<li><a href="#heading--about-how-maas-boots-these-images">About how MAAS boots these images</a></li>
<li><a href="#heading--about-configuring-deployed-machine-networking">About configuring deployed machine networking</a></li>
<li><a href="#heading--about-configuring-deployed-machine-storage">About configuring deployed machine storage</a></li>
<li><a href="#heading--about-static-image-metrics">About static image metrics</a></li>
<li><a href="#heading--how-to-upload-a-custom-ubuntu-image">How to upload a custom Ubuntu image</a></li>
</ul>
<p><a href="#heading--about-static-ubuntu-images"><h2 id="about-static-ubuntu-images">About static Ubuntu images</h2></a></p>
<p>MAAS provides the capability for you to build an Ubuntu OS image to deploy with MAAS, using any image-building method you choose.  You can create the image once, with a fixed configuration,and deploy it to many machines.  This fixed configuration can consist of anything that a normal image would contain: users, packages, etc.</p>
<p><a href="#heading--about-uploading-hand-built-ubuntu-images"><h3 id="about-uploading-hand-built-ubuntu-images">About uploading hand-built Ubuntu images</h3></a></p>
<p>You can upload hand-built Ubuntu images, containing a kernel, bootloader, and a fixed configuration, for deployment to multiple machines.  The image can be built via a tool, such as <a href="https://github.com/canonical/packer-maas">packer</a>, or build with scripts. You can upload these images to the boot-resources endpoint, where it will then be available for deployment to machines.</p>
<p>At a minimum, this image must contain a kernel, a bootloader, and a <code>/curtin/curtin-hooks</code> script that configures the network. A sample can be found in the <a href="https://github.com/canonical/packer-maas/tree/master/ubuntu/scripts">packer-maas repos</a>. The image must be in raw img file format, since that is the format MAAS accepts for upload.  This is the most portable format, and the format most builders support. Upon completing the image build, you will upload this img file to the boot-resources endpoint, specifying the architecture for the image.</p>
<p><a href="#heading--about-how-maas-handles-these-images"><h3 id="about-how-maas-handles-these-images">About how MAAS handles these images</h3></a></p>
<p>MAAS will save the image &ndash; in the same way it would save a <code>tar.gz</code> file &ndash; in the database.  MAAS can differentiate between custom Ubuntu images and custom non-Ubuntu images, generating appropriate pre-seed configurations for each image type.</p>
<p>MAAS will also recognise the base Ubuntu version, so it can apply the correct ephemeral OS version for installation.  Custom images are always deployed with the ephemeral operating system. The base_image field is used to select the appropriate version of the ephemeral OS to avoid errors. This ensures a smooth deployment later.</p>
<p><a href="#heading--about-how-maas-boots-these-images"><h3 id="about-how-maas-boots-these-images">About how MAAS boots these images</h3></a></p>
<p>When you decide to deploy a machine with your uploaded, custom image, MAAS ensures that the machine receives the kernel, bootloader and root file system provided in the image. The initial boot loader takes over, and boots an ephemeral OS of the same Ubuntu version as the custom image, to reduce the chances of incompatibilities.  Curtin then writes your entire custom image to disk.  Once the custom image is written to disk, it is not modified by MAAS.</p>
<p>Note that custom non-Ubuntu images still use a standard Ubuntu ephemeral OS to boot, prior to installing the non-Ubuntu OS.</p>
<p><a href="#heading--about-configuring-deployed-machine-networking"><h3 id="about-configuring-deployed-machine-networking">About configuring deployed machine networking</h3></a></p>
<p>If you deploy a machine with a custom Ubuntu image, MAAS allows you to configure the deployed machine&rsquo;s networks just like you would for any other MAAS machine.  If you create an interface and assign it to a subnet or static address, this will be reflected in the deployed machine.</p>
<p>For this reason, MAAS also does some initial diagnostics while installing the custom image.  MAAS will detect when a network configuration is not present and abort the installation with a warning.  Essentially, MAAS checks to be sure that <code>cloud-init</code> and <code>netplan</code> are present in the images written by <code>curtin</code>.  If not, MAAS won&rsquo;t deploy the machine with the image.</p>
<p><a href="#heading--about-configuring-deployed-machine-storage"><h3 id="about-configuring-deployed-machine-storage">About configuring deployed machine storage</h3></a></p>
<p>If you deploy a machine with a custom Ubuntu image, you will also want to be able to configure storage, just like you would do with any other machine.  MAAS facilitates changes to the storage configuration.  You can resize the root partition, as well as attaching and formatting any additional block devices you may desire.</p>
<p><a href="#heading--about-static-image-metrics"><h3 id="about-static-image-metrics">About static image metrics</h3></a></p>
<p>As a user, you want to keep track of how many static images are being used, and how many deployed machines are using static images.  The standard MAAS dashboard reflects both of these metrics.</p>
<p><a href="#heading--how-to-upload-a-custom-ubuntu-image"><h2 id="how-to-upload-a-custom-ubuntu-image">How to upload a custom Ubuntu image</h2></a></p>
<p>Currently, custom Ubuntu images can be uploaded using the MAAS CLI,by creating a boot-resource, with a command similar to this one:</p>
<p><code>nohighlight                                                                                                           
    maas $PROFILE boot-resources create \
        name='custom/ubuntu-custom'  \
        architecture=amd64/generic \
        title=’custom ubuntu’ \
        base_image=ubuntu/focal \
        filetype=ddraw \
        content@=./custom-ubuntu.img</code>     </p>
<p>When uploading a custom image, there is a new required field: <code>base_image</code>. This is not required for non-custom images to be uploaded, but any image with the <code>custom</code> prefix will require it.</p>
    </div>
  </body>
</html>