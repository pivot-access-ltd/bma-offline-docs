<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-set-up-maas-metrics.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-the-maas-cli.html">
	    Use the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	Controllers
      </strong>
      <ul>
	<li>
	  <a href="about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-racks.html">
	    Manage racks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-regions.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	Machines
      </strong>
      <ul>
	<li>
	  <a href="about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
      </ul>
      <strong>
	VM hosting
      </strong>
      <ul>
	<li>
	  <a href="about-vm-hosting.html">
	    About VM hosting
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	Networking fundamentals
      </strong>
      <ul>
	<li>
	  <a href="about-tcp-ip-networks.html">
	    About TCP/IP networks
	  </a>
	</li>
	<li>
	  <a href="about-cloud-networks.html">
	    About cloud networks
	  </a>
	</li>
	<li>
	  <a href="about-dhcp.html">
	    About DHCP
	  </a>
	</li>
      </ul>
      <strong>
	MAAS Networking
      </strong>
      <ul>
	<li>
	  <a href="about-networking.html">
	    About MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machine-interfaces.html">
	    Manage interfaces
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-dhcp.html">
	    Manage DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-ranges.html">
	    Manage IP ranges
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-proxies.html">
	    Manage proxies
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-ntp.html">
	    Set up NTP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Images
      </strong>
      <ul>
	<li>
	  <a href="about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="how-to-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="how-to-build-maas-images.html">
	    Build MAAS images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-a-custom-ubuntu-image.html">
	    Create custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-use-image-streams.html">
	    Use image streams
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	Tags
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-tags.html">
	    Work with tags
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-annotations.html">
	    Work with annotations
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
	<p/>
	<strong>
	  Operations
	</strong>
	<ul>
	  <li>
	    <a href="how-to-set-up-maas-metrics.html">
	      Set up MAAS metrics
	    </a>
	  </li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Reference
      </strong>
      <ul>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API documentation
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-troubleshoot-maas.html">
	  Troubleshooting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-get-help.html">
	    Get help
	  </a>
	</li>
	<li>
	  <a href="tips-and-tricks.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="what-is-new-with-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="how-to-contact-us.html">
	  Contact us
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to set up MAAS metrics</h1><!-- "How to set up MAAS metrics" -->

<p>We aim to make MAAS observable, a system in which the internal state can be estimated using only telemetry data. We now offer easier integration with Prometheus and Loki, which are the data ingestion components of the popular Grafana / Prometheus / Loki / AlarmManager stack. This data should be consumed by a stack composed of off-the-shelf open source software, provided by either Juju (for example with the Canonical Observability Stack) or third-parties (SaaS, self-managed).</p>
<p>In this document, you will learn:</p>
<ul>
<li><a href="#heading--about-maas-observability">About MAAS observability</a></li>
<li><a href="#heading--how-to-use-maas-observability-features">How to configure and use MAAS observability features</a></li>
</ul>
<p><a href="#heading--about-maas-observability"><h2 id="heading--about-maas-observability">About MAAS observability</h2></a></p>
<p>Depicted below we have a reference observability stack composed of Prometheus (metrics ingestion and alerting based on metrics), Loki (log ingestion and alerting based on logs), Grafana (visualisation), Alertmanager (notification routing and dispatching) and Grafana Agent (telemetry collector).</p>
<p><a href="https://discourse.maas.io/uploads/default/optimized/2X/d/d6f66cbb3ea314818894b4f07ca8037628993ae2_2_690x437.png" target = "_blank"><src img="https://discourse.maas.io/uploads/default/optimized/2X/d/d6f66cbb3ea314818894b4f07ca8037628993ae2_2_690x437.png"></a></p>
<p>This document shows how to configure this stack to consume telemetry and to raise alerts of failures.</p>
<p><a href="#heading--maas-observability-requirements"><h3 id="heading--maas-observability-requirements">MAAS observability requirements</h3></a></p>
<ul>
<li>a Ubuntu host with MAAS 3.2+ running</li>
<li>a Ubuntu host with enough storage capacity to hold logs and metrics&rsquo; time-series</li>
</ul>
<p>Both hosts require Internet access during the install process. We use LXD to create this setup in a single host, but it&rsquo;s optional. When configuring the stack for a production environment, we advise you to read the Prometheus and Loki documentation to improve security and performance.</p>
<p><a href="#heading--how-to-use-maas-observability-features"><h2 id="heading--how-to-use-maas-observability-features">How to use MAAS observability features</h2></a></p>
<p>Observing MAAS requires three steps: configuring the tool stack, exporting the telemetry, and then verifying that everything is working properly.  This section will show you:</p>
<ul>
<li><a href="#heading--configuring-the--observability-stack">How to configure the observability stack</a></li>
<li><a href="#heading--how-to-export-maas-controller-telemetry">How to export MAAS controller telemetry</a></li>
<li><a href="#heading--how-to-verify-correct-operation">How to verify correct operation</a></li>
</ul>
<p><a href="#heading--configuring-the--observability-stack"><h3 id="heading--configuring-the--observability-stack">How to configure the observability stack</h3></a></p>
<p>Create a VM with the following script to install all required software.</p>
<pre><code class="language-bash">export LXD_NET=virbr0
export GRAFANA_REPOS=https://packages.grafana.com/oss/deb
export GRAFANA_KEY=https://packages.grafana.com/gpg.key
export LOKI_PKG=https://github.com/grafana/loki/releases/download/v2.4.2/loki-linux-amd64.zip
export PROM_PKG=https://github.com/prometheus/prometheus/releases/download/v2.31.1/prometheus-2.31.1.linux-amd64.tar.gz
export PROM_ALERT_PKG=https://github.com/prometheus/alertmanager/releases/download/v0.23.0/alertmanager-0.23.0.linux-amd64.tar.gz

cat &lt;&lt;EOF | lxc launch ubuntu: o11y
config:
    user.user-data: |
        #cloud-config
        apt:
            sources:
                grafana:
                    source: 'deb ${GRAFANA_REPOS} stable main'
                    key: |
$(wget -qO- ${GRAFANA_KEY} | sed 's/^/                        /')
        packages:
        - unzip
        - grafana
        - make
        - git
        - python3-pip
        runcmd:
        - mkdir -p /opt/prometheus /opt/loki /opt/alertmanager
        - wget -q &quot;${LOKI_PKG}&quot; -O /tmp/loki-linux-amd64.zip
        - unzip /tmp/loki-linux-amd64.zip -d /opt/loki
        - chmod a+x /opt/loki/loki-linux-amd64
        - wget -qO- &quot;${PROM_PKG}&quot; | tar xz --strip-components=1 -C /opt/prometheus
        - wget -qO- &quot;${PROM_ALERT_PKG}&quot; | tar xz --strip-components=1 -C /opt/alertmanager
        - cat /dev/zero | sudo -u ubuntu -- ssh-keygen -q -N &quot;&quot;
        ssh_authorized_keys:
        - $(cat ${HOME}/.ssh/id_rsa.pub | cut -d' ' -f1-2)
description: O11y stack
devices:
    eth0:
        type: nic
        name: eth0
        network: ${LXD_NET}
EOF

# log into the VM
lxc shell 011y
</code></pre>
<p>Next, you have to configure and start four services, include Prometheus, Loki, AlertManager, and Grafana.  This subsection will teach you:</p>
<ul>
<li><a href="#heading--how-to-configure-and-start-the-prometheus-service">How to configure and start the Prometheus service</a></li>
<li><a href="#heading--how-to-configure-and-start-the-loki-service">How to configure and start the Loki service</a></li>
<li><a href="#heading--how-to-start-the-alertmanager">How to start the AlertManager</a></li>
<li><a href="#heading--how-to-start-grafana">How to start Grafana</a></li>
</ul>
<p>Once these services are started, you can proceed to export telemetry data and see how your observability tools are working.</p>
<p><a href="#heading--how-to-configure-and-start-the-prometheus-service"><h4 id="heading--how-to-configure-and-start-the-prometheus-service">How to configure and start the Prometheus service</h4></a></p>
<p>Create the Prometheus configuration.</p>
<pre><code class="language-bash">cat &gt; /opt/prometheus/prometheus.yaml &lt;&lt;EOF
global:
  evaluation_interval: 1m
rule_files:
  - /var/lib/prometheus/rules/maas/*.yml
alerting:
  alertmanagers:
    - static_configs:
      - targets:
        - localhost:9093
EOF
</code></pre>
<p>MAAS has a git repository of curated alert rules for Prometheus. Checkout this repository, compile the rules and copy them to prometheus directory.</p>
<pre><code class="language-bash">git clone https://github.com/canonical/maas-prometheus-alert-rules.git
cd maas-prometheus-alert-rules
make python-deps groups

mkdir -p /var/lib/prometheus/rules/maas
cp group.yml /var/lib/prometheus/rules/maas/
</code></pre>
<p>Start the Prometheus service. You should enable the <em>Remote-Write Receiver</em> function.</p>
<pre><code class="language-bash">systemd-run -u prometheus /opt/prometheus/prometheus \
    --config.file=/opt/prometheus/prometheus.yaml \
    --enable-feature=remote-write-receiver
</code></pre>
<p><a href="#heading--how-to-configure-and-start-the-loki-service"><h4 id="heading--how-to-configure-and-start-the-loki-service">How to configure and start the Loki service</h4></a></p>
<p>Create the Loki configuration.</p>
<pre><code class="language-bash">cat &gt; /opt/loki/loki.yaml &lt;&lt;EOF
auth_enabled: false
server:
  http_listen_port: 3100
  grpc_listen_port: 9096
common:
  path_prefix: /var/lib/loki/
  storage:
    filesystem:
      chunks_directory: /var/lib/loki/chunks
      rules_directory: /var/lib/loki/rules
  replication_factor: 1
  ring:
    instance_addr: 127.0.0.1
    kvstore:
      store: inmemory
schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h
ruler:
  alertmanager_url: http://localhost:9093
  evaluation_interval: 15s
  poll_interval: 1m
  storage:
    type: local
    local:
      directory: /var/lib/loki/rules
  enable_api: true
EOF
</code></pre>
<p>MAAS has a git repository of curated alert rules for Loki. Checkout this repository, compile the rules and copy them to Loki directory.</p>
<pre><code class="language-bash">git clone https://github.com/canonical/maas-loki-alert-rules.git
cd maas-loki-alert-rules
make groups

mkdir -p /var/lib/loki/rules/maas
cp rules/bundle.yml /var/lib/loki/rules/maas/
</code></pre>
<p>Start the Loki service.</p>
<pre><code class="language-bash">systemd-run -u loki /opt/loki/loki-linux-amd64 \
    --config.file=/opt/loki/loki.yaml
</code></pre>
<p><a href="#heading--how-to-start-the-alertmanager"><h4 id="heading--how-to-start-the-alertmanager">How to start the AlertManager</h4></a></p>
<p>The default configuration is enough for receiving alerts from Prometheus and Loki. You should read the project documentation to change it to forward notifications to somewhere useful.</p>
<pre><code class="language-bash">systemd-run -u alertmanager /opt/alertmanager/alertmanager \
    --config.file=/opt/alertmanager/alertmanager.yml
</code></pre>
<p>You can access the AlertManager dashboard at <code>http://&lt;VM_IP&gt;:9093</code></p>
<p><a href="#heading--how-to-start-grafana"><h4 id="heading--how-to-start-grafana">How to start Grafana</h4></a></p>
<p>Grafana works out-of-the-box with the default configuration.</p>
<pre><code class="language-bash">systemctl enable grafana-server
systemctl start grafana-server
</code></pre>
<p>You can access the dashboard at <code>http://&lt;VM_IP&gt;:3000</code>, the default user/password is &ldquo;admin&rdquo;.</p>
<p><a href="#heading--how-to-export-maas-controller-telemetry"><h3 id="heading--how-to-export-maas-controller-telemetry">How to export MAAS controller telemetry</h3></a></p>
<p>The Grafana Agent should be installed in the same host as MAAS.</p>
<pre><code class="language-bash"># Set this to the address of the VM running Loki and Prometheus
export O11y_IP=&lt;VM_IP&gt;
export GRAFANA_AGENT_PKG=https://github.com/grafana/agent/releases/download/v0.22.0/agent-linux-amd64.zip

wget -q &quot;${GRAFANA_AGENT_PKG}&quot; -O /tmp/agent.zip
unzip /tmp/agent.zip -d /opt/agent
chmod a+x /opt/agent/agent-linux-amd64
</code></pre>
<p>Copy the agent example configuration from MAAS and start the agent. Adapt the environment variable values to your setup.  For example, if you&rsquo;re using a snap, the <code>MAAS_LOGS</code> variable would be as shown (<code>/var/snap/maas/common/log</code>):</p>
<pre><code class="language-bash">mkdir -p /var/lib/grafana-agent/positions \
         /var/lib/grafana-agent/wal
cp /snap/maas/current/usr/share/maas/grafana_agent/agent.yaml.example /opt/agent/agent.yml

systemd-run -u telemetry \
    -E HOSTNAME=&quot;$(hostname)&quot; \
    -E AGENT_WAL_DIR=&quot;/var/lib/grafana-agent/wal&quot; \
    -E AGENT_POS_DIR=&quot;/var/lib/grafana-agent/positions&quot; \
    -E PROMETHEUS_REMOTE_WRITE_URL=&quot;http://${O11y_IP}:9090/api/v1/write&quot; \
    -E LOKI_API_URL=&quot;http://${O11y_IP}:3100/loki/api/v1/push&quot; \
    -E MAAS_LOGS=&quot;/var/snap/maas/common/log/&quot; \
    -E MAAS_IS_REGION=&quot;true&quot; \
    -E MAAS_IS_RACK=&quot;true&quot; \
    -E MAAS_AZ=&quot;default&quot; \
    /opt/agent/agent-linux-amd64 \
        -config.expand-env \
        -config.file=/opt/agent/agent.yml
</code></pre>
<p>On the other hand, if you&rsquo;re using packages, the <code>MAAS_LOGS</code> would be <code>/var/log/maas</code>, as shown below:</p>
<pre><code class="language-bash">    ...
    -E MAAS_LOGS=&quot;/var/log/maas&quot; \
    ...
</code></pre>
<p>Be sure to adjust the values of the other environment variables to suit your situation, where applicable.</p>
<p>Next, enable log forwarding in MAAS.</p>
<pre><code class="language-bash"># set the TCP port the Grafana Agent is listening for syslog messages
# this port must match the one in /opt/agent/agent.yml
maas $ADMIN maas set-config name=promtail_port value=5238

# enable syslog forwarding
maas $ADMIN maas set-config name=promtail_enabled value=true
</code></pre>
<p><a href="#heading--how-to-verify-correct-operation"><h3 id="heading--how-to-verify-correct-operation">How to verify correct operation</h3></a></p>
<p>You should be able to add Loki and Prometheus as datasources in Grafana and to create dashboards for visualising MAAS metrics, and to receive alerts through Alertmanager.</p>
<p><a href="#heading--configuring-prometheus"><h3 id="heading--configuring-prometheus">Configuring Prometheus</h3></a></p>
<p>Once the <code>/metrics</code> endpoint is available in MAAS services, Prometheus can be configured to scrape metric values from these. You can configure this by adding a stanza like the following to the <a href="https://prometheus.io/docs/prometheus/latest/configuration/configuration/">prometheus configuration</a>:</p>
<pre><code class="language-yaml">    - job_name: maas
      static_configs:
        - targets:
          - &lt;maas-host1-IP&gt;:5239  # for regiond
          - &lt;maas-host1-IP&gt;:5249  # for rackd
          - &lt;maas-host2-IP&gt;:5239  # regiond-only
          - &lt;maas-host3-IP&gt;:5249  # rackd-only
</code></pre>
<p>If the MAAS installation includes multiple nodes, the <code>targets</code> entries must be adjusted accordingly, to match services deployed on each node.</p>
<p>If  you have enabled MAAS stats,  you must add an additional Prometheus job to the config:</p>
<pre><code class="language-yaml">    - job_name: maas
      metrics_path: /MAAS/metrics
      static_configs:
        - targets:
          - &lt;maas-host-IP&gt;:5240
</code></pre>
<p>In case of a multi-host deploy, adding a single IP for any of the MAAS hosts running <code>regiond</code> will suffice.</p>
<p><a href="#heading--deploying-prometheus-and-grafana"><h3 id="heading--deploying-prometheus-and-grafana">Deploying Prometheus and Grafana</h3></a></p>
<p><a href="https://grafana.com/">Grafana</a> and Prometheus can be easily deployed using Juju.</p>
<p>The <a href="https://git.launchpad.net/~maas-committers/maas/+git/maas-performance">MAAS performance repo</a> repository provides a sample <code>deploy-stack</code> script that will deploy and configure the stack on LXD containers.</p>
<p>First, you must install juju via:</p>
<pre><code>sudo snap install --classic juju
</code></pre>
<p>Then you can run the script from the repo:</p>
<pre><code>grafana/deploy-stack &lt;MAAS-IP&gt;
</code></pre>
<p>To follow the progress of the deployment, run the following:</p>
<pre><code>watch -c juju status --color
</code></pre>
<p>Once you deploy everything, the Grafana UI is accessible on port <code>3000</code> with the credentials <code>admin</code>/<code>grafana</code>. The Prometheus UI will be available on port <code>9090</code>.</p>
<p>The repository also provides some sample dashboard covering the most common use cases for graphs. These are available under <code>grafana/dashboards</code>.  You can import them from the Grafana UI or API.</p>
    </div>
  </body>
</html>