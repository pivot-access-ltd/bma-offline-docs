<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-manage-vms.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-manage-vms.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="../maas-documentation-25.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-the-maas-cli.html">
	    Use the MAAS CLI
	  </a>
	</li>
      <strong>
	<a href="about-controllers.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-racks.html">
	    Manage racks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-regions.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-machines.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-vm-hosting.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-networking.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machine-interfaces.html">
	    Manage interfaces
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-dhcp.html">
	    Manage DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-ranges.html">
	    Manage IP ranges
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-proxies.html">
	    Manage proxies
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-ntp.html">
	    Set up NTP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-images.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="how-to-build-maas-images.html">
	    Build MAAS images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-a-custom-ubuntu-image.html">
	    Create custom Ubuntu images
	  </a>
	</li>
	<li>
	  <a href="how-to-use-image-streams.html">
	    Use image streams
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="about-tags-and-annotations.html">
	  Tags
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-tags.html">
	    Manage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
	<p/>
	<strong>
	  Operations
	</strong>
	<ul>
	  <li>
	    <a href="how-to-set-up-prometheus-metrics.html">
	      Set up Prometheus
	    </a>
	  </li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Reference
      </strong>
      <ul>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API reference
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-troubleshoot-maas.html">
	  Troubleshooting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-get-help.html">
	    Get help
	  </a>
	</li>
	<li>
	  <a href="tips-and-tricks.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="what-is-new-with-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="how-to-contact-us.html">
	  Contact us
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to manage VMs</h1><p>If you have already created a VM host, you will want to create and delete virtual machines (VMs); this article will explain:</p>
<ul>
<li><a href="#heading--adding-a-vm-from-the-cli">How to add a VM</a></li>
<li><a href="#heading--set-resources">How to set resources while adding a VM</a></li>
<li><a href="#heading--architecture">How to set the architecture while adding a VM</a></li>
<li><a href="#heading--storage">How to set storage parameters while adding a VM</a></li>
<li><a href="#heading--interfaces">How to specify interfaces while adding a VM</a></li>
<li><a href="#heading--find-vm-host-ids">How to find a VM host ID</a></li>
<li><a href="#heading--delete-a-vm">How to delete a VM</a></li>
</ul>
<p><a href="#heading--adding-a-vm-from-the-cli"><h2 id="heading--adding-a-vm-from-the-cli">How to add a VM</h2></a></p>
<p>To compose a basic VM:</p>
<pre><code>maas $PROFILE vm-host compose $VM_HOST_ID
</code></pre>
<p>Example output for default composing:</p>
<pre><code>{
    "system_id": "73yxmc",
    "resource_uri": "/MAAS/api/2.0/machines/73yxmc/"
}
</code></pre>
<p><a href="#heading--set-resources"><h3 id="heading--set-resources">How to set resources while adding a VM</h3></a></p>
<p>Compose with resources specified:</p>
<pre><code>maas $PROFILE vm-host compose $VM_HOST_ID $RESOURCES
</code></pre>
<p>Where $RESOURCES is a space-separated list of six constraints:</p>
<ol>
<li><em>cores=</em> requested cores</li>
<li><em>cpu_speed=</em> requested minimum cpu speed in MHz</li>
<li><em>memory=</em> requested memory in MB</li>
<li><em>architecture=</em> See <a href="#heading--architecture">Architecture</a> below </li>
<li><em>storage=</em> See <a href="#heading--storage">Storage</a> below</li>
<li><em>interfaces=</em> See <a href="#heading--interfaces">Interfaces</a> below</li>
</ol>
<p><a href="#heading--architecture"><h3 id="heading--architecture">How to set the architecture while adding a VM</h3></a></p>
<p>To list available architectures:</p>
<pre><code>maas $PROFILE boot-resources read
</code></pre>
<p>Then, for example:</p>
<pre><code>maas $PROFILE vm-host compose $VM_HOST_ID \
    cores=40 cpu_speed=2000 memory=7812 architecture="amd64/generic"
</code></pre>
<p><a href="#heading--storage"><h3 id="heading--storage">How to set storage parameters while adding a VM</h3></a></p>
<p>Storage parameters look like this:</p>
<pre><code>storage="&lt;label&gt;:&lt;size in GB&gt;(&lt;storage pool name&gt;),&lt;label&gt;:&lt;size in GB&gt;(&lt;storage pool name&gt;)"
</code></pre>
<p>For example, let&rsquo;s examine how to compose a machine with the following two disks:</p>
<ol>
<li>32 GB disk from storage pool <code>pool1</code></li>
<li>64 GB disk from storage pool <code>pool2</code></li>
</ol>
<p>where we want the first disk to be a bootable root partition <code>/</code> and the second to be a home directory.</p>
<p>First, create the VM:</p>
<pre><code>maas $PROFILE vm-host compose $VM_HOST_ID "storage=mylabel:32(pool1),mylabel:64(pool2)"
</code></pre>
<p>Note that the labels, here <code>mylabel</code>, are an ephemeral convenience that you might find useful in scripting MAAS actions.</p>
<p>MAAS will create a VM with 2 disks, <code>/dev/vda</code> (32 GB) and <code>/dev/vdb</code> (64 GB). After MAAS enlists, commissions and acquires the machine, you can edit the disks before deploying to suit your needs. For example, we&rsquo;ll set a boot, root, and home partition.</p>
<p>We&rsquo;ll start by deleting the <code>/</code> partition MAAS created because we want a separate <code>/boot</code> partition to demonstrate how yo.</p>
<pre><code>maas admin partition delete $VM_HOST_ID $DISK1_ID $PARTITION_ID
</code></pre>
<p>[note]
To find <code>$DISK1_ID</code> and <code>$PARTITION_ID</code>, use <code>maas admin machine read $VM_HOST_ID</code>.
[/note]</p>
<p>Now, create a boot partition (~512MB):</p>
<pre><code>maas admin partitions create $VM_HOST_ID $DISK1_ID size=512000000 bootable=True
</code></pre>
<p>We&rsquo;ll use the remaining space for the root partition, so create another without specifying size:</p>
<pre><code>maas admin partitions create $VM_HOST_ID $DISK1_ID
</code></pre>
<p>Finally, create a partition to use as the home directory. Here we&rsquo;ll use the entire space:</p>
<pre><code>maas admin partitions create $VM_HOST_ID $DISK2_ID
</code></pre>
<p>[note]
To find <code>$DISK2_ID</code>, use <code>maas admin machine read $VM_HOST_ID</code>.
[/note]</p>
<p>Now, format the partitions. This requires three commands:</p>
<pre><code>maas admin partition format $VM_HOST_ID $DISK1_ID $BOOT_PARTITION_ID fstype=ext2
maas admin partition format $VM_HOST_ID $DISK1_ID $ROOT_PARTITION_ID fstype=ext4
maas admin partition format $VM_HOST_ID $DISK2_ID $HOME_PARTITION_ID fstype=ext4
</code></pre>
<p>[note]
To find the partition IDs, use <code>maas admin partitions read $VM_HOST_ID $DISK1_ID</code> and <code>maas admin partitions read $VM_HOST_ID $DISK2_ID</code>
[/note]</p>
<p>Before you can deploy the machine with our partition layout, you need to mount the new partitions. Here, we&rsquo;ll do that in three commands:</p>
<pre><code>maas admin partition mount $SYSTEM_ID $DISK1_ID $BOOT_PARTITION_ID     "mount_point=/boot"
maas admin partition mount $SYSTEM_ID $DISK1_ID $ROOT_PARTITION_ID "mount_point=/"
maas admin partition mount $SYSTEM_ID $DISK2_ID $HOME_PARTITION_ID "mount_point=/home"
</code></pre>
<p>Finally, we deploy the machine. MAAS will use the partitions as we have defined them, similar to a normal Ubuntu desktop install:</p>
<pre><code>maas admin machine deploy $SYSTEM_ID
</code></pre>
<p><a href="#heading--interfaces"><h3 id="heading--interfaces">How to specify interfaces while adding a VM</h3></a></p>
<p>Using the <code>interfaces</code> constraint, you can compose virtual machines with interfaces, allowing the selection of VM host NICs.</p>
<p>If you don&rsquo;t specify an <code>interfaces</code> constraint, MAAS maintains backward compatibility by checking for a <code>maas</code> network, then a <code>default</code> network to which to connect the virtual machine.</p>
<p>If you specify an <code>interfaces</code> constraint, MAAS creates a <code>bridge</code> or <code>macvlan</code> attachment to the networks that match the given constraint. MAAS prefers <code>bridge</code> interface attachments when possible since this typically results in successful communication.</p>
<p>Consider the following interfaces constraint:</p>
<pre><code>interfaces=eth0:space=maas;eth1:space=storage
</code></pre>
<p>Assuming you deploy the VM host on a machine or controller with access to the <code>maas</code> and <code>storage</code> <a href="maas-concepts-and-terms-reference-5415.html#heading--spaces">spaces</a>, MAAS will create an <code>eth0</code> interface bound to the <code>maas</code> space and an <code>eth1</code> interface bound to the <code>storage</code> space.</p>
<p>Another example tells MAAS to assign unallocated IP addresses:</p>
<pre><code>interfaces=eth0:ip=172.16.99.42
</code></pre>
<p>MAAS automatically converts the <code>ip</code> constraint to a VLAN constraint (matching the VLAN which corresponds to the subnet can be found &ndash; e.g. <code>172.16.99.0/24</code>.) and assigns the IP address to the newly-composed machine upon allocation.</p>
<p>See the Machines <a href="https://maas.io/docs/api#machines">MAAS API documentation</a>&#128279; for a list of all constraint keys.</p>
<p><a href="#heading--find-vm-host-ids"><h3 id="heading--find-vm-host-ids">How to find a VM host ID</h3></a></p>
<p>Here&rsquo;s a simple way to find a VM host&rsquo;s ID by name using <code>jq</code>:</p>
<pre><code>maas $PROFILE vm-hosts read | jq '.[] | select (.name=="MyVMHost") | .name, .id'
</code></pre>
<p>Example output:</p>
<pre><code>"MyVMHost"
1
</code></pre>
<p><a href="#heading--delete-a-vm"><h2 id="heading--delete-a-vm">How to delete a VM</h2></a></p>
<pre><code>maas $PROFILE machine delete $SYSTEM_ID
</code></pre>
<p>After you delete a machine, its resources will be available for other VMs.</p>
<!--
* How to manage NUMA VMs

** How to examine NUMA node resources

You can examine the resources of a NUMA node with the MAAS CLI. A very basic way to do so is to enter the following command for a configured VM:
=maas $PROFILE machine read $SYSTEM\_ID=
In the resulting JSON output, look for the array entry =numanode\_set=, which will show the NUMA details for that specific VM:
="numanode\_set": [ { "index": 0, "memory": 16384, "cores": [ 0, 2, 1, 3, ], "hugepages\_set": [ { "page\_size": 2097152, "total": 0 } ] } ]=

** How to examine resources for NUMA-node-bearing VM hosts

With the MAAS CLI, you can get an overview of resource usage for an LXD host that's running NUMA VMs with the following command:
=maas $PROFILE virtual-machines read=
Currently, the API does not give you an aggregated usage, as provided in the UI; hence you'll have to look at the VMs and sum up the usage data yourself. You can see a list of pinned cores via this method, and we do show alignment of machines and NUMA nodes.

** How to examine the alignment between VM host interfaces and NUMA nodes

To see an alignment of VM host interfaces and NUMA nodes via the CLI, you can use the command mentioned above:
=maas $PROFILE machine read $SYSTEM\_ID=
and focus on the =interface\_block= section in the resulting JSON. This will give you the alignment information you're seeking.

** How to configure and use hugepages on my VMs

Configuring hugepages for VM use consists of two steps:
1. Creating a tag which includes a kernel option to use hugepages.
2. Composing a VM backed with hugepages, tagged with the newly-created tag.
Here are the specific commands:
=maas $PROFILE tags create name=use-hugepages kernel\_opts=default\_hugepagesz=1G hugepages=20" maas $PROFILE vm-host compose $VM\_HOST\_ID pinned\_cores=$CORE\_NUMBER hugepages\_backed=true=



This section explains:

-->
    </div>
  </body>
</html>