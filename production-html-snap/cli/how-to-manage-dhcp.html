<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-manage-dhcp.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-the-maas-cli.html">
	    Use the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	Controllers
      </strong>
      <ul>
	<li>
	  <a href="about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-racks.html">
	    Manage racks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-regions.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	Machines
      </strong>
      <ul>
	<li>
	  <a href="about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
      </ul>
      <strong>
	VM hosting
      </strong>
      <ul>
	<li>
	  <a href="about-vm-hosting.html">
	    About VM hosting
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	Networking fundamentals
      </strong>
      <ul>
	<li>
	  <a href="about-tcp-ip-networks.html">
	    About TCP/IP networks
	  </a>
	</li>
	<li>
	  <a href="about-cloud-networks.html">
	    About cloud networks
	  </a>
	</li>
	<li>
	  <a href="about-dhcp.html">
	    About DHCP
	  </a>
	</li>
      </ul>
      <strong>
	MAAS Networking
      </strong>
      <ul>
	<li>
	  <a href="about-networking.html">
	    About MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machine-interfaces.html">
	    Manage interfaces
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-dhcp.html">
	    Manage DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-ranges.html">
	    Manage IP ranges
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-proxies.html">
	    Manage proxies
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-ntp.html">
	    Set up NTP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Images
      </strong>
      <ul>
	<li>
	  <a href="about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="how-to-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="how-to-build-maas-images.html">
	    Build MAAS images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-a-custom-ubuntu-image.html">
	    Create custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-use-image-streams.html">
	    Use image streams
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	Tags
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-tags.html">
	    Work with tags
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-annotations.html">
	    Work with annotations
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
	<p/>
	<strong>
	  Operations
	</strong>
	<ul>
	  <li>
	    <a href="how-to-set-up-maas-metrics.html">
	      Set up MAAS metrics
	    </a>
	  </li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
      </ul>
      <strong>
	Reference
      </strong>
      <ul>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API documentation
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-troubleshoot-maas.html">
	  Troubleshooting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-get-help.html">
	    Get help
	  </a>
	</li>
	<li>
	  <a href="tips-and-tricks.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="what-is-new-with-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="how-to-contact-us.html">
	  Contact us
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to manage DHCP</h1><!-- "How to manage DHCP" -->
<p>MAAS enlists and commissions machines through the use of its DHCP server running on an untagged VLAN. Although this MAAS-managed DHCP can also be part of the deploy phase, an external DHCP server can optionally be used instead for this purpose. If MAAS detects an external DHCP server, it will display it on the rack controller&rsquo;s page, accessible by selecting &lsquo;Controllers&rsquo; from the top menu in the web UI.</p>
<p>In addition, the machine subnet is usually on the untagged VLAN. If not, you will need to route DHCP packets between the subnet and the MAAS-provided DHCP subnet. It is also possible to forward DHCP traffic from one VLAN to another using an external DHCP relay service.</p>
<p>This documentation presupposes that MAAS-managed DHCP is used to enlist and commission machines.  Using an external DHCP server for enlistment and commissioning may work, but note that this is not supported. MAAS cannot manage an external DHCP server, nor can it keep leases synchronised when you return a machine to the pool.</p>
<p>This article will tell you:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--enabling-dhcp">How to enable MAAS-managed DHCP</a></li>
<li><a href="#heading--resolving-ip-conflicts">How to resolve IP conflicts</a></li>
<li><a href="#heading--extending-a-reserved-dynamic-ip-range">How to extend a reserved dynamic IP range</a></li>
<li><a href="#heading--external-dhcp-and-a-reserved-ip-range">How to configure external DHCP</a></li>
<li><a href="#heading--dhcp-relay">How to use a DHCP relay</a></li>
<li><a href="#heading--dhcp-snippets">How to customise MAAS with DHCP snippets</a></li>
<li><a href="#heading--list-snippets">How to list DHCP snippets</a></li>
<li><a href="#heading--update-a-snippet">How to update a DHCP snippet</a></li>
<li><a href="#heading--enable-or-disable-a-snippet">How to enable or disable a DHCP snippet</a></li>
<li><a href="#heading--delete-a-snippet">How to delete a DHCP snippet</a></li>
<li><a href="#heading--create-an-a-or-aaaa-record-in-dns">How to create an A or AAAA record in DNS</a></li>
<li><a href="#heading--create-an-alias-cname-record-in-dns">How to create an alias (CNAME) record in DNS</a></li>
<li><a href="#heading--create-a-mail-exchange-pointer-record-in-dns">How to create a Mail Exchange pointer record in DNS</a></li>
<li><a href="#heading--set-a-dns-forwarder">How to set a DNS forwarder</a></li>
</ul>
<p><a href="#heading--enabling-dhcp"><h2 id="heading--enabling-dhcp">How to enable MAAS-managed DHCP</h2></a></p>
<p>MAAS-managed DHCP needs a reserved dynamic IP range enlist and commission machines. You should create such a range when you are enabling DHCP with the web UI.</p>
<p>To enable DHCP on a VLAN on a certain fabric:</p>
<pre><code class="language-nohighlight">maas $PROFILE vlan update $FABRIC_ID $VLAN_TAG dhcp_on=True \
    primary_rack=$PRIMARY_RACK_CONTROLLER
</code></pre>
<p>To enable DHCP HA, you will need both a primary and a secondary controller:</p>
<pre><code class="language-nohighlight">maas $PROFILE vlan update $FABRIC_ID $VLAN_TAG dhcp_on=True \
    primary_rack=$PRIMARY_RACK_CONTROLLER \
    secondary_rack=$SECONDARY_RACK_CONTROLLER 
</code></pre>
<p><strong>NOTE:</strong> 
You must enable DHCP for PXE booting on the &lsquo;untagged&rsquo; VLAN.</p>
<p>You will also need to set a default gateway:</p>
<pre><code class="language-nohighlight">maas $PROFILE subnet update $SUBNET_CIDR gateway_ip=$MY_GATEWAY
</code></pre>
<p><a href="#heading--resolving-ip-conflicts"><h3 id="heading--resolving-ip-conflicts">How to resolve IP conflicts</h3></a></p>
<p>In some cases, MAAS manages a subnet that is not empty, which could result in MAAS assigning a duplicate IP address.  MAAS is capable of detecting IPs in use on a subnet.  Be aware that there are two caveats:</p>
<ol>
<li>
<p>If a previously-assigned NIC is in a quiescent state or turned off, MAAS may not detect it before duplicating an IP address.</p>
</li>
<li>
<p>At least one rack controller must have access to the IP-assigned machine in order for this feature to work.</p>
</li>
</ol>
<p>MAAS also recognises when the subnet ARP cache is full, so that it can re-check the oldest IPs added to the cache to search for free IP addresses.</p>
<p><a href="#heading--extending-a-reserved-dynamic-ip-range"><h2 id="heading--extending-a-reserved-dynamic-ip-range">How to extend a reserved dynamic IP range</h2></a></p>
<p>If necessary, it is possible to add further portions of the subnet to the dynamic IP range (see <a href="how-to-manage-ip-ranges.html">IP ranges</a>). Furthermore, since you enabled DHCP on a VLAN basis and a VLAN can contain multiple subnets, it is possible to add a portion from those subnets as well. Just select the subnet under the &lsquo;Subnets&rsquo; page and reserve a dynamic range. DHCP will be enabled automatically.</p>
<p><a href="#heading--external-dhcp-and-a-reserved-ip-range"><h2 id="heading--external-dhcp-and-a-reserved-ip-range">How to configure external DHCP</h2></a></p>
<p>If an external DHCP server is used to deploy machines, then a reserved IP range should be created to prevent the address namespace from being corrupted. For instance, address conflicts may occur if you set a machine&rsquo;s IP assignment mode to &lsquo;Auto assign&rsquo; in the context of an external DHCP server. See <a href="how-to-manage-ip-ranges.html">IP ranges</a> to create such a range. It should correspond to the lease range of the external server.</p>
<p><a href="#heading--dhcp-relay"><h2 id="heading--dhcp-relay">How to use a DHCP relay</h2></a></p>
<p>You should not enable DHCP relays in MAAS without sufficient planning.  In particular, MAAS does not provide the actual relay. It must be set up as an external service by the administrator. What MAAS does provide is the DHCP configuration that MAAS-managed DHCP requires in order to satisfy any client requests relayed from another VLAN.</p>
<p>To relay from one VLAN (source) to another VLAN (target):</p>
<ol>
<li>
<p>Ensure the target VLAN has DHCP enabled.</p>
</li>
<li>
<p>Set up the external relay. This relay is set up independently from MAAS. See <a href="maas-concepts-and-terms-reference.html#heading--dhcp-relay">DHCP relay</a> for software suggestions.</p>
</li>
<li>
<p>To relay DHCP traffic for a VLAN (source) through another VLAN (target):</p>
</li>
</ol>
<pre><code class="language-nohighlight">maas $PROFILE vlan update $FABRIC_ID $VLAN_VID_SRC relay_vlan=$VLAN_ID_TARGET
</code></pre>
<p>For example, to relay VLAN with vid 0 (on fabric-2) through VLAN with id 5002 :</p>
<pre><code class="language-nohighlight">maas $PROFILE vlan update 2 0 relay_van=5002
</code></pre>
<p><a href="#heading--dhcp-snippets"><h2 id="heading--dhcp-snippets">How to customise MAAS with DHCP snippets</h2></a></p>
<p><strong>NOTE:</strong> 
Modifications made directly to <code>dhcpd.conf.template</code> or <code>dhcpd6.conf.template</code> are not supported.</p>
<p>When you create a snippet, MAAS enables it by default.</p>
<p>To create a <strong>global</strong> snippet:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippets create name=$DHCP_SNIPPET_NAME \
    value=$DHCP_CONFIG description=$DHCP_SNIPPET_DESCRIPTION \
    global_snippet=true
</code></pre>
<p>To create a <strong>subnet</strong> snippet:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippets create name=$DHCP_SNIPPET_NAME \
    value=$DHCP_CONFIG description=$DHCP_SNIPPET_DESCRIPTION \
    subnet=$SUBNET_ID
</code></pre>
<p>You can also specify subnets in CIDR format.</p>
<p>To create a <strong>node</strong> snippet:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippets create name=$DHCP_SNIPPET_NAME \
    value=$DHCP_CONFIG description=$DHCP_SNIPPET_DESCRIPTION \
    node=$NODE_ID
</code></pre>
<p>You can also use a hostname instead of the node ID.</p>
<p><a href="#heading--list-snippets"><h3 id="heading--list-snippets">How to list DHCP snippets</h3></a></p>
<p>To list all snippets (and their characteristics) in the MAAS:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippets read
</code></pre>
<p>To list a specific snippet:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippet read id=$DHCP_SNIPPET_ID
</code></pre>
<p>The snippet name can also be used instead of its ID:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippet read name=$DHCP_SNIPPET_NAME
</code></pre>
<p><a href="#heading--update-a-snippet"><h3 id="heading--update-a-snippet">How to update a DHCP snippet</h3></a></p>
<p>Update a snippet attribute:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippet update $DHCP_SNIPPET_ID &lt;option=value&gt;
</code></pre>
<p>You can also use a snippet name instead of its ID.</p>
<p><a href="#heading--enable-or-disable-a-snippet"><h3 id="heading--enable-or-disable-a-snippet">How to enable or disable a DHCP snippet</h3></a></p>
<p>Enabling and disabling a snippet is considered a snippet update and is done via a Boolean option (&lsquo;true&rsquo; or &lsquo;false&rsquo;). You can disable a snippet like this:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippet update $DHCP_SNIPPET_ID enabled=false
</code></pre>
<p>When you disable a snippet, MAAS removes the text you added to the dhcpd.conf file when you created the snippet.</p>
<p><a href="#heading--delete-a-snippet"><h3 id="heading--delete-a-snippet">How to delete a DHCP snippet</h3></a></p>
<p>To delete a snippet:</p>
<pre><code class="language-nohighlight">maas $PROFILE dhcpsnippet delete $DHCP_SNIPPET_ID
</code></pre>
<p>You can also use a snippet name in place of its ID.</p>
<p><a href="#heading--set-dns-parameters"><h2 id="heading--set-dns-parameters">How to set DNS parameters</h2></a></p>
<p>It is possible to set DNS parameters using the MAAS CLI, using the following instructions.</p>
<p><a href="#heading--create-an-a-or-aaaa-record-in-dns"><h3 id="heading--create-an-a-or-aaaa-record-in-dns">How to create an A or AAAA record in DNS</h3></a></p>
<p>An administrator can create an A record when creating a DNS resource with an IPv4 address.</p>
<pre><code class="language-nohighlight">mass $PROFILE dnsresources create fqdn=$HOSTNAME.$DOMAIN ip_addresses=$IPV4ADDRESS
</code></pre>
<p>An administrator can create an AAAA record when creating a DNS resource with an IPv6 address.</p>
<pre><code class="language-nohighlight">mass $PROFILE dnsresources create fqdn=$HOSTNAME.$DOMAIN ip_addresses=$IPV6ADDRESS
</code></pre>
<p><a href="#heading--create-an-alias-cname-record-in-dns"><h3 id="heading--create-an-alias-cname-record-in-dns">How to create an alias (CNAME) record in DNS</h3></a></p>
<p>An administrator can set a DNS Alias (CNAME record) to an already existing DNS entry of a machine.</p>
<pre><code class="language-nohighlight">mass $PROFILE dnsresource-records create fqdn=$HOSTNAME.$DOMAIN rrtype=cname rrdata=$ALIAS
</code></pre>
<p>For example, to set <code>webserver.maas.io</code> to alias to <code>www.maas.io</code>:</p>
<pre><code class="language-nohighlight">maas $PROFILE dnsresource-records create fqdn=webserver.maas.io rrtype=cname rrdata=www
</code></pre>
<p><a href="#heading--create-a-mail-exchange-pointer-record-in-dns"><h3 id="heading--create-a-mail-exchange-pointer-record-in-dns">How to create a Mail Exchange pointer record in DNS</h3></a></p>
<p>An administrator can set a DNS Mail Exchange pointer record (MX and value) to a domain.</p>
<pre><code class="language-nohighlight">maas $PROFILE dnsresource-records create fqdn=$DOMAIN rrtype=mx rrdata='10 $MAIL_SERVER.$DOMAIN'
</code></pre>
<p>For example, to set the domain.name managed by MAAS to have an MX record and that you own the domain:</p>
<pre><code class="language-nohighlight">maas $PROFILE dnsresource-records create fqdn=maas.io rrtype=mx rrdata='10 smtp.maas.io'
</code></pre>
<p><a href="#heading--set-a-dns-forwarder"><h2 id="heading--set-a-dns-forwarder">How to set a DNS forwarder</h2></a></p>
<p>To set a DNS forwarder:</p>
<pre><code class="language-nohighlight">maas $PROFILE maas set-config name=upstream_dns value=$MY_UPSTREAM_DNS
</code></pre>
    </div>
  </body>
</html>