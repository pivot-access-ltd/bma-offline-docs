<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/tutorial-custom-images.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="ui/maas-documentation-25.html">
	  Home
	</a>
      </strong>
      <p>
      <strong>
	<a href="ui/tutorials.html">
	  Tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/bootstrap-maas.html">
	    Bootstrap MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="ui/create-a-custom-image.html">
	    Create a custom image
	  </a>
	</li>
	<li>
	  <a href="ui/get-fancy-cli-output.html">
	    Get fancy CLI output
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-do-a-fresh-install-of-maas.html">
	    Do a fresh install of MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-use-availability-zones.html">
	    Use availability zones
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-use-images.html">
	  How to use images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-customise-images.html">
	    Customise images
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-deploy-a-rt-kernel-via-cloud-init.html">
	    Deploy a RT kernel
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-manage-controllers.html">
	  How to manage controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-configure-controllers.html">
	    Configure controllers
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-manage-machines.html">
	  How to manage machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-use-virtual-machines.html">
	  How to use virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-manage-virtual-machines.html">
	    Manage virtual machines
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-label-devices.html">
	  How to label devices
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-secure-maas.html">
	  How to secure MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-use-hashicorp-vault-with-maas.html">
	    Use Vault with MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-operate-maas.html">
	  How to operate MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-monitor-maas.html">
	    Monitor MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-audit-maas.html">
	    Audit MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/how-to-give-and-receive-help.html">
	  How to give and receive help
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/how-to-use-our-discourse-forum.html">
	    Use our discourse forum
	  </a>
	</li>
	<li>
	  <a href="how-to-contact-us">
	    Get support↗
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-request-new-features.html">
	    Request new features
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-review-and-report-bugs.html">
	    Review and report bugs
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-contribute-doc.html">
	    Contribute documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/general-reference.html">
	  General reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="ui/maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="ui/maas-settings-reference.html">
	    MAAS settings
	  </a>
	</li>
	<li>
	  <a href="ui/https://launchpad.net/maas.html">
	    MAAS source code↗
	  </a>
	</li>
	<li>
	  <a href="ui/how-to-help-improve-the-doc.html">
	    Doc style guide
	  </a>
	</li>
	<li>
	  <a href="ui/maas-glossary.html">
	    Glossary
	  </a>
	</li>
	<li>
	  <a href="https://ubuntu.com/community/code-of-conduct">
	    Code of conduct↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/api-reference.html">
	  API reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="ui/python-api-client-reference.html">
	    Python API client
	  </a>
	</li>
	<li>
	  <a href="api">
	    API documentation↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/maas-scripts-reference.html">
	  Scripts reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="ui/hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="ui/maas-terraform-reference.html">
	    Terraform
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/maas-logs-reference.html">
	  Log reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/event-logs-reference.html">
	    Event logs
	  </a>
	</li>
	<li>
	  <a href="ui/audit-event-logs-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="ui/commissioning-logs-reference.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="ui/testing-logs-reference.html">
	    Testing logs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/machine-parameters-reference.html">
	  Machine parameters reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/power-drivers-reference.html">
	    Power drivers
	  </a>
	</li>
	<li>
	  <a href="ui/storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="ui/device-labelling-reference.html">
	    Device labelling
	  </a>
	</li>
      </ul>
      <strong>
	<a href="ui/.html">
	  Explanation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="ui/about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="ui/about-networking.html">
	    About networking
	  </a>
	</li>
	<li>
	  <a href="ui/about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="ui/about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="ui/about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="ui/about-virtual-machines.html">
	    About virtual machines
	  </a>
	</li>
	<li>
	  <a href="ui/about-device-labels.html">
	    About device labels
	  </a>
	</li>
	<li>
	  <a href="ui/about-maas-events.html">
	    About MAAS events
	  </a>
	</li>
	<li>
	  <a href="ui/about-maas-audit-events.html">
	    About audit events
	  </a>
	</li>
	<li>
	  <a href="ui/about-maas-logging.html">
	    About MAAS logging
	  </a>
	</li>
	<li>
	  <a href="ui/about-maas-security.html">
	    About MAAS security
	  </a>
	</li>
	<li>
	  <a href="ui/about-maas-performance.html">
	    About MAAS performance
	  </a>
	</li>
	<li>
	  <a href="ui/about-ansible.html">
	    About Ansible
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>Custom image tutorial</h1><!-- "Custom image tutorial" -->
<p>When we talk about creating custom OS images for MAAS, it feels like something that&rsquo;s about to get really complex.  But with packer-maas, that&rsquo;s often not the case.</p>
<p>Let&rsquo;s see if we can&rsquo;t create and deploy a custom Ubuntu image with packer, just to see how easy it can be.</p>
<p><a href="#heading--install-maas"><h2 id="heading--install-maas">First, install MAAS</h2></a></p>
<p>If we&rsquo;re going to create custom images for MAAS, then first, we&rsquo;ll need MAAS!  You can use <a href="https://maas.io/docs/try-out-the-maas-cli">this tutorial</a><code>↗</code> to accomplish that, and get a feel for MAAS while you&rsquo;re at it.</p>
<p><a href="#heading--install-packer"><h2 id="heading--install-packer">Install packer</h2></a></p>
<p>The next step is to install the tool <code>packer</code>, which will do the heavy lifting for us.  Packer is easily installed from its Debian package:</p>
<pre><code class="language-nohighlight">sudo apt install packer
</code></pre>
<p>This should install with no additional prompts.</p>
<p><a href="#heading--install-dependencies"><h2 id="heading--install-dependencies">Install dependencies</h2></a></p>
<p>We&rsquo;re going to create a &ldquo;custom&rdquo; Ubuntu image for this build, so we&rsquo;ll want to install a few dependencies.  Enter the following commands.  Don&rsquo;t worry about any output between commands:</p>
<pre><code class="language-nohighlight">sudo apt install qemu-utils
sudo apt install qemu-system
sudo apt install ovmf
sudo apt install cloud-image-utils
</code></pre>
<p><a href="#heading--get-the-packer-templates"><h2 id="heading--get-the-packer-templates">Get the packer templates</h2></a></p>
<p>Packer uses &ldquo;templates&rdquo;, which are very much like scripts that build your custom image.  You can obtain the packer templates by cloning the <a href="https://github.com/canonical/packer-maas.git">packer-maas github repository</a><code>↗</code>, like this:</p>
<pre><code class="language-nohighlight">cd ~
mkdir -p tmp/git
cd tmp/git
git clone https://github.com/canonical/packer-maas.git
</code></pre>
<p>Make sure to pay attention to where the repository is cloned, in this case, <code>tmp/git</code> in your home directory.  The packer template in this cloned repository creates a Ubuntu AMD64 image for use with MAAS.</p>
<p><a href="#heading--build-an-image"><h2 id="heading--build-an-image">Build an Ubuntu image</h2></a></p>
<p>Now that we have that, let&rsquo;s build a custom Ubuntu image that we can deploy with MAAS.  Use these commands to do that:</p>
<pre><code class="language-nohighlight">cd ~/tmp/git/packer-maas/ubuntu
make custom-ubuntu-lvm.dd.gz
</code></pre>
<p>This <code>make</code> will run for a couple of minutes before attempting to boot the image.  While waiting for the image to boot, you will see terminal messages similar to this one for upwards of three to five minutes:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:46 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] SSH handshake err: ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] Detected authentication error. Increasing handshake attempts.
</code></pre>
<p>That&rsquo;s expected.  Eventually, you should see a successful SSH connection:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:57 packer-builder-qemu plugin: [INFO] Attempting SSH connection to 127.0.0.1:2351...
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] reconnecting to TCP connection for SSH
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:51:17 packer-builder-qemu plugin: [DEBUG] handshake complete!
</code></pre>
<p>After this, a few more commands will run.  Eventually the terminal screen will clear and show just one line, as follows:</p>
<pre><code class="language-nohighlight">rm OVMF_VARS.fd
</code></pre>
<p>That means you&rsquo;ve successfully built the image!  Just to prove it to ourselves, let&rsquo;s take a couple of additional steps.</p>
<p><a href="#heading--validate-the-build"><h2 id="heading--validate-the-build">Validate the build</h2></a></p>
<p>You can check the validity of the operation with a simple <code>ls</code> command in <code>~/tmp/git/packer-maas/ubuntu</code> (where you ran the <code>make</code> command), like this:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~/mnt/Dropbox/src/git/packer-maas/ubuntu$ ls
custom-ubuntu-lvm.dd.gz  packages      seeds-lvm.iso     user-data-lvm
http                     packer_cache  ubuntu-flat.json
Makefile                 README.md     ubuntu-lvm.json
meta-data                scripts       user-data-flat
</code></pre>
<p>See the <code>custom-ubuntu-lvm.dd.gz</code> file?  That&rsquo;s our image, ready to try out.</p>
<p><a href="#heading--upload-to-maas"><h2 id="heading--upload-to-maas">Upload the image to MAAS</h2></a></p>
<p>You can upload your newly-created image with the following command:</p>
<pre><code class="language-nohighlight">$ maas admin boot-resources create \
    name='custom/ubuntu-raw' \
    title='Ubuntu Custom RAW' \
    architecture='amd64/generic' \
    filetype='ddgz' \
    content@=custom-ubuntu-lvm.dd.gz
</code></pre>
<p><a href="#heading--deploy-your-image"><h2 id="heading--deploy-your-image">Deploy the image in MAAS</h2></a></p>
<p>What good is an image if we can&rsquo;t deploy it?  Pick one of the VMs you created in the <a href="try-out-the-maas-cli.html">last tutorial</a> and deploy your new OS image to it.  Then use a command like this one to see it running:</p>
<pre><code class="language-nohighlight">maas admin machines read | jq -r '([&quot;HOSTNAME&quot;,&quot;SYSID&quot;,&quot;POWER&quot;,&quot;STATUS&quot;,
&quot;OWNER&quot;, &quot;OS&quot;, &quot;DISTRO&quot;] | (., map(length*&quot;-&quot;))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner // &quot;-&quot;,
.osystem, .distro_series]) | @tsv' | column -t

HOSTNAME     SYSID   POWER  STATUS    OWNER  OS      DISTRO
--------     -----   -----  ------    -----  --      ------
valued-moth  e86c7h  on     Deployed  admin  ubuntu  focal
open-gannet  nk7x8y  on     Deployed  admin  custom  ubuntu-raw
</code></pre>
<p>It&rsquo;s the machine named <code>open-gannet</code> in the listing above, but your machine name and $SYSID will be unique to your instance.</p>
<p><a href="#heading--thats-all-there-is-to-it"><h2 id="heading--thats-all-there-is-to-it">That&rsquo;s all there is to it!</h2></a></p>
<p>In a few simple steps, you&rsquo;ve used packer to create a custom Ubuntu image, upload it to a running MAAS, and deploy it.  There are many different custom images that can be deployed with MAAS &ndash; check <a href="how-to-build-custom-images.html">this guide</a> to learn more.</p>
    </div>
  </body>
</html>