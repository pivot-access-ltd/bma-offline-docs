<!DOCTYPE html>
    <html>
    <body>
    <div class="container">
    <h1>How to create VM hosts</h1><!-- "How to create VM hosts" -->
<p>In order to  deploy a VM host in your MAAS network, you first need to set up a bridge to connect between your VM host and MAAS itself. Once that&rsquo;s done, you can add and manage VM hosts &ndash; and subsequently, create VMs to act as MAAS machines.  This article explains:</p>
<p>To enable VM host networking features, MAAS must match the VM host IP address of a potential VM host with a known device (a machine or controller). For example, if a machine not known to MAAS is set up as a VM host, enhanced interface selection features will not be available.</p>
<p><strong>NOTE:</strong> 
It&rsquo;s essential to enforce usage of IP addresses to avoid domain name conflicts, should different controllers resolve the same domain name with different IP addresses. You should also avoid using 127.0.0.1 when running multiple controllers, as it would confuse MAAS.</p>
<p><a href="#heading--maas-bridge-netplan"><h2 id="heading--maas-bridge-netplan">How to set up a VM host bridge with netplan</h2></a></p>
<p>You can also use netplan to configure a VM host bridge:</p>
<p>Open your netplan configuration file.  This should be in <code>/etc/netplan</code>.  It could be called <code>50-cloud-init.yaml</code>, <code>netplan.yaml</code>, or something else.  Modify the file to add a bridge, using the example below to guide you:</p>
<pre><code class="language-nohighlight">network:
    bridges:
        br0:
            addresses:
            - 10.0.0.101/24
            gateway4: 10.0.0.1
            interfaces:
            - enp1s0
            macaddress: 52:54:00:39:9d:f9
            mtu: 1500
            nameservers:
                addresses:
                - 10.0.0.2
                search:
                - maas
            parameters:
                forward-delay: 15
                stp: false
    ethernets:
        enp1s0:
            match:
                macaddress: 52:54:00:39:9d:f9
            mtu: 1500
            set-name: enp1s0
        enp2s0:
            match:
                macaddress: 52:54:00:df:87:ac
            mtu: 1500
            set-name: enp2s0
        enp3s0:
            match:
                macaddress: 52:54:00:a7:ac:46
            mtu: 1500
            set-name: enp3s0
    version: 2
</code></pre>
<p>Apply the new configuration with <code>netplan apply</code>.</p>
<p><a href="#heading--maas-bridge-libvirt"><h2 id="heading--maas-bridge-libvirt">How to set up a VM host bridge with libvirt</h2></a></p>
<p>It is also possible to use <a href="https://ubuntu.com/server/docs/virtualization-libvirt">libvirt</a> to configure a virtual bridge.  This method will also work for LXD VM hosts running on Ubuntu.  Be aware that other methods may be required if you are configuring LXD on an OS other than Ubuntu.</p>
<p>By default, libvirt creates a virtual bridge, <code>virbr0</code>, through which VMs communicate with each other and the Internet. DHCP, supplied by libvirt, automatically assigns an IP address to each VM.  However, to enable network booting in MAAS, you’ll need to provide DHCP in MAAS and either:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>Disable DHCP on libvirt’s <code>default</code> network, or</li>
<li>Create a new libvirt network <code>maas</code> with DHCP disabled.</li>
</ul>
<p>You can set up such a <code>maas</code> network like this:</p>
<pre><code class="language-nohighlight">cat &lt;&lt; EOF &gt; maas.xml
&lt;network&gt;
 &lt;name&gt;maas&lt;/name&gt;
 &lt;forward mode='nat'&gt;
   &lt;nat&gt;
     &lt;port start='1024' end='65535'/&gt;
   &lt;/nat&gt;
 &lt;/forward&gt;
 &lt;dns enable=&quot;no&quot; /&gt;
 &lt;bridge name='virbr1' stp='off' delay='0'/&gt;
 &lt;domain name='testnet'/&gt;
 &lt;ip address='172.16.99.1' netmask='255.255.255.0'&gt;
 &lt;/ip&gt;
&lt;/network&gt;
EOF
virsh net-define maas.xml
</code></pre>
<p>Note that this network also has NAT port forwarding enabled to allow VMs to communicate with the Internet at large. Port forwarding is very useful in test environments.</p>
<p><a href="#heading--set-up-ssh"><h2 id="heading--set-up-ssh">How to set up SSH for use by libvirt</h2></a></p>
<p>For MAAS to successfully communicate with libvirt on your VM host machine &ndash; whether you&rsquo;re running from snap or package, or running rack controllers in LXD containers or on localhost &ndash; this example command must succeed from every rack controller:</p>
<pre><code class="language-nohighlight">virsh -c qemu+ssh://$USER@$VM_HOST_IP/system list --all
</code></pre>
<p>Here, <code>$USER</code> is a user on your VM host who is a member of the <code>libvirtd</code> Unix group on the VM host, and <code>$VM_HOST_IP</code> is the IP of your VM host.  <strong>Note</strong> that insufficient permissions for <code>$USER</code> may cause the <code>virsh</code> command to fail with an error such as <code>failed to connect to the hypervisor</code>. Check the <code>$USER</code> group membership to make sure <code>$USER</code> is a member of the <code>libvirtd</code> group.</p>
<p><a href="#heading--adding-a-vm-host"><h2 id="heading--adding-a-vm-host">How to add a VM host</h2></a></p>
<p><strong>NOTE:</strong> 
MAAS will automatically discover and store the resources your VM host contains. Any existing machines will also appear on the &lsquo;Machines&rsquo; page, and MAAS will automatically attempt to commission them.</p>
<p><a href="#heading--configuration"><h2 id="heading--configuration">How to configure a VM host</h2></a></p>
<p><a href="#heading--lxd-clusters"><h3 id="heading--lxd-clusters">LXD clusters</h3></a></p>
    </div>
    </body>
    </html>
    