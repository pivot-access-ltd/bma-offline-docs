<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-improve-maas-security.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
      </ul>
      <strong>
	<a href="basic-tutorials.html">
	  Basic tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-bootstrap-tutorial.html">
	    MAAS bootstrap tutorial
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="custom-image-tutorial.html">
	    Custom image tutorial
	  </a>
	</li>
	<li>
	  <a href="using-jq-with-the-maas-cli.html">
	    Using jq with the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-change-maas-settings.html">
	    Change MAAS settings
	  </a>
	</li>
	<li>
	  <a href="how-to-get-help.html">
	    Ask for help
	  </a>
	</li>
	<li>
	  <a href="how-to-request-a-feature.html">
	    Request a feature
	  </a>
	</li>
	<li>
	  <a href="how-to-report-a-bug.html">
	    Report a bug
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshooting
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-acquire-images.html">
	  How to acquire images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-build-custom-images.html">
	    Build custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-tune-controllers.html">
	  How to tune controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-adjust-your-controllers.html">
	    Adjust your controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-physical-machines.html">
	  How to deploy physical machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-virtual-machines.html">
	  How to deploy virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-create-vm-hosts.html">
	    Create VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-create-and-manage-vms.html">
	    Create and manage VMs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-and-find-machines.html">
	  How to label and find machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
      </ul>
      <strong>
	How to diagnose issues
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-log-files.html">
	    Work with log files
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-audit-event-logs.html">
	    Work with audit event logs
	  </a>
	</li>
      </ul>
      <strong>
	How to work securely
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls-encryption.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
      </ul>
      <strong>
	How to operate reliably
      </strong>
      <ul>
	<li>
	  <a href="how-to-keep-maas-backed-up.html">
	    Keep MAAS backed up
	  </a>
	</li>
	<li>
	  <a href="how-to-observe-a-live-maas.html">
	    Observe a live MAAS
	  </a>
	</li>
      </ul>
      <strong>
	API reference
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href=".html">
	  Technical reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="audit-event-log-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="maas-performance.html">
	    MAAS performance
	  </a>
	</li>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-provider-reference.html">
	    Terraform provider
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to improve MAAS security</h1><!-- "How to improve MAAS security" -->
<p>As a MAAS administrator, you have the critical responsibility of hardening your installation to help repudiate attacks and malicious actors.  While there are too many variables to make meaningful suggestions for your deployed machines, there are a number of steps you can take to improve the overall security of your MASS setup.  This article provides a few suggestions.</p>
<h4>This article will help you learn:</h4>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--firewalls">How to set up a firewall for MAAS</a></li>
<li><a href="#heading--tls">How to configure a TLS-terminating load balancer</a></li>
<li><a href="#heading--using-logs-for-security">How to use logs to identify security issues</a></li>
<li><a href="#heading--postgres-security">How to implement PostgreSQL security</a></li>
<li><a href="#heading--what-else-to-do">About other things you can do to harden MAAS</a></li>
<li><a href="#heading--security-consulting">Whom to contact for MAAS security consulting</a></li>
</ul>
<p><a href="#heading--firewalls"><h2 id="heading--firewalls">How to set up a firewall for MAAS</h2></a></p>
<p>Each rack controller must be able to initiate TCP connections on the following ports:</p>
<table>
<thead>
<tr>
<th>Port(s)</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>5240</code></td>
<td>HTTP communication with each region controller. Note that port <code>80</code> is typically used in high-availability environments.
</tr>
<tr>
<td>
<code>5241</code> - <code>5247</code>
</td>
<td>Reserved for internal MAAS services.</td>
</tr>
<tr>
<td><code>5248</code></td>
<td>Reserved for rack HTTP communication.</td>
</tr>
<tr>
<td>
<code>5250</code> - <code>5270</code>
</td>
<td>Reserved for region workers (RPC).</td>
</tr>
</tbody>
</table>

<p>Consider setting your <a href="https://help.ubuntu.com/lts/serverguide/firewall.html#firewall-logs">firewall </a> on your rack and region controllers to disallow communication on all ports except those used by MAAS. For example, assuming you have installed <code>ufw</code>, you could execute:</p>
<pre><code>sudo ufw enable
sudo ufw default deny incoming
</code></pre>
<p>You could then follow that with commands similar to these:</p>
<pre><code>sudo ufw allow 5240
sudo ufw allow 5248
sudo ufw allow 5241:5247/tcp
sudo ufw allow 5241:5247/udp
sudo ufw allow 5250:5270/tcp
sudo ufw allow 5250:5270/udp
</code></pre>
<p>Recognise that your particular configuration and version may vary, so consult the appropriate firewall manual pages for your specific MAAS host system.</p>
<p><a href="#heading--tls"><h2 id="heading--tls">How to configure a TLS-terminating load balancer</h2></a></p>
<p>One of the best steps you can take to improve both security and availability of your MAAS installation is to install TLS-terminating load balancer.  For MAAS, we recommend using <a href="https://www.haproxy.com">HAProxy </a>.  This section explains how to set one up.</p>
<p><details><summary>What is a TLS-terminated load balancer?</summary></p>
<p>In the context of MAAS, a <a href="https://www.nginx.com/resources/glossary/load-balancing/">load balancer </a> distributes the incoming Web UI and API requests across multiple region controllers.  This reduces both load on MAAS and wait times for user requests.  Typically, this is known as a high-availability (HA) configuration, although there are two other <a href="how-to-enable-high-availability.html">HA configurations</a> that can be enabled for MAAS: one for BMC access (for powering on machines), and one for DHCP, which enables primary and secondary DHCP instances that manage the same VLAN.</p>
<p>A TLS-terminated load balancer is a load balancer that carries encryption and decryption as far down the pipe as possible, in this case, all the way to the load balancer itself. Note that, even though the &ldquo;SSL&rdquo; keyword may be used to enable operation, the term SSL is considered obsolete.  Hence we choose to use the term &ldquo;TLS&rdquo; instead, referring to <strong>Transport Layer Security</strong>.</p>
<p>TLS is meant to provide privacy and data integrity between two or more applications.  Privacy is provided by <a href="https://en.wikipedia.org/wiki/Symmetric-key_algorithm">symmetric cryptography </a>, based on a shared secret and uniquely-generated keys negotiated at the start of a session (during the <a href="https://en.wikipedia.org/wiki/Transport_Layer_Security#TLS_handshake">TLS handshake </a>).  Identity of each app can be authenticated, though this feature can be optional.  Authenticity of messages is ensured by using <a href="https://en.wikipedia.org/wiki/Message_authentication_code">message authentication codes </a> to detect tampering.</p>
<p></details></p>
<p><a href="#heading--pem-file"><h3 id="heading--pem-file">PEM file</h3></a></p>
<p>As a first step, you&rsquo;ll need an SSL certificate (<code>mysite.com.crt</code>) with a key pair (<code>mysite.com.key</code>), combined into a PEM file:</p>
<pre><code>cat mysite.com.crt mysite.com.key &gt; mysite.com.pem
sudo cp mysite.com.pem /etc/ssl/private/
</code></pre>
<p>Depending upon your chosen certificate authority, you may also need to copy your CA root certificate and one or more intermediate CA certificates into the same PEM file.</p>
<p><a href="#heading--install-ha-proxy"><h3 id="heading--install-ha-proxy">Install and configure HA proxy</h3></a></p>
<p>To install HAProxy, execute the following commands:</p>
<pre><code>sudo apt-get update
sudo apt-get install haproxy
</code></pre>
<p>Next, edit <code>/etc/haproxy/haproxy.cfg</code> as follows.  In the <code>global</code> section of the file, add this line:</p>
<pre><code>maxconn &lt;number of concurrent connections&gt;
</code></pre>
<p>Be aware that there&rsquo;s a balance between accepting many connections and overloading the API by trying to serve too many requests.  Also, you should consider adding a line like this one to the same section:</p>
<pre><code>tune.ssl.default-dh-param 2048
</code></pre>
<p>This parameter configures the maximum size of temporary DHE keys that are generated.</p>
<p>Next, in the <code>defaults</code> section, add the following lines under <code>mode http</code>:</p>
<pre><code>option forwardfor
option http-server-close
</code></pre>
<p>The option <code>forwardfor</code> tells HAProxy to add X-Forward-For headers to each request.  The <code>http-server-close</code> option reduces latency between HAProxy and your users by closing connections but maintaining a keep-alive.</p>
<p>Finally, you&rsquo;ll set the frontend and backend parameters that define the connections between HAProxy and MAAS.  For the frontend, you can set parameters this way:</p>
<pre><code>frontend maas
    bind *:443 ssl crt /etc/ssl/private/mysite.com.pem
    reqadd X-Forwarded-Proto:\ https
    retries 3
    option redispatch
    default_backend maas
</code></pre>
<p>This stanza defines a frontend name <code>maas</code>; tells HAProxy to handle incoming traffic to port 443, providing SSL encryption, enabled by the certificates and keys you earlier concatenated into your PEM file; allows three retries and redispatch; and forwards these requests to <code>maas</code> as the backend server, which is defined something like this:</p>
<pre><code>backend maas
    timeout server 90s
    balance source
    hash-type consistent
    server localhost localhost:5240 check
    server maas-api-1 &lt;ip-address-of-a-region-controller&gt;:5240 check
    server maas-api-2 &lt;ip-address-of-another-region-controller&gt;:5240 check
</code></pre>
<p>This stanza defines a backend server group named <code>maas</code>; sets consistent hashing, 90 second timeout, and balanced sources; sets the server address and port (<code>localhost:5240</code>); and engages two region controllers, named <code>maas-api-1</code> and <code>maas-api-2</code>.  Note that the &ldquo;1&rdquo; and &ldquo;2&rdquo; designations are completely arbitrary, as there is no sense of &ldquo;primary&rdquo; or &ldquo;secondary&rdquo; associated with this configuration.</p>
<p>Finally, restart the (already-running) load balancer so that these changes can take effect and the HAProxy will begin to forward requests:</p>
<pre><code>sudo systemctl restart haproxy
</code></pre>
<p>Note that you can also <a href="https://www.digitalocean.com/community/tutorials/how-to-implement-ssl-termination-with-haproxy-on-ubuntu-14-04">enable HAProxy logging </a> if desired.  This logging is an optional feature of the HAProxy tool and is thus left to your discretion.  </p>
<p>If desired, you can <a href="how-to-enable-high-availability.html#heading--load-balancing-with-haproxy-optional">bypass the use of SSL</a> in your HAProxy.  Alternatively, you can <a href="how-to-enable-tls-encryption.html">set up TLS encryption on your MAAS web UI</a> without implementing HAProxy.</p>
<p><a href="#heading--using-logs-for-security"><h2 id="heading--using-logs-for-security">How to use logs to identify security issues</h2></a></p>
<p>There are four categories of log files that you can use to help identify security issues:</p>
<ol>
<li>firewall logs</li>
<li>Web server logs</li>
<li>MAAS log files</li>
<li>system log files</li>
</ol>
<p>This section will offer some advice, as well as links to more detailed information on these categories.</p>
<p><a href="#heading--firewall-logs-subsection"><h3 id="heading--firewall-logs-subsection">Firewall logs</h3></a></p>
<p>The Ubuntu firewall, <a href="https://wiki.ubuntu.com/UncomplicatedFirewall">UFW </a>, is a front-end for <a href="https://help.ubuntu.com/community/IptablesHowTo">iptables </a>, so the UFW log output is very similar to what you&rsquo;ll encounter in iptables itself.  If you want to secure your MAAS installation, it&rsquo;s very important to periodically review your UFW logs, found in <code>/var/log/ufw*</code>.</p>
<p>Learning to recognise issues in the UFW/iptables log is an art form, so we&rsquo;re not going to give an extended tutorial here.  Still, there are some key indicators that might help you spot security issues.</p>
<p>You might look for something probing a port that&rsquo;s not supporting an application service.  Attackers use port scanners to look for openings.  You might see entries like these:</p>
<pre><code>blocked incoming tcp connection request from 96.39.208.43:8240 to 128.17.92.85:6002
blocked incoming tcp connection request from 96.39.208.43:8240 to 128.17.92.85:6003
blocked incoming tcp connection request from 96.39.208.43:8240 to 128.17.92.85:6004
</code></pre>
<p>You can also compare attempts on unusual port numbers against <a href="http://www.relevanttechnologies.com/resources_4.asp">well-known hacker tools </a>.  For instance, repeated attempts against port 12361 might mean that someone is attempting to attack with the Whack-a-mole exploit.</p>
<p>Also suspicious are repeated, unsuccessful access attempts, against the same port or service, from the same domain, IP address, or subnet. These attempts may be spread out in time (<code>grep</code> is your friend, here).  For example, a group of login attempts that look like this may indicate that an attacker is trying to disguise port scans by switching IP addresses within a block of addresses available to them:</p>
<pre><code>blocked incoming tcp connection request from 96.39.208.43:49343 to 64.242.119.18:31337
blocked incoming tcp connection request from 96.39.208.62:49343 to 64.242.119.18:31337
blocked incoming tcp connection request from 96.39.209.243:49343 to 64.242.119.18:31337
blocked incoming tcp connection request from 96.39.208.135:49343 to 64.242.119.18:31337
.
.
.
blocked incoming tcp connection request from 96.39.208.208:49343 to 64.242.119.18:31337
</code></pre>
<p>Watch out for suspicious messages or connections originating inside your network, which may indicate that you have a Trojan residing inside your UFW:</p>
<pre><code>blocked outgoing tcp packet from 192.168.23.100:5240 to 96.38.231.18:443 as FIN:ACK received, but there is no active connection.
</code></pre>
<p>This message will usually be repeated a number of times, since Trojans are fairly persistent.</p>
<p>Look for source-routed packets, that is, packets with a source address internal to your network, but which originate from outside your network, indicating that someone is trying to spoof one of your internal addresses.</p>
<p>Review the IP addresses that are being rejected and dropped.  Try to identify them with a <code>ping -a &lt;IP address&gt;</code>.  Spoofed addresses won&rsquo;t have an owner (and you can block them).  Real addresses have a <a href="http://www.internic.net/whois.html">whois </a> entry, so it&rsquo;s possible you can contact the ISP to report and resolve this issue.</p>
<p>There are many other firewall log analysis techniques, and a number of good open-source and commercial log analysis programs.  If you decide to analyse directly, though, you&rsquo;re basically looking for blocked connection issues, connections to (potentially) open ports you&rsquo;re not using, and suspicious-looking outbound connections.</p>
<p><a href="#heading--web-server-logs-subsection"><h3 id="heading--web-server-logs-subsection">Web server logs</h3></a></p>
<p>Detecting malicious activity directed toward your Web server is best done with a log analysis tool.  If you want to review the raw logs directly, you can look for them in two places:</p>
<ol>
<li>
<p><code>/var/log/httpd/</code>, <code>/var/log/apache</code>, or <code>/var/log/apache2</code> (in the case of Apache), or</p>
</li>
<li>
<p>the path given in <code>/etc/nginx/nginx.conf</code> or given in your site configuration file, which itself is found at the path <code>/etc/nginx/sites-available</code> (in the case of nginx &ndash; look for the <code>access_log</code> directive).</p>
</li>
</ol>
<p>Web server log analysis is also an art form, so we don&rsquo;t plan to offer a comprehensive tutorial here, but here are few examples of things to look for in your logs:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>
<p>multiple requests in less than one second, or some other appropriate time-frame.</p>
</li>
<li>
<p>multiple secure/login page accesses in a one-minute window, especially when they fail.</p>
</li>
<li>
<p>attempts to access non-existent pages using different paths or query parameters (e.g., <code>135.25.48.19:5250/maas/index.html</code>).</p>
</li>
<li>
<p>look out for SQL injection attacks, for example:</p>
<p>84.55.41.57- - [14/Apr/2016:08:22:13 0100]
&ldquo;GET /wordpress/wp-content/plugins/custom_plugin/check_user.php?userid=1 
AND (SELECT 6810 FROM(SELECT COUNT(<em>),CONCAT(0x7171787671,(SELECT 
(ELT(6810=6810,1))),0x71707a7871,FLOOR(RAND(0)</em>2))x FROM 
INFORMATION_SCHEMA.CHARACTER_SETS GROUP BY x)a) HTTP/1.1&rdquo; 200 166 &ldquo;-&ldquo; &ldquo;Mozilla/5.0 
(Windows; U; Windows NT 6.1; ru; rv:1.9.2.3) Gecko/20100401 Firefox/4.0 (.NET CLR 
3.5.30729)&rdquo;</p>
</li>
<li>
<p>attempts to run a Web shell, for instance:</p>
<p>192.168.1.102 29/Oct/2018:14:52:16 GET /b374k.php HTTP/1.1 200 2125 Mozilla/5.0</p>
</li>
</ul>
<p>As mentioned above, there are a large number of Web server exploits, and this document does not propose to enumerate them all.  If you want to ensure secure operation, though, it&rsquo;s useful to familiarise yourself with these kinds of Web server attacks.</p>
<p><a href="#heading--maas-log-file-subsection"><h3 id="heading--maas-log-file-subsection">MAAS log files</h3></a></p>
<pre><code>2020-03-31 21:17:56 regiond: [info] 10.132.172.1 GET /MAAS/accounts/login/ HTTP/1.1
--&gt; 200 OK (referrer: http://10.132.172.231:5240/MAAS/r/; agent: Mozilla/5.0 (X11;
Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149
Safari/537.36)````
</code></pre>
<p>If a login fails due to bad input (username/password), the regiond log will contain an entry something like this one:</p>
<pre><code>2020-03-31 21:18:08 regiond: [info] 10.132.172.1 POST /MAAS/accounts/login/ HTTP/1.1
--&gt; 400 BAD_REQUEST (referrer: http://10.132.172.231:5240/MAAS/r/; agent:
Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/80.0.3987.149 Safari/537.36)````
</code></pre>
<p>An entry like this one would also be suspect, since it involves omitting username/password entries at the login prompt:</p>
<pre><code>2020-03-31 21:18:45 regiond: [info] 10.132.172.1 POST /MAAS/accounts/login/ HTTP/1.1
--&gt; 204 NO_CONTENT (referrer: http://10.132.172.231:5240/MAAS/r/; agent: Mozilla/5.0
(X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/80.0.3987.149
Safari/537.36)````
</code></pre>
<p>The key differentiator to distinguish problems from routine failures is the frequency.  If you notice a lot of these last two entries in a given period of time, you may want to investigate more thoroughly.</p>
<p><a href="#heading--system-log-file-subsection"><h3 id="heading--system-log-file-subsection">System log files</h3></a></p>
<p>You can also use the standard system logs to detect malicious activity, though this subject is largely beyond the scope of this document.  As a simple example, consider using <code>journalctl</code> to detect and source an SSH brute force attack:</p>
<pre><code>[root@maasserver ~]# journalctl -u sshd | grep "Failed password"
Jun 06 13:45:19 router sshd[2487]: Failed password for root from 234.19.184.6 port 42258 ssh2
Jun 06 13:45:24 router sshd[2487]: Failed password for root from 234.19.184.6 port 42258 ssh2
Jun 06 13:45:35 router sshd[2487]: Failed password for root from 234.19.184.6 port 38834 ssh2
Jun 06 13:45:48 router sshd[2487]: Failed password for root from 234.19.184.6 port 35444 ssh2
</code></pre>
<p>From here, you can either use <code>whois</code> to locate the attacker and work with the ISP to block them, or simply use your UFW firewall to block them directly.</p>
<p>As mentioned, this subject is far too complex for a detailed tutorial in this section.  For more information, try the <a href="https://manpages.ubuntu.com/manpages/journalctl.1.html">Ubuntu journalctl manpage</a> or <a href="https://www.digitalocean.com/community/tutorials/how-to-use-journalctl-to-view-and-manipulate-systemd-logs">another, similar source </a>.  </p>
<p><a href="#heading--postgres-security"><h2 id="heading--postgres-security">How to implement PostgreSQL security</h2></a></p>
<p>PostgreSQL contains secrets, and should be encrypted for maximum protection.  You should consider <a href="https://help.ubuntu.com/community/Full_Disk_Encryption_Howto_2019">full disk encryption </a>.  Also recommended is <a href="https://www.postgresql.org/docs/current/ssl-tcp.html">TLS encryption between MAAS and PostgreSQL </a>.</p>
<p><a href="#heading--what-else-to-do"><h2 id="heading--what-else-to-do">About other things you can do to harden MAAS</h2></a></p>
<p>In addition to the items mentioned above, you should be aware of a few other points about hardening MAAS.</p>
<p><a href="#heading--maas-and-root-users"><h3 id="heading--maas-and-root-users">Good passwords</h2></a></p>
<p>You should pick good passwords and store them securely (e.g. in a KeePassX password database). Perform user administration only via the web UI. Only share the <code>maas</code> and <code>root</code> user passwords with administrators.</p>
<p><a href="#heading--conf-file-permissions"><h3 id="heading--conf-file-permissions">File permissions</h2></a></p>
<p>MAAS configuration files should be set to have permission <code>640</code>: readable by logins belonging to the <code>maas</code> group and writeable only by the <code>root</code> user. Currently, the <code>regiond.conf</code> file contains the login credentials for the PostgreSQL database used by MAAS to keep track of all machines, networks, and configuration.</p>
<p><a href="#heading--shared-secrets"><h3 id="heading--shared-secrets">Shared secrets</h2></a></p>
<p>When you add a new rack or region controller, MAAS asks for a shared secret it will use to communicate with the rest of MAAS. This secret is also exposed in the web UI when you click the &lsquo;Add rack controller&rsquo; button on the Controllers page.  MAAS automatically generates this secret when your first region controller installed, and stores the secret in a plain text file.  This file is automatically protected with the correct permissions, so there is no need for any action on your part.</p>
<p><a href="#heading--security-consulting"><h2 id="heading--security-consulting">Whom to contact for MAAS security consulting</h2></a></p>
<p>If you need help implementing MAAS security, please <a href="how-to-contact-us.html">contact us</a>.  We will be happy to assist you in arranging security consulting appropriate to your needs.</p>
    </div>
  </body>
</html>