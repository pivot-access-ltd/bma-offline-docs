<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <a href="../maas-vanilla/maas-communication-783.html" style="border-top:1px solid black; border-left:1px solid black; border-right:1px solid black;">
	Full
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <a href="../maas-ui-only/maas-communication-783.html" style="border-top:1px solid black; border-left:1px solid black; border-right:1px solid black;">
	UI-only
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <strong>
	<a href="../maas-cli-only/maas-communication-783.html" style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;align:center;">
	  &nbsp;CLI-only&nbsp;
	</a>
      </strong>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas-840.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="give-me-an-example-of-maas-1314.html">
	    &ldquo;Give me an example&rdquo;
	  </a>
	</li>
	<li>
	  <a href="explore-maas-787.html">
	    Explore MAAS
	  </a>
	</li>
	<li>
	  <a href="whats-new-in-maas-2-8-1655.html">
	    What&rsquo;s new in 2.8
	  </a>
	</li>
	<li>
	  <a href="https://maas.io/install">
	    Quick start
	  </a>
	</li>
      </ul>
      <strong>Installing MAAS
      </strong>
      <ul>
	<li>
	  <a href="maas-requirements-789.html">
	    Requirements
	  </a>
	</li>
	<li>
	  <a href="maas-installation-from-a-snap-773.html">
	    Installation
	  </a>
	</li>
	<li>
	  <a href="configuration-journey-781.html">
	    Configuration journey
	  </a>
	</li>
	<li>
	  <a href="installation-and-configuration-checklist-750.html">
	    Setup checklist
	  </a>
	</li>
      </ul>
      <strong>
	<a href="introduction-to-controllers-786.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-communication-783.html">
	    Communication
	  </a>
	</li>
	<li>
	  <a href="rack-controllers-771.html">
	    Rack controllers
	  </a>
	</li>
	<li>
	  <a href="region-controllers-772.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="high-availability-804.html">
	    High availability
	  </a>
	</li>
      </ul>
      <strong>
	<a href="introduction-to-machines-829.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="add-machines-821.html">
	    Add machines
	  </a>
	</li>
	<li>
	  <a href="power-management-830.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commission-machines-822.html">
	    Commission machines
	  </a>
	</li>
	<li>Testing
	</li>
	<li>
	  <a href="hardware-testing-826.html">
	    Hardware testing
	  </a>
	</li>
	<li>
	  <a href="network-testing-1267.html">
	    Network testing
	  </a>
	</li>
	<li>
	  <a href="commissioning-and-hardware-testing-scripts-833.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="deploy-machines-825.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="maas-tags-834.html">
	    Tags
	  </a>
	</li>
	<li>
	  <a href="custom-machine-setup-824.html">
	    Custom machine setup
	  </a>
	</li>
	<li>
	  <a href="kernel-boot-options-827.html">
	    Kernel boot options
	  </a>
	</li>
	<li>
	  <a href="resource-pools-831.html">
	    Resource pools
	  </a>
	</li>
	<li>
	  <a href="storage-775.html">
	    Storage
	  </a>
	</li>
	<li>
	  <a href="vmware-vmfs-datastores-780.html">
	    VMware VMFS datastores
	  </a>
	</li>
	<li>
	  <a href="ubuntu-kernels-828.html">
	    Ubuntu kernels
	  </a>
	</li>
      </ul>
      <strong>
	<a href="images-754.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="select-and-import-images-751.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="local-image-mirror-752.html">
	    Local image mirror
	  </a>
	</li>
	<li>
	  <a href="vmware-images-753.html">
	    VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="networking-768.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="subnet-management-766.html">
	    Subnet management
	  </a>
	</li>
	<li>
	  <a href="managing-dhcp-759.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="ip-ranges-760.html">
	    IP ranges
	  </a>
	</li>
	<li>
	  <a href="proxy-763.html">
	    Proxy
	  </a>
	</li>
	<li>
	  <a href="ntp-services-762.html">
	    NTP
	  </a>
	</li>
	<li>
	  <a href="network-discovery-758.html">
	    Network discovery
	  </a>
	</li>
	<li>
	  <a href="ipv6-addressing-761.html">
	    IPv6
	  </a>
	</li>
	<li>
	  <a href="configuring-tls-encryption-764.html">
	    SSL
	  </a>
	</li>
	<li>
	  <a href="managing-stp-765.html">
	    STP
	  </a>
	</li>
	<li>
	  <a href="availability-zones-820.html">
	    Availability zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="introduction-to-vm-hosting-1524.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="vm-host-networking-1526.html">
	    VM host networking
	  </a>
	</li>
	<li>
	  <a href="adding-a-vm-host-1549.html">
	    Add a VM host
	  </a>
	</li>
	<li>
	  <a href="vm-host-storage-pools-1525.html">
	    VM host storage pools
	  </a>
	</li>
	<li>
	  <a href="creating-and-deleting-vms-806.html">
	    Creating and deleting VMs
	  </a>
	</li>
      </ul>
      <strong>Operations
      </strong>
      <ul>
	<li>
	  <a href="prometheus-metrics-813.html">
	    Prometheus metrics
	  </a>
	</li>
	<li>
	  <a href="backup-792.html">
	    Backup
	  </a>
	</li>
	<li>
	  <a href="hardening-your-maas-installation-1381.html">
	    MAAS security
	  </a>
	</li>
	<li>
	  <a href="maas-logging-1468.html">
	    Logging
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs-1478.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="user-accounts-790.html">
	    User accounts
	  </a>
	</li>
	<li>
	  <a href="interactive-search-819.html">
	    Interactive search
	  </a>
	</li>
      </ul>
      <strong>
	<a href="concepts-and-terms-785.html">
	  Concepts &amp; terms
	</a>
      </strong>
      <ul>
	<li>
	  <a href="concepts-and-terms-785.html#heading--network-tutorial">
	    Brief network tutorial
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-cli-802.html">
	  CLI
	</a>
      </strong>
      <ul>
	<li>
	  <a href="common-cli-tasks-794.html">
	    Common tasks
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs-791.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="cli-kernel-management-799.html">
	    Kernel management
	  </a>
	</li>
	<li>
	  <a href="cli-image-management-797.html">
	    Image management
	  </a>
	</li>
	<li>
	  <a href="cli-interface-management-798.html">
	    Interface management
	  </a>
	</li>
	<li>
	  <a href="cli-tag-management-801.html">
	    Tag management
	  </a>
	</li>
	<li>
	  <a href="cli-resource-pool-management-800.html">
	    Resource pool management
	  </a>
	</li>
	<li>
	  <a href="cli-dhcp-snippet-management-796.html">
	    DHCP snippet management
	  </a>
	</li>
	<li>
	  <a href="cli-commissioning-and-hardware-testing-scripts-832.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="cli-advanced-tasks-793.html">
	    Advanced tasks
	  </a>
	</li>
	<li>
	  <a href="cli-composable-hardware-795.html">
	    Composable hardware
	  </a>
	</li>
	<li>
	  <a href="python-api-client-810.html">
	    API client
	  </a>
	</li>
      </ul>
      <strong>
	<a href="https://maas.io/docs/api">
	  API documentation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-742.html">
	    API authentication
	  </a>
	</li>
      </ul>
      <strong>
	<a href="troubleshooting-837.html">
	  Troubleshoot
	</a>
      </strong>
      <ul>
	<li>
	  <a href="getting-help-838.html">
	    Getting help
	  </a>
	</li>
	<li>
	  <a href="tips-tricks-and-traps-1506.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="https://old-docs.maas.io/2.5/en/">
	    MAAS 2.5 (+ earlier) doc
	  </a>
	</li>
      </ul>
      <strong>
	<a href="whats-new-in-maas-2-8-1655.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="writing-guide-747.html">
	  Help improve these docs
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>MAAS communication</h1><p>MAAS communication happens in a strict hierarchy, flowing from the UI/API through the region controller, to the rack controller, to the machines (and back).  While <a href="high-availability-804.html">high availability</a> (HA) may add controllers, it does not change the flow of communication through the MAAS system.  Understanding this message flow may help you with the machine topics which follow.</p>
<h4>Quick questions you might have:</h4>
<ul>
<li><a href="maas-communication-783.html#heading--machinerack">How do machines communicate with the rack controller?</a></li>
<li><a href="maas-communication-783.html#heading--rackregion">How do rack and region controllers communicate?</a></li>
<li><a href="hardening-your-maas-installation-1381.html#heading--firewalls">What are rack controller port requirements?</a></li>
</ul>
<h2 id="heading--machinerack">How machines communicate with the rack controller</h2>

<p>All machine communication with MAAS is proxied through rack controllers, including HTTP metadata, DNS, syslog and APT (cache-and-forward proxies via Squid). </p>
<p>MAAS creates an internal DNS domain, not manageable by the user, and a unique DNS resource for each subnet that is managed by MAAS. Each subnet includes all rack controllers that have an IP on that subnet. Booting machines use the subnet DNS resource to resolve the rack controller available for communication. If multiple rack controllers belong to the same subnet, MAAS uses a round-robin algorithm to balance the load across numerous rack controllers. This arrangement ensures that machines always have a rack controller.</p>
<p>Machines use this internal domain for HTTP metadata queries, APT (proxying via Squid), and Syslog. DNS queries, PXE booting, and NTP polls use IP addresses.</p>
<p>The rack controller installs and configures <code>bind</code> as a forwarder. All machines communicate via the rack controller directly.</p>
<p>[note]
Zone management and maintenance still happen within the region controller.
[/note]</p>
<h2 id="heading--rackregion">How region and rack controllers communicate</h2>

<p>The MAAS region and rack controllers interact in a number of different ways, depending upon the operation you&rsquo;ve requested.  Consider the process of commissioning a machine, that is, taking over the machine and gathering information on its available resources, including CPU, RAM, storage, and MIB information (obtainable via LLDP requests).  Here&rsquo;s a rough idea of what that sequence looks like &ndash; a sequence that is representative of the communication between rack and region controllers:</p>
<ol>
<li>An operator makes a request of MAAS, either via the Web UI or the API.  </li>
<li>MAAS translates this to an API request to the region controller.</li>
<li>The region controller locates the rack controller that has BMC access to the machine in question, that is, the rack controller that can power on that machine.</li>
<li>That same rack controller powers on the machine via IPMI request.</li>
<li>The rack controller tasked with providing DHCP handles assigning an IP address to the machine via the <a href="concepts-and-terms-785.html#heading--dhcp">DORA</a> sequence (Discover, Offer, Request, Acknowledge).  <strong>Note</strong> that this rack controller doesnt have to be the same one that powers on the machine.</li>
<li>The DHCP-managing rack controller inserts itself as the DHCP &ldquo;next-server&rdquo; and requests a network boot.</li>
<li>(Still) the same rack controller RPCs the region controller to get what&rsquo;s needed to boot an ephemeral Ubuntu kernel, namely the kernel, any kernel parameters, an initrd daemon, and a squashfs load.</li>
<li>That same rack controller transforms the RPC response from the region controller into a valid PXE config and tells the machine to come get its files.</li>
<li>The booting machine loads the kernel and initrd, boots with that initrd, and then loads the squashfs, eventually making its way up to an ephemeral Ubuntu instance.</li>
<li>The booted machine pulls cloud-init metadata from the region controller, proxying through the rackd.</li>
<li>cloud-init uses this metadata to gather resource information about the machine and pass it back to the region controller, again proxied by the rackd.</li>
<li>The region controller (regiond or &ldquo;region daemon&rdquo;) stores this machine information in a postgres database that is accessible only to the regiond, making MAAS truly stateless with respect to machines.</li>
</ol>
<p>Again, this list doesn&rsquo;t represent every interaction between the controllers and machines, but it gives you a good idea of how MAAS works.</p>
<p><details><summary>Tell me about the DHCP &ldquo;next-server&rdquo; statement</summary></p>
<p>The <code>next-server</code> directive is used to specify the host address from which an initial boot file is to be loaded, usually a TFTP server.  In the case of MAAS, the rack controller providing DHCP actually inserts itself, since it can proxy (broker) the delivery of boot bits to the machine in question.
</details></p>
    </div>
  </body>
</html>