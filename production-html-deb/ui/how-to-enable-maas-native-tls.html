<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;
      <strong>Offline docs
      </strong>
      <a href="https://maas.io/docs">(switch to live docs)
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  UI-only
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-enable-maas-native-tls.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong> 
      <strong>
	<a href="tutorials.html">
	  Tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="bootstrap-maas.html">
	    Bootstrap MAAS
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="create-a-custom-image.html">
	    Create a custom image
	  </a>
	</li>
	<li>
	  <a href="get-fancy-cli-output.html">
	    Get fancy CLI output
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-do-a-fresh-install-of-maas.html">
	    Do a fresh install of MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-availability-zones.html">
	    Use availability zones
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-images.html">
	  How to use images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-images.html">
	    Customise images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-a-real-time-kernel.html">
	    Deploy a RT kernel
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-controllers.html">
	  How to manage controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-configure-controllers.html">
	    Configure controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-machines.html">
	  How to manage machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-virtual-machines.html">
	  How to use virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-virtual-machines.html">
	    Manage virtual machines
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-devices.html">
	  How to label devices
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-secure-maas.html">
	  How to secure MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-hashicorp-vault-with-maas.html">
	    Use Vault with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-operate-maas.html">
	  How to operate MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
	<li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-monitor-maas.html">
	    Monitor MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-audit-maas.html">
	    Audit MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-give-and-receive-help.html">
	  How to give and receive help
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-our-discourse-forum.html">
	    Use our discourse forum
	  </a>
	</li>
	<li>
	  <a href="how-to-contact-us">
	    Get support↗
	  </a>
	</li>
	<li>
	  <a href="how-to-request-new-features.html">
	    Request new features
	  </a>
	</li>
	<li>
	  <a href="how-to-review-and-report-bugs.html">
	    Review and report bugs
	  </a>
	</li>
	<li>
	  <a href="how-to-contribute-doc.html">
	    Contribute documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="general-reference.html">
	  General reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-settings-reference.html">
	    MAAS settings
	  </a>
	</li>
	<li>
	  <a href="https://launchpad.net/maas.html">
	    MAAS source code↗
	  </a>
	</li>
	<li>
	  <a href="how-to-help-improve-the-doc.html">
	    Doc style guide
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
	<li>
	  <a href="https://ubuntu.com/community/code-of-conduct">
	    Code of conduct↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api-reference.html">
	  API reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    Python API client
	  </a>
	</li>
	<li>
	  <a href="api">
	    API documentation↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-scripts-reference.html">
	  Scripts reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-reference.html">
	    Terraform
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-logs-reference.html">
	  Log reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="event-logs-reference.html">
	    Event logs
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs-reference.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="testing-logs-reference.html">
	    Testing logs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machine-parameters-reference.html">
	  Machine parameters reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="power-drivers-reference.html">
	    Power drivers
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="device-labelling-reference.html">
	    Device labelling
	  </a>
	</li>
      </ul>
      <strong>
	<a href=".html">
	  Explanation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="about-networking.html">
	    About networking
	  </a>
	</li>
	<li>
	  <a href="about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="about-virtual-machines.html">
	    About virtual machines
	  </a>
	</li>
	<li>
	  <a href="about-device-labels.html">
	    About device labels
	  </a>
	</li>
	<li>
	  <a href="about-maas-events.html">
	    About MAAS events
	  </a>
	</li>
	<li>
	  <a href="about-maas-audit-events.html">
	    About audit events
	  </a>
	</li>
	<li>
	  <a href="about-maas-logging.html">
	    About MAAS logging
	  </a>
	</li>
	<li>
	  <a href="about-maas-security.html">
	    About MAAS security
	  </a>
	</li>
	<li>
	  <a href="about-maas-performance.html">
	    About MAAS performance
	  </a>
	</li>
	<li>
	  <a href="about-ansible.html">
	    About Ansible
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>How to enable MAAS native TLS encryption</h1><!-- "How to enable MAAS native TLS encryption" -->

<p>TLS can be enabled/disabled with the new <code>maas config-tls</code> command:</p>
<pre><code class="language-nohighlight">usage: maas config-tls [-h] COMMAND ...

Configure MAAS Region TLS.

optional arguments:
  -h, --help  show this help message and exit

drill down:
  COMMAND
    enable    Enable TLS and switch to a secured mode (https).
    disable   Disable TLS and switch to a non-secured mode (http).

the following arguments are required: COMMAND
</code></pre>
<p><a href="#heading--how-to-enable-tls"><h3 id="heading--how-to-enable-tls">How to enable TLS</h3></a></p>
<p>To enable TLS in MAAS, a private key and a X509 certificate containing the corresponding public key are required. Both key and certificate must be encoded in PEM format.</p>
<pre><code class="language-nohighlight">usage: maas config-tls enable [-h] [--cacert CACERT] [-p PORT] key cert

positional arguments:
  key                   path to the private key
  cert                  path to certificate in PEM format

optional arguments:
  -h, --help            show this help message and exit
  --cacert CACERT       path to CA certificates chain in PEM format (default: None)
  -p PORT, --port PORT  HTTPS port (default: 5443)

the following arguments are required: key, cert
</code></pre>
<p>By default, the port for HTTPS traffic will be 5443. It’s possible to specify a different one via the <code>–port</code> option.  If your certificate is not self-signed, you can pass a cacert.pem, so that the full chain will be included in the certificate served by MAAS.</p>
<p>If you have HA setup, please note that every MAAS instance will use the same certificate, so you need to create one certificate with multiple domain names or IP addresses; for example:</p>
<pre><code class="language-nohighlight">X509v3 Subject Alternative Name:
                DNS:example.com, IP Address:10.211.55.9
</code></pre>
<p><a href="#heading--how-to-disable-tls"><h3 id="heading--how-to-disable-tls">How to disable TLS</h3></a></p>
<p>If for some reason you want to disable TLS, you can do it using the following command:</p>
<pre><code class="language-nohighlight">usage: maas config-tls disable [-h]

optional arguments:
  -h, --help  show this help message and exit
</code></pre>
<p>After this, MAAS API and UI will be again reachable on port 5240, over plain HTTP.</p>
<p><a href="#heading--using-the-cli-with-a-tls-enabled-maas"><h2 id="heading--using-the-cli-with-a-tls-enabled-maas">Using the CLI with a TLS-enabled MAAS</h2></a></p>
<p>To connect to the MAAS API when TLS is enabled, an https URL must be provided to the maas login command, e.g.:</p>
<pre><code class="language-nohighlight">maas login &lt;profile_name&gt; https://mymaas:5443/MAAS &lt;api_key&gt;

usage: maas login [-h] [--cacerts CACERTS] [-k] profile-name url [credentials]

Log in to a remote API, and remember its description and credentials.

positional arguments:
  profile-name       The name with which you will later refer to this remote server and credentials within this tool.
  url                The URL of the remote API, e.g. http://example.com/MAAS/ or http://example.com/MAAS/api/2.0/ if you wish to specify the API
                     version.
  credentials        The credentials, also known as the API key, for the remote MAAS server. These can be found in the user preferences page in
                     the web UI; they take the form of a long random-looking string composed of three parts, separated by colons.

optional arguments:
  -h, --help         show this help message and exit
  --cacerts CACERTS  Certificate CA file in PEM format
  -k, --insecure     Disable SSL certificate check

If credentials are not provided on the command-line, they will be prompted
for interactively.

the following arguments are required: profile-name, url
</code></pre>
<p>Certificates provided via <code>--cacerts</code> will be stored as a part of your profile and used for next CLI commands invocations.</p>
<p><a href="#heading--certificate-renewal"><h2 id="heading--certificate-renewal">Certificate renewal</h2></a></p>
<p>Once a certificate has expired, you can update it by running the same command used for enabling TLS:</p>
<pre><code class="language-nohighlight">$ ​​sudo maas config-tls enable new-server-key.pem new-server.pem --port 5443
</code></pre>
<p>If you’re using the snap, the certificate and key must be placed in a directory that’s readable by the CLI, such as <code>/var/snap/maas/common</code> (e.g., if you&rsquo;re using the snap version).</p>
<p><a href="#heading--ui-changes"><h2 id="heading--ui-changes">How to check whether TLS is enabled</h2></a></p>
<p>When TLS is enabled, the following certificate information is displayed in the MAAS UI under <em>Settings &gt;&gt; Configuration &gt;&gt; Security</em>: </p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>CN </li>
<li>Expiration date</li>
<li>Fingerprint</li>
<li>Certificate</li>
</ul>
<p>If TLS is disabled, this section will instead show a warning.  We recommend that you enable TLS for secure communication.</p>
<p><a href="#heading--notifications"><h3 id="heading--notifications">Notifications</h3></a></p>
<p>When the specified number of days remain until certificate expiration (as defined in the notification reminder), all administrators will see the certificate expiration notification. This notification enumerates the number of days until certificate expiration.  It is dismissible, but once dismissed, it won&rsquo;t appear again.</p>
<p>A certificate expiration check runs every twelve hours.  When the certificate has expired, the notification will change to “certificate has expired”.</p>
<p><a href="#heading--how-to-auto-renew-certificates"><h3 id="heading--how-to-auto-renew-certificates">How to auto-renew certificates</h3></a></p>
<p>MAAS does not auto-renew certificates, but there&rsquo;s no reason why we cannot provide a gratuitous example.  Use at your own risk.</p>
<p><a href="#heading--set-up-your-own-certificate-authority"><h4 id="heading--set-up-your-own-certificate-authority">Set up your own certificate authority</h4></a></p>
<p>You can setup your own Certificate Authority (CA) server that supports the ACME protocol with these components:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="https://smallstep.com/docs/step-ca">step-ca from Smallstep</a><code>↗</code></li>
<li><a href="https://caddyserver.com/docs/caddyfile/directives/acme_server">Caddy server with ACME support</a>  (available since version 2.5)<code>↗</code></li>
</ul>
<p>If you have a CA server with ACME protocol support, you can use any ACME client for an automated certificate renewal and use crontab to renew on a desired time interval.  Consider <a href="https://github.com/acmesh-official/acme.sh">acme.sh</a><code>↗</code>: </p>
<pre><code class="language-nohighlight">$&gt; acme.sh --issue -d mymaas.internal --standalone --server https://ca.internal/acme/acme/directory

Your cert is in: /root/.acme.sh/mymaas.internal/mymaas.internal.cer
Your cert key is in: /root/.acme.sh/mymaas.internal/mymaas.internal.key
The intermediate CA cert is in: /root/.acme.sh/mymaas.internal/ca.cer
And the full chain certs is there: /root/.acme.sh/foo/fullchain.cer
</code></pre>
<p>Once the certificate is issued, you can install it. </p>
<pre><code class="language-nohighlight">$&gt; acme.sh --installcert -d maas.internal \
   --certpath /var/snap/maas/certs/server.pem \
   --keypath /var/snap/maas/certs/server-key.pem  \
   --capath  /var/snap/maas/certs/cacerts.pem  \
   --reloadcmd  &quot;(echo y) | maas config-tls enable /var/snap/maas/certs/server-key.pem /var/snap/maas/certs/server.pem --port 5443&quot;
</code></pre>
<p>Please note that if you have MAAS installed via snap, you need to run above command as root, in order to place cert and key under <code>/var/snap/maas</code>.</p>
<p>Another approach would be to write a bash script and pass it to a <a href="https://github.com/acmesh-official/acme.sh/wiki/Using-pre-hook-post-hook-renew-hook-reloadcmd"><code>--renew-hook</code></a><code>↗</code>.</p>
<p><a href="#heading--using-certbot"><h4 id="heading--using-certbot">Using certbot</h4></a></p>
<p><a href="https://certbot.eff.org">certbot</a><code>↗</code> can be used to renew certificates and execute a post-renewal hook.  We can use this hook to re-configure MAAS to use fresh certificates.</p>
<p>To create a post-renewal hook, you can put this sample script under <code>/etc/letsencrypt/renewal-hooks/post/001-update-maas.sh</code>.</p>
<pre><code class="language-nohighlight">#!/bin/bash -e

DOMAIN=&quot;maas.internal&quot;
CERTSDIR=&quot;/etc/letsencrypt/live/$DOMAIN&quot;

cd /var/snap/maas/common

# need to copy certs where the snap can read them
cp &quot;$CERTSDIR&quot;/{privkey,cert,chain}.pem .
yes | maas config-tls enable privkey.pem cert.pem --cacert chain.pem --port 5443

# we don’t want to keep private key and certs around
rm {privkey,cert,chain}.pem
</code></pre>
<p>Don’t forget to make the script executable:</p>
<pre><code class="language-nohighlight">chmod +x /etc/letsencrypt/renewal-hooks/post/001-update-maas.sh
</code></pre>
<p>Of course, you&rsquo;ll first need to obtain a new certificate.  </p>
<pre><code class="language-nohighlight">sudo REQUESTS_CA_BUNDLE=ca.pem certbot certonly --standalone -d maas.internal     --server https://ca.internal/acme/acme/directory
</code></pre>
<p>Don&rsquo;t worry, new certs will not run the hook, since hooks are run only on renewal.</p>
<p>To test the renewal process and verify that the hook is executed correctly, you can use the following command with a <code>--dry-run flag</code>. Please note, that the hook will be executed and existing certificates will be removed (if you are using an example hook script):</p>
<pre><code class="language-nohighlight">sudo REQUESTS_CA_BUNDLE=ca.pem certbot renew --standalone --server https://ca.internal/acme/acme/directory --dry-run
</code></pre>
<p>Please refer to the <a href="https://certbot.eff.org/instructions?ws=other&amp;os=ubuntufocal">cerbot documentation</a><code>↗</code> for more information.</p>
    </div>
  </body>
</html>