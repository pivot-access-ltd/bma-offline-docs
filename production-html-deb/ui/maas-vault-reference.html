<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;UI-only&nbsp;
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/maas-vault-reference.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Home
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
      </ul>
      <p/>
      <strong>
	  Tutorials
      </strong>
      <ul>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="maas-cli-tutorial.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="create-a-custom-image.html">
	    Create a custom image
	  </a>
	</li>
	<li>
	  <a href="using-jq-with-the-maas-cli.html">
	    Using jq with the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	  How to get MAAS running
      </strong>
      <ul>
	<li>
	  <a href="how-to-install-maas.html">
	    Installation
	  </a>
	</li>
		<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade older versions
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshooting
	  </a>
	</li>
      </ul>
      <strong>
	  How to configure networking
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-addresses.html">
	    Manage IP addresses
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
      </ul>
      <strong>
	  How to choose images
      </strong>
      <ul>
	<li>
	  <a href="how-to-import-images.html">
	    Import images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-custom-images.html">
	    Create custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	  How to deploy MAAS
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-controllers.html">
	    Manage controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	  How to use tags
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-tags.html">
	    Work with tags
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-annotations.html">
	    Work with annotations
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	  How to operate MAAS
      </strong>
	<ul>
	  <li>
	    <a href="how-to-enable-high-availability.html">
	      Enable HA
	    </a>
	  </li>
	  <li>
	    <a href="how-to-set-up-maas-metrics.html">
	      Set up MAAS metrics
	    </a>
	  </li>
	  <li>
	    <a href="how-to-work-with-audit-event-logs.html">
	      Work with audit event logs
	    </a>
	  </li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
	</ul>
      <p/>
      <strong>
	  API Reference
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API documentation
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
      </ul>
      <p/>
      <strong>
	Technical Reference
      </strong>
      <ul>
	<li>
	  <a href="audit-event-log-reference.html">
	    Audit event log reference
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="maas-performance.html">
	    MAAS performance
	  </a>
	</li>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage reference
	  </a>
	</li>
	<p/>
	<strong>
	  General Reference
	</strong>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="installation-requirements.html">
	    Installation requirements
	  </a>
	</li>

	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
	<li>
	  <a href="how-to-get-help.html">
	    Getting help
	  </a>
	</li>
      </ul>
      <p/>
      <strong>
	  Explanations
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    MAAS
	  </a>
	</li>
	<li>
	  <a href="about-tcp-ip-networks.html">
	    TCP/IP networks
	  </a>
	</li>
	<li>
	  <a href="about-cloud-networks.html">
	    Cloud networks
	  </a>
	</li>
	<li>
	  <a href="about-dhcp.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="about-networking.html">
	    MAAS networking
	  </a>
	</li>
	<li>
	  <a href="about-images.html">
	    Images
	  </a>
	</li>
	<li>
	  <a href="about-creating-custom-images.html">
	    Custom images
	  </a>
	</li>
	<li>
	  <a href="about-controllers.html">
	    Controllers
	  </a>
	</li>
	<li>
	  <a href="about-machines.html">
	    Machines
	  </a>
	</li>
	<li>
	  <a href="about-customising-machines.html">
	    Customising machines
	  </a>
	</li>
	<li>
	  <a href="about-vm-hosting.html">
	    VM hosting
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>MAAS Vault reference</h1><!-- "MAAS Vault reference" -->

<p>As a MAAS administrator, you do not want secrets associated with a MAAS instance to be stored in the database, since it often doesnâ€™t comply with security regulations.  Examples of the MAAS settings which contain secrets are the OMAPI key and the RPC secret. MAAS secrets should instead be stored in Vault (<strong>appropriate link?</strong>).</p>
<p>Beginning with MAAS 3.3, MAAS secrets that are currently stored elswhere are stored in Vault, including but not limited to:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>Macaroon root keys</li>
<li>The database password </li>
<li>The shared RPC secret</li>
<li>User passwords</li>
<li>API tokens</li>
<li>User session keys </li>
<li>BMC credentials for nodes</li>
<li>Node keys</li>
<li>VMhost credentials</li>
<li>VM credentials</li>
</ul>
<p><a href="#heading--Integrating-Vault-with-MAAS"><h2 id="heading--Integrating-Vault-with-MAAS">Integrating Vault with MAAS</h2></a></p>
<p>MAAS provides an easy way to integrate Vault and move all secrets there, that is, secrets will be created in Vault and removed from other locations in MAAS, via the MAAS CLI:</p>
<pre><code class="language-nohighlight">$  sudo maas ($PROFILE?) config-vault enable  $vault_url $token --secrets-mount-point $mount_point
</code></pre>
<p>This command will automatically configure necessary policies and roles for MAAS to function with Vault, link roles as necessary, and store the appropriate Vault credentials in the MAAS region controller.  Should you inadvertently run the command twice, MAAS will respond with this error message:</p>
<pre><code class="language-nohighlight">This region is configured to use Vault. Generate a new token to connect with Vault on other controllers.
</code></pre>
<p><a href="#heading--Linking-existing-region-controllers-with-Vault"><h2 id="heading--Linking-existing-region-controllers-with-Vault">Linking existing region controllers with Vault</h2></a></p>
<p>You can use the first Vault-integrated controller to generate tokens for additional (existing) controllers:</p>
<pre><code class="language-nohighlight">$ sudo maas ($PROFILE?) config-vault generate-controller-token $controller-name (or $controller-id)
</code></pre>
<p>MAAS will respond with a <code>$wrapped_token</code> and a command to connect the next controller:</p>
<pre><code class="language-nohighlight">$ sudo maas config-vault connect-controller $vault_url $wrapped_token --secrets-mount-point $mount_point
</code></pre>
<p>A prototype of this command is printed to the terminal following the successful execution of the <code>maas config-vault enable</code> command.  Note that any new regions added after Vault integration will automatically be integrated with Vault.  No action is necessary on your part for these newly-added region controllers to work with Vault seamlessly.</p>
<p><a href="#heading--Reverting-from-Vault-back-to-the-MAAS-DB"><h2 id="heading--Reverting-from-Vault-back-to-the-MAAS-DB">Reverting from Vault back to the MAAS DB</h2></a></p>
<p>MAAS also provides a simple way to revert secrets from Vault to the MAAS DB, should you desire to do so:</p>
<pre><code class="language-nohighlight">$ maas $PROFILE config-vault disable $vault_url $secret_path_prefix $token
</code></pre>
<p><a href="#heading--When-the-Vault-is-sealed"><h2 id="heading--When-the-Vault-is-sealed">When the Vault is unreachable</h2></a></p>
<p><strong>link about Vault and sealing, please?  I get it, but have no links to external doc</strong></p>
<p>There are two conditions that may cause secrets to become unavailable: when the Vault is sealed, and when the Vault is unreachable through misconfiguration or other failure:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>
<p>When the Vault is sealed, all queries involving secrets will fail with a user error mentioning that the Vault has been sealed.  Unsealing the Vault requires operator intervention.  MAAS will indicate when this is needed.</p>
</li>
<li>
<p>Vault may become unreachable due to a network failure, due to incorrect configuration of a region controller, or other unintentional situations.  When the Vault is unreachable, MAAS will inform the users that interactions with Vault will fail.</p>
</li>
</ul>
<p>MAAS will make every attempt to present a meaningful error if Vault is not functional.  This includes related authentication errors when attempting to login to MAAS.</p>
<p><a href="#heading--Updating-secrets-directly"><h2 id="heading--Updating-secrets-directly">Updating secrets directly</h2></a></p>
<p>Secrets related to MAAS stored in Vault could be changed outside of MAAS, directly in Vault. If this happens, MAAS automatically uses the new value, as MAAS elements do not cache secrets &ndash; they are fetched every time they&rsquo;re needed.</p>
<p><strong>NOTE: i need some assurances as to the stability of the stuff in the <a href="https://docs.google.com/document/d/1lj5MpbhM0omMWClko7lY79_i-DO3R5cxwn0XBwAPaPw/edit#heading=h.r46zltfjohff">Vault meeting notes</a> before i use it.  who can assist?</strong></p>
    </div>
  </body>
</html>