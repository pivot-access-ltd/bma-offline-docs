<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;UI-only&nbsp;
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-create-custom-images.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Home
	</a>
      </strong>
      <p/>
      <strong>
	  Tutorials
      </strong>
      <ul>
	<li>
	  <a href="get-started-with-maas.html">
	    Get started with MAAS
	  </a>
	</li>
	<li>
	  <a href="maas-cli-tutorial.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="using-jq-with-the-maas-cli.html">
	    Using jq with the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	  How to get MAAS running
      </strong>
      <ul>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshooting
	  </a>
	</li>
      </ul>
      <strong>
	  How to configure networking
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-networks.html">
	    Manage networks
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-ip-addresses.html">
	    Manage IP addresses
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-tls-encryption.html">
	    Enable TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones
	  </a>
	</li>
      </ul>
      <strong>
	  How to choose images
      </strong>
      <ul>
	<li>
	  <a href="how-to-import-images.html">
	    Import images
	  </a>
	</li>
	<li>
	  <a href="how-to-create-custom-images.html">
	    Create custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vmware-images.html">
	    Manage VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	  How to deploy MAAS
      </strong>
      <ul>
	<li>
	  <a href="how-to-manage-controllers.html">
	    Manage controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-machines.html">
	    Manage machines
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-machines.html">
	    Commission and deploy machines
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vms.html">
	    Manage VMs
	  </a>
	</li>
	<li>
	  <a href="how-to-use-lxd.html">
	    Use LXD
	  </a>
	</li>
      </ul>
      <strong>
	  How to use tags
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-tags.html">
	    Work with tags
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-annotations.html">
	    Work with annotations
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	  How to operate MAAS
      </strong>
	<ul>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
	  <li>
	    <a href="how-to-set-up-maas-metrics.html">
	      Set up MAAS metrics
	    </a>
	  </li>
	  <li>
	    <a href="how-to-work-with-audit-event-logs.html">
	      Work with audit event logs
	    </a>
	  </li>
	<li>
	  <a href="how-to-use-maas-in-an-air-gapped-environment.html">
	    Use air-gapped MAAS
	  </a>
	</li>
	  <li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-secure-maas.html">
	    Secure MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage users
	  </a>
	</li>
	<li>
	  <a href="how-to-search-maas.html">
	    Search MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade older versions
	  </a>
	</li>
      </ul>
      <strong>
	  Reference
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-logging-reference.html">
	    Log files
	  </a>
	</li>
	<li>
	  <a href="audit-event-log-reference.html">
	    Audit event log reference
	  </a>
	</li>
	<li>
	  <a href="api.html">
	    API documentation
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="maas-concepts-and-terms-reference.html">
	    Concepts & terms
	  </a>
	</li>
	<li>
	  <a href="how-to-get-help.html">
	    Getting help
	  </a>
	</li>
      </ul>
      <strong>
	  Explanations
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    MAAS
	  </a>
	</li>
	<li>
	  <a href="about-tcp-ip-networks.html">
	    TCP/IP networks
	  </a>
	</li>
	<li>
	  <a href="about-cloud-networks.html">
	    Cloud networks
	  </a>
	</li>
	<li>
	  <a href="about-dhcp.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="about-networking.html">
	    MAAS networking
	  </a>
	</li>
	<li>
	  <a href="about-images.html">
	    Images
	  </a>
	</li>
	<li>
	  <a href="about-creating-custom-images.html">
	    Custom images
	  </a>
	</li>
	<li>
	  <a href="about-controllers.html">
	    Controllers
	  </a>
	</li>
	<li>
	  <a href="about-machines.html">
	    Machines
	  </a>
	</li>
	<li>
	  <a href="about-customising-machines.html">
	    Customising machines
	  </a>
	</li>
	<li>
	  <a href="about-vm-hosting.html">
	    VM hosting
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to create custom images</h1><!-- "How to create custom images" -->

<p>MAAS supports deploying custom OS images.  Canonical provides both <a href="https://launchpad.net/maas-image-builder">lp:maas-image-builder</a> and <a href="https://github.com/canonical/packer-maas">gh:canonical/packer-maas</a> to support creating custom images. These custom images can include static Ubuntu images, created with whatever tool you choose, as well as other OS images.</p>
<p><strong>NOTE:</strong> 
While it may be possible to deploy a certain image with MAAS, the particular use case may not be supported by that image’s vendor due to licensing or technical reasons. Canonical recommends that, whenever possible, you should customise machines using cloud-init user_data or Curtin preseed data, instead of creating a custom image.</p>
<p>There are two methods for building custom images to be deployed to MAAS machines: MAAS Image Builder, and <a href="https://www.packer.io/">packer</a>.  This section will help you learn:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--how-to-verify-packer-prequisites">How to verify packer prequisites</a></li>
<li><a href="#heading--how-to-verify-packer-deployment-requirements">How to verify packer deployment requirements</a></li>
<li><a href="#heading--how-to-customise-images">How to customise images</a></li>
<li><a href="#heading--how-to-build-images-via-a-proxy">How to build images via a proxy</a></li>
<li><a href="#heading--how-to-use-packer-to-build-maas-images">How to use packer to build MAAS images</a></li>
<li><a href="#heading--how-to-pack-an-ubuntu-image-for-maas-deployment">How to pack an Ubuntu image for MAAS deployment</a></li>
<li><a href="#heading--how-to-pack-a-rhel7-image-for-maas-deployment">How to pack a RHEL7 image for MAAS deployment</a></li>
<li><a href="#heading--how-to-use-maas-image-builder-to-build-maas-images">How to use MAAS Image Builder to build MAAS images</a></li>
</ul>
<p><a href="#heading--how-to-verify-packer-prequisites"><h3 id="heading--how-to-verify-packer-prequisites">How to verify packer prequisites</h3></a></p>
<p>The following are required to to create a packer MAAS image:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>A machine running Ubuntu 18.04+ or higher with the ability to run KVM virtual machines.</li>
<li>Various dependencies required by the chosen template (see the template directory for details)</li>
<li><a href="https://www.packer.io/intro/getting-started/install.html">Packer</a></li>
</ul>
<p>As an example for this article, we will be building a custom Ubuntu image from the default template, which has the following prerequisites:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>qemu-utils</li>
<li>qemu-system</li>
<li>ovmf</li>
<li>cloud-image-utils</li>
</ul>
<p>Note that these requirements may vary by template and target image.</p>
<p><a href="#heading--how-to-verify-packer-deployment-requirements"><h3 id="heading--how-to-verify-packer-deployment-requirements">How to verify packer deployment requirements</h3></a></p>
<p>The following are required to deploy a packer MAAS image:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="https://maas.io">MAAS</a> 3.0+</li>
<li><a href="https://launchpad.net/curtin">Curtin</a> 21.0+</li>
</ul>
<p><a href="#heading--how-to-customise-images"><h3 id="heading--heading--how-to-customise-images">How to customise images</h3></a></p>
<p>It is possible to customize the image either during the Ubuntu installation, or afterwards (before packing the final image). The former is done by providing <a href="https://ubuntu.com/server/docs/install/autoinstall">autoinstall config</a>, editing the <em>user-data-flat</em> and <em>user-data-lvm</em> files. The latter is performed by the <em>install-custom-packages</em> script.</p>
<p><a href="#heading--how-to-build-images-via-a-proxy"><h3 id="heading--how-to-build-images-via-a-proxy">How to build images via a proxy</h3></a></p>
<p>The Packer template downloads the Ubuntu net installer from the Internet. To tell Packer to use a proxy, set the HTTP_PROXY environment variable to your proxy server. Alternatively, you may redefine iso_url to a local file, set iso_checksum_type to none to disable the checksums, and remove iso_checksum_url.</p>
<p><a href="#heading--how-to-use-packer-to-build-maas-images"><h3 id="heading--how-to-use-packer-to-build-maas-images">How to use packer to build MAAS images</h3></a></p>
<p><a href="https://www.packer.io/">Packer</a> can be used to build images to be deployed by MAAS.  In order to use packer, you must have a <a href="https://github.com/canonical/packer-maas">packer template</a> for the OS version you intend to build.</p>
<p>Currently, templates are available for:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>Ubuntu custom images</li>
<li>CentOS6</li>
<li>CentOS7</li>
<li>CentOS8</li>
<li>RHEL7</li>
<li>RHEL8</li>
<li>VMWare EXSi</li>
</ul>
<p>This section will help you learn:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--how-to-install-packer">How to install packer</a></li>
<li><a href="#heading--how-to-obtain-templates">How to obtain templates</a></li>
<li><a href="#heading--how-to-create-a-packer-image">How to create and use packer images</a></li>
</ul>
<p>Note that additional templates will be made available from time to time.</p>
<p><a href="#heading--how-to-install-packer"><h4 id="heading--how-to-install-packer">How to install packer</h4></a></p>
<p>Packer is easily installed from its Debian package:</p>
<pre><code class="language-nohighlight">sudo apt install packer
</code></pre>
<p>For this example Ubuntu template, the following dependencies should also be installed &ndash; but note that these dependencies may vary by template and/or target image:</p>
<pre><code class="language-nohighlight">sudo apt install qemu-utils
sudo apt install qemu-system
sudo apt install ovmf
sudo apt install cloud-image-utils
</code></pre>
<p>All of these should install without additional prompts.</p>
<p><a href="#heading--how-to-obtain-templates"><h4 id="heading--how-to-obtain-templates">How to obtain templates</h4></a></p>
<p>You can obtain the packer templates by cloning the <a href="https://github.com/canonical/packer-maas.git">packer-maas github repository</a>, like this:</p>
<pre><code class="language-nohighlight">git clone https://github.com/canonical/packer-maas.git
</code></pre>
<p>Make sure to pay attention to where the repository is cloned.  The Packer template in this cloned repository creates a Ubuntu AMD64 image for use with MAAS.</p>
<p><a href="#heading--how-to-create-a-packer-image"><h4 id="heading--how-to-create-a-packer-image">How to create and use packer images</h4></a></p>
<p>This subsection will help you learn:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--how-to-build-a-packer-image">How to build a packer image</a></li>
<li><a href="#heading--how-to-upload-packer-images-to-maas">How to upload packer images to MAAS</a></li>
<li><a href="#heading--about-the-default-image-username">About the default image username</a></li>
</ul>
<p><a href="#heading--how-to-build-a-packer-raw-image"><h5 id="heading--how-to-build-a-packer-raw-image">How to build a packer raw image</h5></a></p>
<p>To build a packer image, you must change to the template repository directory, then to the subdirectory for the image you want to build.  From that subdirectory, you can easily build a raw image with LVM, using the Makefile:</p>
<pre><code class="language-nohighlight">$ make custom-ubuntu-lvm.dd.gz
</code></pre>
<p>This makefile will run for a couple of minutes before attempting to boot the image.  While waiting for the image to boot, packer will attempt to SSH into the machine repeatedly until it succeeds.  You will see terminal messages similar to this one for upwards of three to five minutes:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:46 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] SSH handshake err: ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] Detected authentication error. Increasing handshake attempts.
</code></pre>
<p>Eventually, you should see a successful SSH connection:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:57 packer-builder-qemu plugin: [INFO] Attempting SSH connection to 127.0.0.1:2351...
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] reconnecting to TCP connection for SSH
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:51:17 packer-builder-qemu plugin: [DEBUG] handshake complete!
</code></pre>
<p>If the process seems to run for a long time, you can predict whether it&rsquo;s going to work by doing a series of <code>netstat -a</code> on the <code>IP:port</code> given in the connection attempt.  Attempts may fail repeatedly, but if you repeat the <code>netstat -a</code> command frequently, you will see some tentative connections, like this one:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~$ netstat -a | grep 2281
tcp        0      0 0.0.0.0:2281            0.0.0.0:*               LISTEN     
tcp        0      0 localhost:46142         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46120         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46138         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46134         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46130         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46124         localhost:2281          TIME_WAIT  
stormrider@neuromancer:~$ netstat -a | grep 2281
tcp        0      0 0.0.0.0:2281            0.0.0.0:*               LISTEN     
tcp        0      0 localhost:46142         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46146         localhost:2281          ESTABLISHED
tcp        0      0 localhost:2281          localhost:46146         ESTABLISHED
tcp        0      0 localhost:46138         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46134         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46130         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46124         localhost:2281          TIME_WAIT
</code></pre>
<p>This <code>ESTABLISHED</code> connection may not hold the first few times, but eventually, the SSH connection will be made, and the provisioning process will finish.  If you want to walk away and come back, be advised that the Makefile clears the terminal buffer at the end, but echoes one final instruction:</p>
<pre><code class="language-nohighlight">rm OVMF_VARS.fd
</code></pre>
<p>You can check the validity of the operation with <code>ls</code>, like this:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~/mnt/Dropbox/src/git/packer-maas/ubuntu$ ls
custom-ubuntu-lvm.dd.gz  packages      seeds-lvm.iso     user-data-lvm
http                     packer_cache  ubuntu-flat.json
Makefile                 README.md     ubuntu-lvm.json
meta-data                scripts       user-data-flat
</code></pre>
<p>You can also manually run packer. Your current working directory must be in the subdirectory where the packer template is located.  In the case of this example, that&rsquo;s <code>packer-maas/ubuntu</code>. Once in <code>packer-maas/ubuntu</code>, you can generate an image with the following command sequence:</p>
<pre><code class="language-nohighlight">$ sudo PACKER_LOG=1 packer build ubuntu-lvm.json
</code></pre>
<p><strong>NOTE:</strong> 
ubuntu-lvm.json is configured to run Packer in headless mode. Only Packer output will be seen. If you wish to see the installation output connect to the VNC port given in the Packer output, or change the value of headless to false in the JSON file.</p>
<p>This process is non-interactive.</p>
<p><a href="#heading--how-to-upload-packer-images-to-maas"><h5 id="heading--how-to-upload-packer-images-to-maas">How to upload packer images to MAAS</h5></a></p>
<p>You can upload a packer image with the following command:</p>
<pre><code class="language-nohighlight">$ maas admin boot-resources create \
    name='custom/ubuntu-raw' \
    title='Ubuntu Custom RAW' \
    architecture='amd64/generic' \
    filetype='ddgz' \
    content@=custom-ubuntu-lvm.dd.gz
</code></pre>
<p>Before relying on it in production, you should test your custom image by deploying it to a test (virtual) machine.  It&rsquo;s the machine named <code>open-gannet</code> in this listing:</p>
<pre><code class="language-nohighlight">maas admin machines read | jq -r '([&quot;HOSTNAME&quot;,&quot;SYSID&quot;,&quot;POWER&quot;,&quot;STATUS&quot;,
&quot;OWNER&quot;, &quot;OS&quot;, &quot;DISTRO&quot;] | (., map(length*&quot;-&quot;))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner // &quot;-&quot;,
.osystem, .distro_series]) | @tsv' | column -t

HOSTNAME     SYSID   POWER  STATUS    OWNER  OS      DISTRO
--------     -----   -----  ------    -----  --      ------
valued-moth  e86c7h  on     Deployed  admin  ubuntu  focal
open-gannet  nk7x8y  on     Deployed  admin  custom  ubuntu-raw
</code></pre>
<p><a href="#heading--about-the-default-image-username"><h5 id="heading--about-the-default-image-username">About the default image username</h5></a></p>
<p>The default username for packer-created images is <code>ubuntu</code>, the same as the default username for other MAAS images.</p>
<p><a href="#heading--how-to-pack-an-ubuntu-image-for-maas-deployment"><h2 id="heading--how-to-pack-an-ubuntu-image-for-maas-deployment">How to pack an Ubuntu image for MAAS deployment</h2></a></p>
<p>Here&rsquo;s how to build a deployable Ubuntu image with packer:</p>
<h3>Install packer</h3>
<p>Packer is easily installed from its Debian package:</p>
<pre><code class="language-nohighlight">sudo apt install packer
</code></pre>
<p>This should install with no additional prompts.</p>
<h3>Install Ubuntu template dependencies</h3>
<pre><code class="language-nohighlight">sudo apt install qemu-utils
sudo apt install qemu-system
sudo apt install ovmf
sudo apt install cloud-image-utils
</code></pre>
<p>All of these should install with no additional prompts.</p>
<h3>Get the available packer templates</h3>
<p>You can obtain the packer templates by cloning the <a href="https://github.com/canonical/packer-maas.git">packer-maas github repository</a>, like this:</p>
<pre><code class="language-nohighlight">git clone https://github.com/canonical/packer-maas.git
</code></pre>
<p>Make sure to pay attention to where the repository is cloned.  The Packer template in this cloned repository creates a Ubuntu AMD64 image for use with MAAS.</p>
<h3>Build an Ubuntu raw image with packer</h3>
<p>To build a packer image, you must change to the template repository directory, then to the subdirectory for the image you want to build.  From that subdirectory, you can easily build a raw image with LVM, using the Makefile:</p>
<pre><code class="language-nohighlight">$ make custom-ubuntu-lvm.dd.gz
</code></pre>
<p>This makefile will run for a couple of minutes before attempting to boot the image.  While waiting for the image to boot, packer will attempt to SSH into the machine repeatedly until it succeeds.  You will see terminal messages similar to this one for upwards of three to five minutes:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:46 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] SSH handshake err: ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] Detected authentication error. Increasing handshake attempts.
</code></pre>
<p>Eventually, you should see a successful SSH connection:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:57 packer-builder-qemu plugin: [INFO] Attempting SSH connection to 127.0.0.1:2351...
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] reconnecting to TCP connection for SSH
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:51:17 packer-builder-qemu plugin: [DEBUG] handshake complete!
</code></pre>
<p>If the process seems to run for a long time, you can predict whether it&rsquo;s going to work by doing a series of <code>netstat -a</code> on the <code>IP:port</code> given in the connection attempt.  Attempts may fail repeatedly, but if you repeat the <code>netstat -a</code> command frequently, you will see some tentative connections, like this one:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~$ netstat -a | grep 2281
tcp        0      0 0.0.0.0:2281            0.0.0.0:*               LISTEN     
tcp        0      0 localhost:46142         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46120         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46138         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46134         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46130         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46124         localhost:2281          TIME_WAIT  
stormrider@neuromancer:~$ netstat -a | grep 2281
tcp        0      0 0.0.0.0:2281            0.0.0.0:*               LISTEN     
tcp        0      0 localhost:46142         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46146         localhost:2281          ESTABLISHED
tcp        0      0 localhost:2281          localhost:46146         ESTABLISHED
tcp        0      0 localhost:46138         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46134         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46130         localhost:2281          TIME_WAIT  
tcp        0      0 localhost:46124         localhost:2281          TIME_WAIT
</code></pre>
<p>This <code>ESTABLISHED</code> connection may not hold the first few times, but eventually, the SSH connection will be made, and the provisioning process will finish.  If you want to walk away and come back, be advised that the Makefile clears the terminal buffer at the end, but echoes one final instruction:</p>
<pre><code class="language-nohighlight">rm OVMF_VARS.fd
</code></pre>
<h3>Validate the build</h3>
<p>You can check the validity of the operation with <code>ls</code>, like this:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~/mnt/Dropbox/src/git/packer-maas/ubuntu$ ls
custom-ubuntu-lvm.dd.gz  packages      seeds-lvm.iso     user-data-lvm
http                     packer_cache  ubuntu-flat.json
Makefile                 README.md     ubuntu-lvm.json
meta-data                scripts       user-data-flat
</code></pre>
<h3>Alternative: Run packer manually</h3>
<p>You can also manually run packer. Your current working directory must be in the subdirectory where the packer template is located.  In the case of this example, that&rsquo;s <code>packer-maas/ubuntu</code>. Once in <code>packer-maas/ubuntu</code>, you can generate an image with the following command sequence:</p>
<pre><code class="language-nohighlight">$ sudo PACKER_LOG=1 packer build ubuntu-lvm.json
</code></pre>
<p><strong>NOTE:</strong> 
ubuntu-lvm.json is configured to run Packer in headless mode. Only Packer output will be seen. If you wish to see the installation output connect to the VNC port given in the Packer output, or change the value of headless to false in the JSON file.</p>
<p>This process is non-interactive.</p>
<h3>Upload the Ubuntu image to MAAS</h3>
<p>You can upload an Ubuntu raw packer image with the following command:</p>
<pre><code class="language-nohighlight">$ maas admin boot-resources create \
    name='custom/ubuntu-raw' \
    title='Ubuntu Custom RAW' \
    architecture='amd64/generic' \
    filetype='ddgz' \
    content@=custom-ubuntu-lvm.dd.gz
</code></pre>
<h3>Verify your custom image</h3>
<p>Before relying on it in production, you should test your custom image by deploying it to a test (virtual) machine.  It&rsquo;s the machine named <code>open-gannet</code> in this listing:</p>
<pre><code class="language-nohighlight">maas admin machines read | jq -r '([&quot;HOSTNAME&quot;,&quot;SYSID&quot;,&quot;POWER&quot;,&quot;STATUS&quot;,
&quot;OWNER&quot;, &quot;OS&quot;, &quot;DISTRO&quot;] | (., map(length*&quot;-&quot;))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner // &quot;-&quot;,
.osystem, .distro_series]) | @tsv' | column -t

HOSTNAME     SYSID   POWER  STATUS    OWNER  OS      DISTRO
--------     -----   -----  ------    -----  --      ------
valued-moth  e86c7h  on     Deployed  admin  ubuntu  focal
open-gannet  nk7x8y  on     Deployed  admin  custom  ubuntu-raw
</code></pre>
<h3>Log into your deployed image and verify that it&rsquo;s right</h3>
<p>You should log into your newly-deployed image and verify that it has all the customisations you added to the build process.  The default username for packer-created images is <code>ubuntu</code>, the same as the default username for other MAAS images.</p>
<p><a href="#heading--how-to-pack-a-rhel7-image-for-maas-deployment"><h2 id="heading--how-to-pack-a-rhel7-image-for-maas-deployment">How to pack a RHEL7 image for MAAS deployment</h2></a></p>
<p>You can create a RHEL7 image for MAAS deployment via the following procedure.</p>
<h3>Verify the requirements</h3>
<p>To create a RHEL7 image to upload to MAAS, you must have a machine running Ubuntu 18.04+ or higher with the ability to run KVM virtual machines.  You must also aquire the following items, as described in later instructions:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>qemu-utils</li>
<li>packer</li>
<li>The RHEL 7 DVD ISO</li>
</ul>
<p>To deploy the image to MAAS, you must also have:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>MAAS 2.3+</li>
<li>Curtin 18.1-59+</li>
</ul>
<h3>Install packer</h3>
<p>Packer is easily installed from its Debian package:</p>
<pre><code class="language-nohighlight">sudo apt install packer
</code></pre>
<p>This should install with no additional prompts.</p>
<h3>Install RHEL7 template dependencies</h3>
<pre><code class="language-nohighlight">sudo apt install qemu-utils
</code></pre>
<h3>Get the available packer templates</h3>
<p>You can obtain the packer templates by cloning the <a href="https://github.com/canonical/packer-maas.git">packer-maas github repository</a>, like this:</p>
<pre><code class="language-nohighlight">git clone https://github.com/canonical/packer-maas.git
</code></pre>
<p>Make sure to pay attention to where the repository is cloned.  The Packer template in this cloned repository creates a Ubuntu AMD64 image for use with MAAS.</p>
<p>This package should install with no additional prompts.</p>
<h3>Locate the RHEL7 template</h3>
<p>The packer template in the directory <code>rhel7</code> subdirectory creates a RHEL 7 AMD64 image for use with MAAS.</p>
<h3>Obtain the RHEL7 DVD ISO</h3>
<p>Download the <a href="https://developers.redhat.com/products/rhel/download">RHEL7 DVD ISO</a> to your <code>rhel7</code> subdirectory. </p>
<h3>Customizing the image, if desired</h3>
<p>The deployment image may be customized by modifying http/rhel7.ks. See the CentOS kickstart documentation for more information.</p>
<h3>Set up a proxy for building the image, if desired</h3>
<p>The Packer template pulls all packages from the DVD except for Canonical&rsquo;s cloud-init repository. To use a proxy during the installation add the &ndash;proxy=$HTTP_PROXY flag to every line starting with url or repo in http/rhel7.ks. Alternatively you may set the &ndash;mirrorlist values to a local mirror.</p>
<h3>Build the RHEL7 image</h3>
<p>You can easily build the image using the Makefile:</p>
<pre><code class="language-nohighlight">$ make ISO=/PATH/TO/rhel-server-7.9-x86_64-dvd.iso
</code></pre>
<p>This process is non-interactive and may take some time (3-5 minutes) to successfully boot the image and complete the build.  Do not be concerned about SSH errors while the builder is attempting to establish an SSH connection with the running VM; this is normal.</p>
<h3>Alternative: Run packer manually</h3>
<p>Alternatively, you can manually run packer. Your current working directory must be in <code>packer-maas/rhel7</code>, where this file is located. Once in <code>packer-maas/rhel7</code>, you can generate an image with:</p>
<pre><code class="language-nohighlight">$ sudo PACKER_LOG=1 packer build -var 'rhel7_iso_path=/PATH/TO/rhel-server-7.9-x86_64-dvd.iso' rhel7.json
</code></pre>
<p><strong>NOTE:</strong> 
<code>rhel7.json</code> is configured to run Packer in headless mode. Only Packer output will be seen. If you wish to see the installation output, connect to the VNC port given in the Packer output or change the value of headless to false in <code>rhel7.json</code>.</p>
<h3>Upload the RHEL7 image to MAAS</h3>
<p>You can upload the RHEL7 raw packer image with the following command:</p>
<pre><code class="language-nohighlight">$ maas $PROFILE boot-resources create
name='rhel/7-custom' title='RHEL 7 Custom' architecture='amd64/generic' filetype='tgz' content@=rhel7.tar.gz
</code></pre>
<h3>Verify your custom image</h3>
<p>Before relying on it in production, you should test your custom image by deploying it to a test (virtual) machine.  It&rsquo;s the machine named <code>open-gannet</code> in this listing:</p>
<pre><code class="language-nohighlight">maas admin machines read | jq -r '([&quot;HOSTNAME&quot;,&quot;SYSID&quot;,&quot;POWER&quot;,&quot;STATUS&quot;,
&quot;OWNER&quot;, &quot;OS&quot;, &quot;DISTRO&quot;] | (., map(length*&quot;-&quot;))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner // &quot;-&quot;,
.osystem, .distro_series]) | @tsv' | column -t

HOSTNAME     SYSID   POWER  STATUS    OWNER  OS      DISTRO
--------     -----   -----  ------    -----  --      ------
valued-moth  e86c7h  on     Deployed  admin  ubuntu  focal
open-gannet  nk7x8y  on     Deployed  admin  custom  rhel7-raw
</code></pre>
<h3>Log into your deployed image and verify that it&rsquo;s right</h3>
<p>You should log into your newly-deployed image and verify that it has all the customisations you added to the build process.  The default username for packer-created RHEL images is <code>cloud-user</code>.</p>
<p><a href="#heading--how-to-use-maas-image-builder-to-build-maas-images"><h3 id="heading--how-to-use-maas-image-builder-to-build-maas-images">How to use MAAS Image Builder to build MAAS images</h3></a></p>
<p>MAAS Image Builder is an older tool, still required to build some images (e.g., Windows images).  Wherever possible, we recommend you use <code>packer</code>, as described above.</p>
<p><strong>NOTE:</strong> 
In order to use MAAS Image Builder, you must purchase <a href="https://support.canonical.com/ua/s/article/How-to-access-the-MAAS-Image-Builder-tool">Ubuntu Advantage for Infrastructure</a>.</p>
<p>This article will help you learn:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--install-mib">How to install MAAS Image Builder</a> via a private Canonical PPA (which you can request)</li>
<li><a href="#heading--custom-centos-images">How to create custom CentOS images</a></li>
<li><a href="#heading--custom-rhel-images">How to create custom RHEL images</a></li>
<li><a href="#heading--custom-windows-images">How to create Windows images</a></li>
<li><a href="#heading--other-custom-images">How to create other kinds of custom images</a></li>
</ul>
<p>You can customise most images as much or as little as you wish, then use them to commission machines with MAAS. </p>
<p><a href="#heading--install-mib"><h4 id="heading--install-mib">How to install MAAS Image Builder</h4></a></p>
<p>To get MAAS Image Builder, you must be subscribed to a private PPA provided by Canonical Support to those customers who have purchased <a href="https://support.canonical.com/ua/s/article/How-to-access-the-MAAS-Image-Builder-tool">Ubuntu Advantage for Infrastructure</a>.  Note that the steps below will fail if you have not purchased Ubuntu Advantage and been subscribed to the private PPA by your Canonical support rep.</p>
<p>Once subscribed, you need to obtain your credentials at this external link:</p>
<p>https://launchpad.net/~/+archivesubscriptions</p>
<p>Also, you must add the repository with the <code>add-apt-repository</code> command.  Note: Be sure to substitute your unique URL in the command below:</p>
<pre><code>$ sudo add-apt-repository \
“https://LaunchpadID:Password@private-ppa.launchpad.net/maas-image-builder-partners/stable/ubuntu"
</code></pre>
<p>Once you have added the private PPA, you can install the Image Builder like this:</p>
<pre><code>$ sudo apt-get install maas-image-builder
</code></pre>
<p>All done? Great!  Now you can build and customise images for MAAS machines, as shown in the sections below.</p>
<p><a href="#heading--custom-centos-images"><h4 id="heading--custom-centos-images">How to create custom CentOS images</h4></a></p>
<p>MAAS already provides the latest available CentOS 6, CentOS 7, and CentOS 8 for automatic download. If you need something else, though, MAAS Image Builder supports the ability to create various CentOS images.</p>
<h5 id="heading--centos-nw-rqmts">Network Requirements</h5>

<p>Access to the Internet is required, since you will need to start with one of these sites:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>http://mirror.centos.org - OS, updates, and extra repositories</li>
<li>https://download.fedoraproject.org - EPEL</li>
<li>https://copr-be.cloud.fedoraproject.org - Canonical maintained cloud-init repository</li>
</ul>
<h5 id="heading--images-behind-proxy">Creating images behind a proxy</h5>

<p>MAAS Image Builder can create CentOS images behind a proxy &ndash; just set the ‘http_proxy’ environment variable to <em>your</em> particular proxy. Once deployed, <code>yum</code> will use this MAAS-configured proxy.</p>
<h5 id="heading--centos-create-images">Creating the images</h5>

<p><code>maas-image-builder</code> is designed to automate the process of generating the images for MAAS and <code>curtin</code>.  Here are some specific examples:</p>
<pre><code>$ sudo maas-image-builder -o centos6-amd64-root-tgz --arch amd64 centos --edition 6 
$ sudo maas-image-builder -o centos6-i386-root-tgz --arch i386 centos --edition 6
$ sudo maas-image-builder -o centos7-amd64-root-tgz --arch amd64 centos --edition 7
</code></pre>
<h5 id="heading--centos-customize-images">Customising CentOS images</h5>

<p>Starting from MAAS Image Builder 1.0.4, customisation of CentOS images is now supported.  You can provide a custom kickstart, in <em>addition</em> to the kickstart that MAAS Image Builder uses to create the images. You can customise your image like this:</p>
<pre><code>$ sudo maas-image-builder -o centos7-amd64-root-tgz --arch amd64 centos --edition 7 --custom-kickstart ./custom.ks
</code></pre>
<h5 id="heading--centos-upload-images">Uploading the image into MAAS</h5>

<p>Custom CentOS images can be uploaded to MAAS as shown in the command below.  <em>Do note</em> that the name <strong>must</strong> start with ‘centos’ and <strong>must</strong> be one line:</p>
<pre><code>maas admin boot-resources create name=centos/centos6-custom architecture=amd64/generic content@=./build-output/centos-amd64-root-tgz
</code></pre>
<p>You can use the MAAS WebUI to check that your custom CentOS image is valid and selectable for deployment.</p>
<p><a href="#heading--custom-rhel-images"><h4 id="heading--custom-rhel-images">How to create custom RHEL images</h4></a></p>
<p>Currently, MAAS <em>only</em> supports RHEL as a custom image. In future versions of MAAS, RHEL will be natively supported.</p>
<h5 id="heading--rhel-requirements">Some Requirements</h5>

<p>In order to create RHEL images, you will need access to these sites:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>A RHEL DVD ISO - Contains all RHEL archives which are not available without a license</li>
<li>https://download.fedoraproject.org - Access to the EPEL repository to install required deps</li>
<li>https://copr-be.cloud.fedoraproject.org - Access to the Canonical maintained cloud-init copr repository</li>
</ul>
<h5 id="heading--rhel-behind-proxy">Creating images behind a proxy</h5>

<p>MAAS image builder supports creating RHEL images behind a proxy. To use a proxy when building a RHEL image, just set the ‘http_proxy’ environment variable to <em>your</em> local proxy. Once deployed, <code>yum</code> will use the MAAS-configured proxy.</p>
<h5 id="heading--rhel-create-images">Creating the images</h5>

<p>To generate a usable RHEL image, <code>maas-image-builder</code> automates image generation; these images can be used by MAAS and <code>curtin</code>.</p>
<pre><code> $ sudo maas-image-builder -a amd64 -o rhel7-amd64-root-tgz rhel --rhel-iso blah.iso
</code></pre>
<h5 id="heading--rhel-install">Install into MAAS</h5>

<p>The custom RHEL image can be uploaded to MAAS, but note that the name <strong>must</strong> start with ‘rhel’ and <strong>must</strong> be expressed as a single line, like this:</p>
<pre><code>maas admin boot-resources create name=rhel/7 title="RedHat Enterprise Linux 7" architecture=amd64/generic content@=rhel7-amd64-root-tgz
</code></pre>
<p><a href="#heading--custom-windows-images"><h4 id="heading--custom-windows-images">How to create Windows images</h4></a></p>
<p>Since Windows is a proprietary operating system, MAAS can&rsquo;t download these images. You need to manually generate images to use with MAAS.  On the upside, the end result will be much simpler, since there are CLI and WebUI tools to upload a Windows ISO &ndash; which <em>helps</em> automate the process.</p>
<p><b>Hyper-V 2012 R2</b>
In this example, Windows Hyper-V 2012 R2 is used, but rest assured that multiple versions are supported. Download the Hyper-V 2012 R2 ISO from Microsoft, so it can be used in the image generation process.  You can obtain the download at:</p>
<p>http://technet.microsoft.com/en-US/evalcenter/dn205299.aspx</p>
<p>There are several other supported versions (for &ndash;windows-edition):</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>win2012</li>
<li>win2012r2</li>
<li>win2012hv</li>
<li>win2012hvr2</li>
<li>win2016</li>
<li>win2016hv</li>
</ul>
<h5 id="heading--mib-windows">Image Builder</h5>

<p>MAAS Image builder can automate the process of generating images for MAAS and <code>curtin</code>.  In this instance,  though, you need Windows drivers for your specific hardware.  You can obtain these windows drivers with the following command:</p>
<pre><code>sudo maas-image-builder -o windows-win2012hvr2-amd64-root-dd  windows \
--windows-iso ~/Downloads/2012hvr2.ISO \
--windows-edition win2012hvr2 [--windows-updates] \
[--windows-drivers &lt;folder/&gt;]  [--windows-language en-US]
</code></pre>
<p>As an example, consider:</p>
<pre><code>sudo maas-image-builder -o windows-win2012hvr2-amd64-root-dd windows \
--windows-iso win2012hvr2.iso  --windows-edition win2012hvr2 \
--windows-updates --windows-drivers ~/Win2012hvr2_x64/DRIVERS/  --windows-language en-US
</code></pre>
<p>Please note that this will not <em>install</em> any Windows updates. In order to obtain an up-to-date image of Windows, be sure provide the <code>&ndash;windows-updates</code> flag. This requires access to a bridged connection with a DHCP server, an interface that can be specified with <code>-i</code>.</p>
<p>Also note that you may be required to have specific Windows drivers for this image to work in your hardware. Be sure you inject those drivers when installing them. Those drivers are the default <code>*.inf</code> files.</p>
<h5 id="heading--mib-debug-windows">Debug</h5>

<p>You can debug the Windows installation process by connecting to <code>localhost:5901</code> using a VNC client.</p>
<h5 id="heading--windows-image-install">Install into MAAS</h5>

<p>The generated images need to be placed into the correct directories so MAAS can deploy them onto a node:</p>
<pre><code>maas admin boot-resources create name=windows/win2012hvr2 \
architecture=amd64/generic filetype=ddtgz \ 
content@=./build-output/windows-win2012hvr2-amd64-root-dd
</code></pre>
<p>Now, using the MAAS WebUI, a node can be selected to use Windows Hyper-V 2012 R2. This selection gets reset when a node is stopped, so make sure to set it <em>before</em> starting nodes. You can also set the default operating system (and release) in the settings menu, which removes the need to set it per-node.</p>
<p><a href="#heading--other-custom-images"><h4 id="heading--other-custom-images">How to create other kinds of custom images</h4></a></p>
<p>To install other custom images, use the following command sequence:</p>
<pre><code>maas &lt;user&gt; boot-resources create name=&lt;custom-image-codename&gt; title="Ubuntu Custom Image" \
architecture=amd64/generic content@=/location/of/custom/image/ubuntu-custom-root-tgz
</code></pre>
<p>As an example:</p>
<pre><code>maas admin boot-resources create name=custom1 \
title=”Ubuntu Custom Image” architecture=amd64/generic \
content@=/home/ubuntu/ubuntu-custom-root-tgz
</code></pre>
    </div>
  </body>
</html>