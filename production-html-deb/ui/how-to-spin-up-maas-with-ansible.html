<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;
      <strong>Offline docs
      </strong>
      <a href="https://maas.io/docs">(switch to live docs)
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  UI-only
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-spin-up-maas-with-ansible.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong> 
      <strong>
	<a href="tutorials.html">
	  Tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="bootstrap-maas.html">
	    Bootstrap MAAS
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="create-a-custom-image.html">
	    Create a custom image
	  </a>
	</li>
	<li>
	  <a href="get-fancy-cli-output.html">
	    Get fancy CLI output
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-do-a-fresh-install-of-maas.html">
	    Do a fresh install of MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-use-availability-zones.html">
	    Use availability zones
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-images.html">
	  How to use images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-images.html">
	    Customise images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
	<li>
	  <a href="how-to-deploy-a-real-time-kernel.html">
	    Deploy a RT kernel
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-controllers.html">
	  How to manage controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-configure-controllers.html">
	    Configure controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-manage-machines.html">
	  How to manage machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-use-virtual-machines.html">
	  How to use virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-vm-hosts.html">
	    Manage VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-virtual-machines.html">
	    Manage virtual machines
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-devices.html">
	  How to label devices
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-secure-maas.html">
	  How to secure MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-use-hashicorp-vault-with-maas.html">
	    Use Vault with MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-operate-maas.html">
	  How to operate MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
	<li>
	  <a href="how-to-back-up-maas.html">
	    Back up MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-monitor-maas.html">
	    Monitor MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-audit-maas.html">
	    Audit MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-give-and-receive-help.html">
	  How to give and receive help
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-our-discourse-forum.html">
	    Use our discourse forum
	  </a>
	</li>
	<li>
	  <a href="how-to-contact-us">
	    Get support↗
	  </a>
	</li>
	<li>
	  <a href="how-to-request-new-features.html">
	    Request new features
	  </a>
	</li>
	<li>
	  <a href="how-to-review-and-report-bugs.html">
	    Review and report bugs
	  </a>
	</li>
	<li>
	  <a href="how-to-contribute-doc.html">
	    Contribute documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="general-reference.html">
	  General reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-settings-reference.html">
	    MAAS settings
	  </a>
	</li>
	<li>
	  <a href="https://launchpad.net/maas.html">
	    MAAS source code↗
	  </a>
	</li>
	<li>
	  <a href="how-to-help-improve-the-doc.html">
	    Doc style guide
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
	<li>
	  <a href="https://ubuntu.com/community/code-of-conduct">
	    Code of conduct↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api-reference.html">
	  API reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    Python API client
	  </a>
	</li>
	<li>
	  <a href="api">
	    API documentation↗
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-scripts-reference.html">
	  Scripts reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-reference.html">
	    Terraform
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-logs-reference.html">
	  Log reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="event-logs-reference.html">
	    Event logs
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs-reference.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="testing-logs-reference.html">
	    Testing logs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machine-parameters-reference.html">
	  Machine parameters reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="power-drivers-reference.html">
	    Power drivers
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="device-labelling-reference.html">
	    Device labelling
	  </a>
	</li>
      </ul>
      <strong>
	<a href=".html">
	  Explanation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="about-networking.html">
	    About networking
	  </a>
	</li>
	<li>
	  <a href="about-images.html">
	    About images
	  </a>
	</li>
	<li>
	  <a href="about-controllers.html">
	    About controllers
	  </a>
	</li>
	<li>
	  <a href="about-machines.html">
	    About machines
	  </a>
	</li>
	<li>
	  <a href="about-virtual-machines.html">
	    About virtual machines
	  </a>
	</li>
	<li>
	  <a href="about-device-labels.html">
	    About device labels
	  </a>
	</li>
	<li>
	  <a href="about-maas-events.html">
	    About MAAS events
	  </a>
	</li>
	<li>
	  <a href="about-maas-audit-events.html">
	    About audit events
	  </a>
	</li>
	<li>
	  <a href="about-maas-logging.html">
	    About MAAS logging
	  </a>
	</li>
	<li>
	  <a href="about-maas-security.html">
	    About MAAS security
	  </a>
	</li>
	<li>
	  <a href="about-maas-performance.html">
	    About MAAS performance
	  </a>
	</li>
	<li>
	  <a href="about-ansible.html">
	    About Ansible
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>How to spin up MAAS with Ansible</h1><!-- "How to spin up MAAS with Ansible" -->

<p>Ansible playbooks provide a straightforward way to install and configure MAAS (Metal as a Service). This documentation will guide you through the process of setting up and managing MAAS using Ansible.</p>
<p><a href="#heading--Installation-of-MAAS"><h2 id="heading--Installation-of-MAAS">Installation of MAAS</h2></a></p>
<p>To get started, follow these steps to install MAAS using Ansible:</p>
<ol>
<li>Clone the MAAS-ansible-playbook repository from GitHub:</li>
</ol>
<pre><code>git clone git@github.com:maas/maas-ansible-playbook
</code></pre>
<ol>
<li>
<p>Ensure that you have Ansible installed on the machine where you&rsquo;ll be running the playbook. The playbook has been tested with Ansible version 5.10.0 and above.</p>
</li>
<li>
<p>Verify that the <code>netaddr</code> Python library is installed on the machine running Ansible. </p>
</li>
</ol>
<p><strong>NOTE:</strong> 
Note that this library is not required on remote hosts.</p>
<p><a href="#heading--Installing-a-region-controller"><h2 id="heading--Installing-a-region-controller">Installing a region controller</h2></a></p>
<p>As an operator, you may want to install a MAAS region controller on a specific host using Ansible. Follow these steps to accomplish this:</p>
<ol>
<li>Assign the <code>maas_region_controller</code> role to your region controller host by adding the following to your inventory file:</li>
</ol>
<p><strong>INI Format</strong>:</p>
<pre><code>[maas_region_controller]
10.10.0.20 ansible_user=ubuntu
</code></pre>
<p><strong>YAML Format</strong>:</p>
<pre><code>all:
  maas_region_controller:
    hosts:
      10.10.0.20:
        ansible_user: ubuntu
</code></pre>
<ol>
<li>Set the required Ansible variables in the hosts file under the <code>[maas_region_controller]</code> group:</li>
</ol>
<pre><code>[maas_region_controller]
maas_version=&quot;latest&quot;
maas_installation_type=&quot;snap&quot;
maas_snap_channel=&quot;stable&quot;
maas_url=&quot;$Ip_Address&quot;
enable_tls=false
o11y_enable=false
admin_username=&quot;admin&quot;
admin_password=&quot;admin&quot;
admin_email=&quot;admin@email.com&quot;
admin_id=&quot;lp:admin&quot;
</code></pre>
<p><strong>NOTE:</strong> 
Note: Adjust the values accordingly for <code>maas_version</code>, <code>maas_installation_type</code>, <code>maas_snap_channel</code>, <code>maas_url</code>, <code>enable_tls</code>, <code>o11y_enable</code>, <code>admin_username</code>, <code>admin_password</code>, <code>admin_email</code>, and <code>admin_id</code>.
[\note]</p>
<ol>
<li>Run the playbook to install the region controller:</li>
</ol>
<pre><code>ansible-playbook -i ./hosts site.yaml
</code></pre>
<p>Upon successful execution, you should have a functional MAAS instance accessible from the specified MAAS host IP address.</p>
<p><a href="#heading--Installing-a-rack-controller"><h2 id="heading--Installing-a-rack-controller">Installing a rack controller</h2></a></p>
<p>To install a MAAS rack controller using Ansible, follow these steps:</p>
<ol>
<li>Assign the <code>maas_rack_controller</code> role to the desired host(s) in your Ansible hosts file:</li>
</ol>
<p><strong>INI Format</strong>:</p>
<pre><code>[maas_rack_controller]
$Host_Ip_Address extra_variable=$Variable_Value
$Second_Host_Ip
</code></pre>
<p><strong>YAML Format</strong>:</p>
<pre><code>all:
  maas_rack_controller:
    hosts:
      $Host_Ip_Address:
        extra_variable: $Variable_Value
      $Second_Host_Ip
</code></pre>
<ol>
<li>Set the required Ansible variables in the hosts file under the [maas_rack_controller] group:</li>
</ol>
<pre><code>[maas_rack_controller]
maas_version=&quot;latest&quot;
maas_installation_type=&quot;snap&quot;
maas_snap_channel=&quot;stable&quot;
maas_url=&quot;$Ip_Address&quot;
maas_rack_secret=
enable_tls=false
o11y_enable=false
</code></pre>
<p><strong>NOTE:</strong> 
Note: Adjust the values accordingly for <code>maas_version</code>, <code>maas_installation_type</code>, <code>maas_snap_channel</code>, <code>maas_url</code>, <code>maas_rack_secret</code>, <code>enable_tls</code>, and <code>o11y_enable</code>.</p>
<ol>
<li>Run the playbook to install the rack controller:</li>
</ol>
<pre><code>ansible-playbook -i ./hosts site.yaml
</code></pre>
<p>The rack controller should now be accessible at the specified host IP address.</p>
<p><a href="#heading--Uninstalling-MAAS"><h2 id="heading--Uninstalling-MAAS">Uninstalling MAAS</h2></a></p>
<p>If you need to revert the MAAS setup installed by the playbook, follow these steps to uninstall MAAS:</p>
<ol>
<li>
<p>Identify the entry-point within the playbook that corresponds to tearing down the MAAS installation.  Optionally, back up the MAAS database and configuration.</p>
</li>
<li>
<p>Run the playbook from the identified entry-point to remove the installation:</p>
</li>
</ol>
<pre><code>ansible-playbook -i ./hosts teardown.yaml
</code></pre>
<p>This will remove all MAAS packages or snaps, restoring the machine to its pre-installation state.</p>
<p><a href="#heading--Configuring-MAAS-high-availability-(HA)"><h2 id="heading--Configuring-MAAS-high-availability-(HA)">Configuring MAAS high availability (HA)</h2></a></p>
<p>To set up high availability for MAAS using Ansible, including a reverse proxy and HA region controllers, follow these steps:</p>
<ol>
<li>Assign the maas_proxy role to the desired host acting as the reverse proxy in your Ansible hosts file:</li>
</ol>
<pre><code>[maas_proxy]
my.host ansible_user=ssh_user
</code></pre>
<ol>
<li>
<p>Run the full playbook or use the <code>--tags maas_proxy</code> option to execute the tasks specific to the <code>maas_proxy</code> role.</p>
</li>
<li>
<p>Verify that HAProxy is forwarding traffic by running the following command:</p>
</li>
</ol>
<pre><code>curl -L http://&lt;haproxy_host&gt;:5240/MAAS
</code></pre>
<p>If HAProxy is not on a separate host, replace <code>&lt;haproxy_host&gt;</code> with the appropriate host IP and port (e.g., 5050).</p>
<p><strong>NOTE:</strong> 
Note that the playbook optimizes the HAProxy configuration to ensure smooth operation, including proper handling of OS image uploads and quick removal of unresponsive region controllers. The HAProxy instance does not interfere with Nginx/MAAS TLS configuration.</p>
<p><a href="#heading--Installing-HA-PostgreSQL"><h2 id="heading--Installing-HA-PostgreSQL">Installing HA PostgreSQL</h2></a></p>
<p>To install a high-availability PostgreSQL database cluster for MAAS using Ansible, follow these steps:</p>
<ol>
<li>Assign the <code>maas_postgres</code> and <code>maas_corosync</code> roles to the desired hosts in your Ansible hosts file:</li>
</ol>
<p><strong>INI Format</strong>:</p>
<pre><code>[maas_corosync]
my.db1 ansible_user=ssh_user
my.db2 ansible_user=ssh_user
my.db3 ansible_user=ssh_user

[maas_pacemaker:children]
maas_corosync

[maas_postgres]
my.db1 ansible_user=ssh_user
my.db2 ansible_user=ssh_user
my.db3 ansible_user=ssh_user
</code></pre>
<p><strong>YAML Format</strong>:</p>
<pre><code>all:
  maas_pacemaker:
    children:
      maas_corosync:
        hosts:
          - my.db1
          - my.db2
          - my.db3
  maas_postgres:
    hosts:
      - my.db1
      - my.db2
      - my.db3
</code></pre>
<ol>
<li>Set the required Ansible variables in the hosts file under the <code>[maas_pacemaker]</code> group:</li>
</ol>
<pre><code>[maas_pacemaker]
maas_pacemaker_fencing_driver=&quot;$stonith_driver&quot;
maas_pacemaker_stonith_params=&quot;$stonith_parameters&quot;

[maas_postgres]  # HA-related variables
maas_postgres_floating_ip=&quot;$vIP&quot;
maas_postgres_floating_ip_prefix_len=&quot;$vIP_masklen&quot;
</code></pre>
<p><strong>NOTE:</strong> 
Note: Adjust the values accordingly for <code>maas_pacemaker_fencing_driver</code>, <code>maas_pacemaker_stonith_params</code>, <code>maas_postgres_floating_ip</code>, and <code>maas_postgres_floating_ip_prefix_len</code>.</p>
<ol>
<li>Run the playbook or use the <code>--tags maas_ha_postgres</code> option to execute the tasks specific to the HA PostgreSQL installation.</li>
</ol>
<p><strong>NOTE:</strong> 
Note: The playbook installs the latest supported version of PostgreSQL for the given MAAS version. If the playbook is run with other roles set on targeted hosts or groups, the tasks associated with the <code>maas_postgresql</code> role will run first. If you wish to import a backup, ensure the appropriate variable is set.</p>
<p><a href="#heading--Enabling-observability-capabilities"><h2 id="heading--Enabling-observability-capabilities">Enabling observability capabilities</h2></a></p>
<p>To export MAAS metrics and logs to your observability stack using Ansible, follow these steps:</p>
<ol>
<li>Set the following Ansible variables in the hosts file:</li>
</ol>
<pre><code>[all]
o11y_enable=true
o11y_prometheus_url=http://$prometheus_ip:9090/api/v1/write
o11y_loki_url=http://$loki:3100/loki/api/v1/push
</code></pre>
<p>Optionally, you can set o11y_enable only on hosts of interest.</p>
<ol>
<li>Run the playbook to install and configure the Grafana Agent service on the relevant roles:</li>
</ol>
<pre><code>ansible-playbook -i ./hosts site.yaml
</code></pre>
<p>By default, both metrics and logs are exported. You can disable either one by omitting the respective endpoint definition. Ensure that your Prometheus server is running with the remote-write-receiver feature enabled to receive metrics pushed by the agents.</p>
<ol>
<li>Optionally, you can export the observability alert rules using the following command:</li>
</ol>
<pre><code>ansible-playbook --extra-vars=&quot;o11y_alertrules_dest=/tmp&quot; ./alertrules.yaml
</code></pre>
<p>The resulting files (<code>loki-alert-rules.yml</code> and <code>prometheus-alert-rules.yml</code>) should be installed in your Loki and Prometheus servers, respectively. Refer to the MAAS documentation for <a href="how-to-monitor-maas.html">setting up a basic observability stack</a>.</p>
<p>Please refer to the <a href="https://github.com/maas/maas-ansible-playbook#maas-ansible-playbook">specific Ansible playbooks and README instructions</a> for further details and advanced usage.</p>
    </div>
  </body>
</html>