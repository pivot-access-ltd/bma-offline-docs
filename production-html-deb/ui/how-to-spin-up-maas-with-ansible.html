<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;
      <strong>Offline docs
      </strong>
      <a href="https://maas.io/docs">(switch to live docs)
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  UI-only
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/how-to-spin-up-maas-with-ansible.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
      </ul>
      <strong>
	<a href="basic-tutorials.html">
	  Basic tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-bootstrap-tutorial.html">
	    MAAS bootstrap tutorial
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="custom-image-tutorial.html">
	    Custom image tutorial
	  </a>
	</li>
	<li>
	  <a href="using-jq-with-the-maas-cli.html">
	    Using jq with the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-change-maas-settings.html">
	    Change MAAS settings
	  </a>
	</li>
	<li>
	  <a href="how-to-get-help.html">
	    Ask for help
	  </a>
	</li>
	<li>
	  <a href="how-to-request-a-feature.html">
	    Request a feature
	  </a>
	</li>
	<li>
	  <a href="how-to-report-a-bug.html">
	    Report a bug
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-acquire-images.html">
	  How to acquire images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-build-custom-images.html">
	    Build custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-tune-controllers.html">
	  How to tune controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-adjust-your-controllers.html">
	    Adjust your controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-physical-machines.html">
	  How to deploy physical machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-virtual-machines.html">
	  How to deploy virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-create-vm-hosts.html">
	    Create VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-create-and-manage-vms.html">
	    Create and manage VMs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-and-find-machines.html">
	  How to label and find machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
      </ul>
      <strong>
	How to diagnose issues
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-log-files.html">
	    Work with log files
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-audit-event-logs.html">
	    Work with audit event logs
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	How to work securely
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
      </ul>
      <strong>
	How to operate reliably
      </strong>
      <ul>
	<li>
	  <a href="how-to-keep-maas-backed-up.html">
	    Keep MAAS backed up
	  </a>
	</li>
	<li>
	  <a href="how-to-observe-a-live-maas.html">
	    Observe a live MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-protect-your-secrets.html">
	How to protect your secrets
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-enable-vault.html">
	    Enable Vault
	  </a>
	</li>
	<li>
	  <a href="how-to-unseal-vault.html">
	    Unseal Vault
	  </a>
	</li>
      </ul>
      <strong>
	API reference
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="../../api/docs">
	    API documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-technical-reference.html">
	  MAAS technical reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="audit-event-log-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="maas-performance.html">
	    MAAS performance
	  </a>
	</li>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-provider-reference.html">
	    Terraform provider
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>How to spin up MAAS with Ansible</h1><!-- "How to spin up MAAS with Ansible" -->

<p><a href="#heading--MAAS-region-controller"><h2 id="heading--MAAS-region-controller">How to install a region controller with Ansible</h2></a></p>
<p>As an operator, you want to install a MAAS region controller onto a given host using Ansible. To accomplish this, you must:</p>
<ol>
<li>Attach the <code>maas_region_controller</code> role to your region controller host by adding the following to the <a href="https://docs.ansible.com/ansible/latest/user_guide/intro_inventory.html#inventory-basics-formats-hosts-and-groups">Inventory file</a><code>↗</code>.   In the example below, we&rsquo;ve attached the region controller role to a host running on <code>10.10.0.20</code> with the user <code>ubuntu</code>:</li>
</ol>
<p>INI:</p>
<pre><code class="language-INI">[maas_region_controller]
10.10.0.20 ansible_user=ubuntu
</code></pre>
<p>YAML:</p>
<pre><code class="language-YAML">all:
  maas_region_controller:
    hosts:
      10.10.0.20:
        ansible_user: ubuntu
</code></pre>
<ol>
<li>Set the following Ansible variables in the <code>hosts</code> file:</li>
</ol>
<p><code>[maas_region_controller]</code> variables:</p>
<pre><code>maas_version: &quot;latest&quot;          # The version of MAAS to install on the host
maas_installation_type: &quot;snap&quot;  # The installation manager to use (snap or deb)
maas_snap_channel: &quot;stable&quot;     # The snap channel, if using snap
maas_url: $Ip_Address           # The url of the database for this MAAS
enable_tls: false               # Whether TLS should be enabled for this MAAS
o11y_enable: false              # Whether observability should be enabled for this MAAS

# Details for the administrative account
admin_username: &quot;admin&quot;
admin_password: &quot;admin&quot;
admin_email: &quot;admin@email.com&quot;
admin_id: &quot;lp:admin&quot;            # Either lp:user-id (Launchpad) or gh:user-id (Github)
</code></pre>
<ol>
<li>Run the playbook to install the region controller.  A successful run of the playbook should give the operator an accessible and ready MAAS instance.</li>
</ol>
<p>Some important notes on installation:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>The default installation is a snap.</li>
<li>The installed region controller is used to set a <code>maas_url</code> variable when there is not one already set for later Rack Controller configuration use.</li>
<li>The operator can optionally enable TLS.</li>
<li>The playbook sets up the admin user.</li>
<li>The playbook adds any provided preseeds.</li>
<li>The playbook only installs the <code>maas-region-api</code> deb if the operator chooses the <code>deb</code> installation.</li>
<li>Once the region controller is installed, the playbook will run migrations using the configured postgresql primary instance.</li>
<li>Running on an already configured machine &ndash; but with a new version &ndash; should upgrade the instance.</li>
<li>The operator can override the postgres DSN variable on any machine (hence not defining any <code>maas_postgres</code> host) to use an existing PostgreSQL instance not managed by this playbook.</li>
<li>These variables can be also be defined at the Ansible command line using the <code>--extra_vars</code> argument.</li>
<li>The playbook uses an ansible variable to determine what version of MAAS to deploy.  The playbook won’t execute (i.e “skipped” in the context of Ansible) if <code>host_vars</code> show the Ubuntu version is incompatible with the version and install method.  </li>
<li>The Region Controller tasks should be able to execute on multiple hosts in a single execution if the target is an Ansible Group rather than a single host.</li>
</ul>
<p><a href="#heading--Finding-the-new-region-controller"><h3 id="heading--Finding-the-new-region-controller">Finding the new region controller</h3></a></p>
<p>You can find the newly-installed region controller at the specified MAAS host IP address, as though the controller had been installed manually.</p>
<p><a href="#heading--MAAS-rack-controller"><h2 id="heading--MAAS-rack-controller">How to install a rack controller with Ansible</h2></a></p>
<p>As an operator, you want to install a MAAS rack controller to a given host, using Ansible. To accomplish this, you must: </p>
<ol>
<li>Assign a host to the <code>maas_rack_controller</code> role in the Ansible <code>hosts</code> file:</li>
</ol>
<p>INI</p>
<pre><code class="language-INI">[maas_rack_controller]
$Host_Ip_Address extra_variable=$Variable_Value
$Second_Host_Ip
</code></pre>
<p>YAML</p>
<pre><code>all:
  maas_rack_controller:
    hosts:
      $Host_Ip_Address:
        extra_variable: $Variable_Value
      $Second_Host_Ip
</code></pre>
<ol>
<li>Set the following Ansible variables in the <code>Hosts</code> file:</li>
</ol>
<p><code>[maas_rack_controller]</code> Variables</p>
<pre><code class="language-bash">maas_version: &quot;latest&quot;          # The version of MAAS to install on the host
maas_installation_type: &quot;snap&quot;  # The installation manager to use
maas_snap_channel: &quot;stable&quot;     # The snap channel, if using snap
maas_url: $Ip_Address           # The url of the region controller for this MAAS
maas_rack_secret:               # The secret used to enroll a MAAS rack
enable_tls: false               # Whether TLS should be enabled for this MAAS
o11y_enable: false              # Whether observability should be enabled for this MAAS
</code></pre>
<ol>
<li>Run the Ansible playbook to install the region controller.</li>
</ol>
<p>Some notes about installation:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>When running the playbook for a host with the <code>maas_rack_controller</code> role, the playbook installs the MAAS Rack Controller on the specified hosts.</li>
<li>The <code>maas_url</code> variable is used to connect the Region Controller(s), either previously configured from a Region Controller install task, or provided by the user. </li>
<li>If the <code>maas_url</code> variable is not set, the Rack Controller tasks are “skipped”.  Some notes about the installation:</li>
<li>The operator can optionally enable TLS.</li>
<li>The rack controller tasks should be able to execute on multiple hosts in a single execution if an Ansible Group is targeted rather than a single host.</li>
<li>Only install the maas-rack-controller deb if using the deb installation.</li>
<li>Running on an already configured machine but with a new version should upgrade the instance.</li>
<li>You can optionally install a grafana agent by setting the <code>o11y_enable</code> variable to <code>true</code> either in the hosts file or at the command line.</li>
</ul>
<p><a href="#heading--Finding-the-new-rack-controller"><h3 id="heading--Finding-the-new-rack-controller">Finding the new rack controller</h3></a></p>
<p>The rack controller should be accessible at the specified host IP address, just as if you had installed it there manually.</p>
<p><a href="#heading--MAAS-de-installation"><h3 id="heading--MAAS-de-installation">How to uninstall MAAS with Ansible</h3></a></p>
<p>As an operator, you want to be able to revert the MAAS setup installed by this playbook, such that the machine is clean of all MAAS packages or snaps.  In order to teardown a MAAS deployment, do the following:</p>
<ol>
<li>
<p>Find the entry-point within the playbook to teardown the installed MAAS packages or snaps.  </p>
</li>
<li>
<p>Back up the database and MAAS configuration, if desired.  Note that the target machine is restored state prior to installation, with no MAAS, directories, or files present on the system.</p>
</li>
<li>
<p>Run the playbook from this entry-point to remove the installation.</p>
</li>
</ol>
<p>Running this playbook with the default configuration with perfectly undo the default installation.</p>
<p><a href="#heading--MAAS-high-availability"><h3 id="heading--MAAS-high-availability">How to configure MAAS HA with Ansible</h3></a></p>
<p>As an operator, you want to install a reverse proxy and configure high-availability region controllers for a given host using Ansible.  Note that HA region controllers require an HAProxy configuration.</p>
<p>You can accomplish this with the following steps:</p>
<ol>
<li>Set the following in the <code>hosts</code> file to set the <code>maas_proxy</code> role:</li>
</ol>
<pre><code class="language-nohighlight">[maas_proxy]
my.host ansible_user=ssh_user
</code></pre>
<ol>
<li>
<p>Run the full playbook, or add <code>--tags maas_proxy</code> to run only the tasks for this role.</p>
</li>
<li>
<p>Verify that the HAProxy is forwarding traffic by running the following if HAProxy is on a separate host from the region controller:</p>
</li>
</ol>
<pre><code class="language-nohighlight">curl -L http://&lt;haproxy host&gt;:5240/MAAS`
</code></pre>
<ol>
<li>If HAProxy is not on a separate host, change the port number to 5050 when you run the command, like this:</li>
</ol>
<pre><code class="language-nohighlight">curl -L http://&lt;haproxy host&gt;:5050/MAAS
</code></pre>
<p>Note that the playbook configures the HAProxy instance for optimal use, such that OS images can be uploaded (for example). An unresponsive Region Controller is taken out of the upstream pool quickly. The HAProxy instance does not interfere with Nginx/MAAS TLS configuration</p>
<p><a href="#heading--PostgreSQL-HA"><h2 id="heading--PostgreSQL-HA">How to install HA PostgreSQL</h2></a></p>
<p>As an operator, you want to install a HA Postgresql database cluster to a given set of hosts using Ansible. You can accomplish this with the following steps:</p>
<ol>
<li>Set the following in the <code>hosts</code> file to set the <code>maas_postgres</code> and <code>maas_corosync</code> roles:</li>
</ol>
<pre><code class="language-nohighlight">[maas_corosync]
my.db1 ansible_user=ssh_user
my.db2 ansible_user=ssh_user
my.db3 ansible_user=ssh_user

[maas_pacemaker:children]
maas_corosync

[maas_postgres]
my.db1 ansible_user=ssh_user
my.db2 ansible_user=ssh_user
my.db3 ansible_user=ssh_user
</code></pre>
<ol>
<li>Set the following Ansible variables in the <code>Hosts</code> file:</li>
</ol>
<p><code>[maas_pacemaker]</code> Variables</p>
<pre><code class="language-bash"># Fencing configuration
maas_pacemaker_fencing_driver: $stonith_driver
maas_pacemaker_stonith_params: $stonith_parameters
</code></pre>
<p><code>[maas_postgres]</code> HA-related variables</p>
<pre><code class="language-bash">maas_postgres_floating_ip: $vIP
maas_postgres_floating_ip_prefix_len: $vIP_masklen
</code></pre>
<ol>
<li>
<p>Run the full playbook, or add <code>--tags maas_ha_postgres</code> to run only the tasks for this roles.</p>
</li>
<li>
<p>Verify the primary by running <code>sudo -u postgres psql</code> and making sure you get a prompt.</p>
</li>
</ol>
<p>Note that Ansible installs the latest supported version of PostgreSQL supported for the given MAAS version. If the playbook runs with other roles set on targeted hosts / groups, the tasks associated with the <code>maas_postgresql</code> role runs first. If the operator sets a variable for importing a backup, the backup is loaded into PostgreSQL.</p>
<p><a href="#heading--o11y"><h2 id="heading--o11y">How to enable Observability capabilities</h2></a></p>
<p>As an operator, you want to export metrics and logs to your observability stack using Ansible. You can accomplish this with the following steps:</p>
<ol>
<li>Set the following Ansible variables in the <code>Hosts</code> file:</li>
</ol>
<p><code>[all]</code> Variables</p>
<pre><code class="language-bash">o11y_enable: true
o11y_prometheus_url: http://$prometheus_ip:9090/api/v1/write
o11y_loki_url: http://$loki:3100/loki/api/v1/push
</code></pre>
<p>Optionally you can set <code>o11y_enable</code> only on hosts of interest.</p>
<ol>
<li>Run the playbook</li>
</ol>
<p>This installs and configures the <code>grafana-agent</code> service on all roles that support it. You can disable either metrics or logs export by omitting the respective endpoint definition. You need to run the Prometheus server with the <code>remote-write-receiver</code> feature enabled in order to receive metrics pushed by the agents.</p>
<p>MAAS has a curated collection of alert rules for Prometheus and Loki. You can export these rules using the following command, where <code>o11y_alertrules_dest</code> is the directory where the files should me placed.</p>
<pre><code class="language-bash">ansible-playbook --extra-vars=&quot;o11y_alertrules_dest=/tmp&quot; ./alertrules.yaml
</code></pre>
<p>The resulting files (<code>loki-alert-rules.yml</code> and <code>prometheus-alert-rules.yml</code>) should be installed in the Loki and Prometheus servers respectively. See https://maas.io/docs/how-to-monitor-maas for a basic observability stack setup.</p>
<!--
<a href="#heading--Firewall-rules"><h2 id="heading--Firewall-rules">Firewall rules</h2></a>

As a operator, you want to be able to setup MAAS in a secure way, following best practices and operational guidance on securing MAAS. In order to make a MAAS setup secure, I would Ansible playbooks to configure firewalls and file permissions based on https://maas.io/docs/how-to-secure-maas.


<a href="#heading--PostgreSQL-role-bundling-scripts"><h2 id="heading--PostgreSQL-role-bundling-scripts">PostgreSQL role bundling scripts</h2></a> -->
    </div>
  </body>
</html>