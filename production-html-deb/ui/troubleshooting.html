<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  UI-only
      </span>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../cli/troubleshooting.html">
	  CLI-only
	</a>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation.html">
	  Introduction
	</a>
      </strong>
      <ul>
	<li>
	  <a href="about-maas.html">
	    About MAAS
	  </a>
	</li>
	<li>
	  <a href="give-me-an-example-of-maas.html">
	    &ldquo;Give me an example&rdquo;
	  </a>
	</li>
	<li>
	  <a href="whats-new-in-maas.html">
	    What&rsquo;s new in 2.9
	  </a>
	</li>
	<li>
	  <a href="maas-requirements.html">
	    Requirements
	  </a>
	</li>
	<li>
	  <a href="maas-installation.html">
	    Installation
	  </a>
	</li>
	<li>
	  <a href="configuration-journey.html">
	    Configuration journey
	  </a>
	</li>
      <strong>
	<a href="controllers.html">
	  Controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-communication.html">
	    Communication
	  </a>
	</li>
	<li>
	  <a href="rack-controllers.html">
	    Rack controllers
	  </a>
	</li>
	<li>
	  <a href="region-controllers.html">
	    Region controllers
	  </a>
	</li>
	<li>
	  <a href="high-availability.html">
	    High availability
	  </a>
	</li>
      </ul>
      <strong>
	<a href="machines.html">
	  Machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="add-machines.html">
	    Add machines
	  </a>
	</li>
	<li>
	  <a href="power-management.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="commission-machines.html">
	    Commission machines
	  </a>
	</li>
	<li>Testing
	</li>
	<li>
	  <a href="hardware-testing.html">
	    Hardware testing
	  </a>
	</li>
	<li>
	  <a href="network-testing.html">
	    Network testing
	  </a>
	</li>
	<li>
	  <a href="commissioning-and-hardware-testing-scripts.html">
	    Commissioning and hardware testing scripts
	  </a>
	</li>
	<li>
	  <a href="deploy-machines.html">
	    Deploy machines
	  </a>
	</li>
	<li>
	  <a href="maas-tags.html">
	    Tags
	  </a>
	</li>
	<li>
	  <a href="custom-machine-setup.html">
	    Custom machine setup
	  </a>
	</li>
	<li>
	  <a href="kernel-boot-options.html">
	    Kernel boot options
	  </a>
	</li>
	<li>
	  <a href="resource-pools.html">
	    Resource pools
	  </a>
	</li>
	<li>
	  <a href="storage.html">
	    Storage
	  </a>
	</li>
	<li>
	  <a href="vmware-vmfs-datastores.html">
	    VMware VMFS datastores
	  </a>
	</li>
	<li>
	  <a href="ubuntu-kernels.html">
	    Ubuntu kernels
	  </a>
	</li>
      </ul>
      <strong>
	<a href="images.html">
	  Images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="select-and-import-images.html">
	    Select and import images
	  </a>
	</li>
	<li>
	  <a href="local-image-mirror.html">
	    Local image mirror
	  </a>
	</li>
	<li>
	  <a href="vmware-images.html">
	    VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="networking.html">
	  Networking
	</a>
      </strong>
      <ul>
	<li>
	  <a href="subnet-management.html">
	    Subnet management
	  </a>
	</li>
	<li>
	  <a href="managing-dhcp.html">
	    DHCP
	  </a>
	</li>
	<li>
	  <a href="ip-ranges.html">
	    IP ranges
	  </a>
	</li>
	<li>
	  <a href="proxy.html">
	    Proxy
	  </a>
	</li>
	<li>
	  <a href="ntp-services.html">
	    NTP
	  </a>
	</li>
	<li>
	  <a href="network-discovery.html">
	    Network discovery
	  </a>
	</li>
	<li>
	  <a href="ipv6-addressing.html">
	    IPv6
	  </a>
	</li>
	<li>
	  <a href="configuring-tls-encryption.html">
	    SSL
	  </a>
	</li>
	<li>
	  <a href="managing-stp.html">
	    STP
	  </a>
	</li>
	<li>
	  <a href="availability-zones.html">
	    Availability zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="vm-hosting.html">
	  VM hosting
	</a>
      </strong>
      <ul>
	<li>
	  <a href="vm-host-networking.html">
	    VM host networking
	  </a>
	</li>
	<li>
	  <a href="adding-a-vm-host.html">
	    Add a VM host
	  </a>
	</li>
	<li>
	  <a href="vm-host-storage-pools.html">
	    VM host storage pools
	  </a>
	</li>
	<li>
	  <a href="creating-and-deleting-vms.html">
	    Creating and deleting VMs
	  </a>
	</li>
      </ul>
      <strong>Operations
      </strong>
      <ul>
	<li>
	  <a href="prometheus-metrics.html">
	    Prometheus metrics
	  </a>
	</li>
	<li>
	  <a href="backup.html">
	    Backup
	  </a>
	</li>
	<li>
	  <a href="hardening-your-maas-installation.html">
	    MAAS security
	  </a>
	</li>
	<li>
	  <a href="maas-logging.html">
	    Logging
	  </a>
	</li>
	<li>
	  <a href="commissioning-logs.html">
	    Commissioning logs
	  </a>
	</li>
	<li>
	  <a href="user-accounts.html">
	    User accounts
	  </a>
	</li>
	<li>
	  <a href="interactive-search.html">
	    Interactive search
	  </a>
	</li>
      </ul>
      <strong>
	<a href="concepts-and-terms.html">
	  Concepts &amp; terms
	</a>
      </strong>
      <ul>
	<li>
	  <a href="concepts-and-terms.html#heading--network-tutorial">
	    Brief network tutorial
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-cli.html">
	  CLI
	</a>
      </strong>
      <ul>
	<li>
	  <a href="common-cli-tasks.html">
	    The CLI cookbook
	  </a>
	</li>
	<li>
	  <a href="common-cli-tasks.html">
	    Common tasks
	  </a>
	</li>
	<li>
	  <a href="audit-event-logs.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="cli-kernel-management.html">
	    Kernel management
	  </a>
	</li>
	<li>
	  <a href="cli-image-management.html">
	    Image management
	  </a>
	</li>
	<li>
	  <a href="cli-interface-management.html">
	    Interface management
	  </a>
	</li>
	<li>
	  <a href="cli-advanced-tasks.html">
	    Advanced tasks
	  </a>
	</li>
	<li>
	  <a href="cli-composable-hardware.html">
	    Composable hardware
	  </a>
	</li>
	<li>
	  <a href="python-api-client.html">
	    API client
	  </a>
	</li>
      </ul>
      <strong>
	<a href="api.html">
	  API documentation
	</a>
      </strong>
      <ul>
	<li>
	  <a href="api-authentication.html">
	    API authentication
	  </a>
	</li>
      </ul>
      <strong>
	<a href="troubleshooting.html">
	  Troubleshoot
	</a>
      </strong>
      <ul>
	<li>
	  <a href="getting-help.html">
	    Getting help
	  </a>
	</li>
	<li>
	  <a href="tips-tricks-and-traps.html">
	    Tips, tricks, and traps
	  </a>
	</li>
	<li>
	  <a href="https://old-docs.maas.io/2.5/en/">
	    MAAS 2.5 (+ earlier) doc
	  </a>
	</li>
      </ul>
      <strong>
	<a href="whats-new-in-maas.html">
	  Release notes
	</a>
      </strong>
      <p/>
      <strong>
	<a href="writing-guide.html">
	  Help improve these docs
	</a>
      </strong>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>Troubleshooting</h1><p>This section covers some of the most commonly encountered problems and attempts to resolve them.</p>
<p><a href="#heading--machine-login-issues"><h2 id="heading--machine-login-issues">Can&rsquo;t login to machine after deployment</h2></a></p>
<p>When everything seems to be right about your machine deployment, but you can&rsquo;t login, there&rsquo;s a chance you might not be using the right username.  You may have added your personal SSH key to MAAS, but your corresponding login doesn&rsquo;t seem to work; that&rsquo;s because the logins for the machines are generally related to the operating system, e.g.:</p>
<ul>
<li>
<p>For machines deploying Ubuntu, the username is <code>ubuntu</code>, and the login would be <code>ubuntu@$MACHINE_IP</code>.</p>
</li>
<li>
<p>For machines deploying CentOS 7, the username is <code>centos</code>, and the login would be <code>centos@$MACHINE_IP</code>.</p>
</li>
<li>
<p>For machines deploying CentOS 8, the username is <code>cloud-user</code>, and the login would be <code>cloud-user@$MACHINE_IP</code>.</p>
</li>
</ul>
<p>Note there is a trick for determining the correct machine login, which works on many different versions of Linux.  If you attempt to <code>ssh root@$MACHINE_IP</code>, this will fail, but often tells you which user you should be using. </p>
<p><a href="#heading--django-subarch-error"><h2 id="heading--django-subarch-error">Subarchitecture error thrown by django</h2></a></p>
<p>Occassionally, you may encounter an error similar to this one:</p>
<pre><code>django.core.exceptions.ValidationError: ['Subarchitecture(&lt;value&gt;) must be generic when setting hwe_kernel.']
</code></pre>

<p>One potential solution for this problem is to specify a different commissioning kernel, such as upgrading from Xenial to Focal, etc.  </p>
<p><a href="#heading--nodes-hang-on-commissioning"><h2 id="heading--nodes-hang-on-commissioning">Nodes hang on &ldquo;Commissioning&rdquo;</h2></a></p>
<p><a href="#heading--possible-cause-timing-issues"><h3 id="heading--possible-cause-timing-issues">Possible Cause: Timing issues</h3></a></p>
<p>Various parts of MAAS rely on OAuth to negotiate a connection to nodes. If the current time reported by the hardware clock on your node differs significantly from that on the MAAS server, the connection will not be made.</p>
<p><strong>SOLUTION:</strong> Check that the hardware clocks are consistent, and if necessary, adjust them. This can usually be done from within the system BIOS, without needing to install an OS.</p>
<p><a href="#heading--possible-cause-network-drivers"><h3 id="heading--possible-cause-network-drivers">Possible Cause: Network drivers</h3></a></p>
<p>Sometimes the hardware can boot from PXE, but fail to load correct drivers when booting the received image. This is sometimes the case when no open source drivers are available for the network hardware.</p>
<p><strong>SOLUTION:</strong> The best fix for this problem is to install a Linux-friendly network adaptor. It <em>is</em> theoretically possible to modify the boot image to include proprietary drivers, but it is not a straightforward task.</p>
<p><a href="#heading--node-deployment-fails"><h2 id="heading--node-deployment-fails">Node deployment fails</h2></a></p>
<p>When deployment fails the <a href="concepts-and-terms.html#heading--rescue-mode">Rescue mode</a> action can be used to boot ephemerally into the node, followed by an investigation.</p>
<p>As an example, an improperly configured PPA was added to MAAS which caused nodes to fail deployment. After entering Rescue mode and connecting via SSH, the following was discovered in file <code>/var/log/cloud-init-output.log</code>:</p>
<pre><code class="no-highlight">2016-11-28 18:21:48,982 - cc_apt_configure.py[ERROR]: failed to add apt GPG Key
to apt keyring
Traceback (most recent call last):
  File &quot;/usr/lib/python3/dist-packages/cloudinit/config/cc_apt_configure.py&quot;,
line 540, in add_apt_key_raw
    util.subp(['apt-key', 'add', '-'], data=key.encode(), target=target)
  File &quot;/usr/lib/python3/dist-packages/cloudinit/util.py&quot;, line 1836, in subp
    cmd=args)
cloudinit.util.ProcessExecutionError: Unexpected error while running command.
Command: ['apt-key', 'add', '-']
Exit code: 2
Reason: -
Stdout: ''
Stderr: 'gpg: no valid OpenPGP data found.\n'
</code></pre>

<p>In this instance, the GPG fingerprint was used instead of the GPG key. After rectifying this oversight, nodes were again able to successfully deploy.</p>
<p><a href="#heading--nodes-fail-to-pxe-boot"><h2 id="heading--nodes-fail-to-pxe-boot">Nodes fail to PXE boot</h2></a></p>
<p><a href="#heading--possible-cause-using-an-incorrectly-configured-vm"><h3 id="heading--possible-cause-using-an-incorrectly-configured-vm">Possible Cause: Using an incorrectly</a> configured VM</h3></p>
<p>Some virtual machine setups include emulation of network hardware that does not support PXE booting, and in most setups, you will need to explicitly set the VM to boot via PXE.</p>
<p><strong>SOLUTION</strong>: Consult the VM docs for details on PXE booting.</p>
<p><a href="#heading--possible-cause-dhcp-conflict"><h3 id="heading--possible-cause-dhcp-conflict">Possible Cause: DHCP conflict</h3></a></p>
<p>If you are using MAAS in a setup with an existing DHCP, <em>DO NOT SET UP THE MAAS DHCP SERVER</em> as this will cause no end of confusion to the rest of your network and most likely won&rsquo;t discover any nodes either.</p>
<p><strong>SOLUTION</strong>: You will need to configure your existing DHCP server to point to the MAAS server.</p>
<p><a href="#heading--cant-log-in-to-node"><h2 id="heading--cant-log-in-to-node">Can&rsquo;t log in to node</h2></a></p>
<p>Sometimes you may wish to log in directly to a node on your system. If you have set up Juju and MAAS, the node will automatically have SSH authentication enabled (and public keys installed) allowing you to log in. There is also an option in the MAAS web interface to add new SSH keys to the nodes (via Preferences in the drop down menu which appears when clicking your username in the top-right of the page).</p>
<p><a href="#heading--forgot-maas-administrator-password"><h2 id="heading--forgot-maas-administrator-password">Forgot MAAS administrator password</h2></a></p>
<p>As long as you have sudo privileges the <code>maas</code> command can be used to change the password for a MAAS administrator on the MAAS region controller:</p>
<pre><code class="bash">sudo maas changepassword $PROFILE
</code></pre>

<p>where $PROFILE is the name of the user.</p>
<p><a href="#heading--need-to-reconfigure-server-ip-address"><h2 id="heading--need-to-reconfigure-server-ip-address">Need to reconfigure server IP address</h2></a></p>
<p>If you made a mistake during setup or you just need to reconfigure your MAAS server, you can simply run the setup again:</p>
<pre><code class="bash">sudo dpkg-reconfigure maas-region-controller
</code></pre>

<p><a href="#heading--cant-find-maas-web-ui"><h2 id="heading--cant-find-maas-web-ui">Can&rsquo;t find MAAS web UI</h2></a></p>
<p>By default, the web UI is located at <code>http://&lt;hostname&gt;:5240/MAAS/</code>. If you can&rsquo;t access it, there are a few things to try:</p>
<ol>
<li>Check that the webserver is running - By default the web interface uses Apache, which runs under the service name <em>apache2</em>. To check it, on the MAAS server box you can run <code>sudo /etc/init.d/apache2 status</code>.</li>
<li>Check that the hostname is correct - It may seem obvious, but check that the hostname is being resolved properly. Try running a browser (even a text mode one like <code>elinks</code>) on the same box as the MAAS server and navigating to the page. If that doesn&rsquo;t work, try <code>http://127.0.0.1:5240/MAAS/</code>, which will always point at the local server.</li>
<li>If you are still getting &ldquo;404 - Page not found&rdquo; errors, check that the MAAS web interface has been installed in the right place. There should be a file present called <code>/usr/share/maas/maas/urls.py</code>.</li>
</ol>
<p><a href="#heading--backdoor-image-login"><h2 id="heading--backdoor-image-login">Backdoor image login</h2></a></p>
<p>Ephemeral images are used by MAAS to boot nodes during commissioning, as well as during deployment. By design, these images are not built to be edited or tampered with, instead they&rsquo;re used to probe the hardware and launch <a href="https://launchpad.net/cloud-init">cloud-init</a>.</p>
<p>However, if you find yourself with no other way to access a node, especially if a node fails during commissioning, Linux-based ephemeral images can be modified to enable a <em>backdoor</em> that adds or resets a user&rsquo;s password. You can then login to check the <strong>cloud-init</strong> logs, for example, and troubleshoot the problem.</p>
<p>As images are constantly updated and refreshed, the backdoor will only ever be temporary, but it should help you login to see what may be going wrong with your node.</p>
<p><a href="#heading--extract-the-cloud-image"><h3 id="heading--extract-the-cloud-image">Extract the cloud image</h3></a></p>
<p>First, download the cloud image that corresponds to the architecture of your node. The <em>Images</em> page of the web UI lists the images currently being cached by MAAS:</p>
<p><a href="images/130aa580-troulbeshoot-faq__2.3_images.png" target = "_blank"><img src="images/130aa580-troulbeshoot-faq__2.3_images.png"></a></a></p>
<p>Images can be downloaded from <a href="https://cloud-images.ubuntu.com/stable/server/">https://cloud-images.ubuntu.com/stable/server</a>.</p>
<p>For example:</p>
<pre><code class="bash">wget https://cloud-images.ubuntu.com/stable/server/xenial/current/xenial-server-cloudimg-amd64-root.tar.gz
</code></pre>

<p>With the image downloaded, extract its contents so that the <em>shadow</em> password file can be edited:</p>
<pre><code class="bash">mkdir xenial
sudo tar -C xenial -xpSf xenial-server-cloudimg-amd64-root.tar.gz --numeric-owner --xattrs &quot;--xattrs-include=*&quot;
</code></pre>

<p><strong>NOTE:</strong> 
<code>sudo</code> is required when extracting the image filesystem and when making changes to the files extracted from the image filesystem.</p>
<p><a href="#heading--generate-password-hash"><h3 id="heading--generate-password-hash">Generate password hash</h3></a></p>
<p>Now generate a hashed password. Use the following Python 3 command, replacing <strong>ubuntu</strong> with the password you wish to use:</p>
<pre><code class="bash">python3 -c 'import crypt; print(crypt.crypt(&quot;ubuntu&quot;, crypt.mksalt(crypt.METHOD_SHA512)))'
</code></pre>

<p>Output from the previous command looks like the following:</p>
<pre><code class="no-highlight">$6$AaHblHl5KGrWBmPV$20ssynyY0EhcT9AwZgA2sTdYt4Bvd97bX7PjeyqVLKun2Hk3NBa8r7efM2duK7pi2dlnd5tG76I0dTUvjb6hx0
</code></pre>

<p>Open the <code>xenial/etc/shadow</code> file extracted from the image with a text editor and insert the password hash into the <em>root</em> user line of <code>etc/shadow</code>, between the first and second colons:</p>
<pre><code class="no-highlight">root:$6$AaHblHl5KGrWBmPV$20ssynyY0EhcT9AwZgA2sTdYt4Bvd97bX7PjeyqVLKun2Hk3NBa8r7efM2duK7pi2dlnd5tG76I0dTUvjb6hx0:17445:0:99999:7:::
</code></pre>

<p>Save the file and exit the text editor.</p>
<p><a href="#heading--rebuild-squashfs-image"><h3 id="heading--rebuild-squashfs-image">Rebuild SquashFS image</h3></a></p>
<p>Recent versions of MAAS use SquashFS to hold the ephemeral image filesystem. The final step is to use the following command to create a SquashFS file called <code>xenial-customized.squashfs</code> that contains the modified shadow file:</p>
<pre><code class="bash">sudo mksquashfs xenial/ xenial-customized.squashfs -xattrs -comp xz
</code></pre>

<p>The output should look like the following:</p>
<pre><code class="no-highlight">Parallel mksquashfs: Using 2 processors
Creating 4.0 filesystem on xenial-customized.squashfs, block size 131072.
[=======]  2516/26975   9%
</code></pre>

<p>You now have an ephemeral image with a working root login that can replace an image locally cached by MAAS.</p>
<p><a href="#heading--use-the-custom-image"><h3 id="heading--use-the-custom-image">Use the custom image</h3></a></p>
<p>Images are synchronised by the region controller and stored on the rack controller in <code>/var/lib/maas/boot-resources/</code>, with the <em>current</em> directory linking to the latest synchronised images.</p>
<p>For example, the latest low-latency Ubuntu 16.04 image can be found in the following directory:</p>
<pre><code class="bash">cd /var/lib/maas/boot-resources/current/ubuntu/amd64/ga-16.04-lowlatency/xenial/stable
</code></pre>

<p>To replace the original, substitute the <em>squashfs</em> file with the custom image generated earlier, making sure the new owner is <em>maas</em>:</p>
<pre><code class="bash">mv squashfs squashfs_original
cp /home/ubuntu/xenial-customized.squashfs .
chown maas:maas squashfs
</code></pre>

<p>You can now use this image to commission or deploy a node and access the root account with the backdoor password, such as by deploying the same specific image from the web UI to the node you wish to troubleshoot.</p>
<p><a href="images/f622d104-troulbeshoot-faq__2.3_deploy.png" target = "_blank"><img src="images/f622d104-troulbeshoot-faq__2.3_deploy.png"></a></a></p>
<hr>
<h2>****</h2>
    </div>
  </body>
</html>