<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-enable-vault.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
      </ul>
      <strong>
	<a href="basic-tutorials.html">
	  Basic tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-bootstrap-tutorial.html">
	    MAAS bootstrap tutorial
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="custom-image-tutorial.html">
	    Custom image tutorial
	  </a>
	</li>
	<li>
	  <a href="using-jq-with-the-maas-cli.html">
	    Using jq with the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-change-maas-settings.html">
	    Change MAAS settings
	  </a>
	</li>
	<li>
	  <a href="how-to-get-help.html">
	    Ask for help
	  </a>
	</li>
	<li>
	  <a href="how-to-request-a-feature.html">
	    Request a feature
	  </a>
	</li>
	<li>
	  <a href="how-to-report-a-bug.html">
	    Report a bug
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-acquire-images.html">
	  How to acquire images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-build-custom-images.html">
	    Build custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-tune-controllers.html">
	  How to tune controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-adjust-your-controllers.html">
	    Adjust your controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-physical-machines.html">
	  How to deploy physical machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-virtual-machines.html">
	  How to deploy virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-create-vm-hosts.html">
	    Create VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-create-and-manage-vms.html">
	    Create and manage VMs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-and-find-machines.html">
	  How to label and find machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
      </ul>
      <strong>
	How to diagnose issues
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-log-files.html">
	    Work with log files
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-audit-event-logs.html">
	    Work with audit event logs
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	How to work securely
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
      </ul>
      <strong>
	How to operate reliably
      </strong>
      <ul>
	<li>
	  <a href="how-to-keep-maas-backed-up.html">
	    Keep MAAS backed up
	  </a>
	</li>
	<li>
	  <a href="how-to-observe-a-live-maas.html">
	    Observe a live MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-protect-your-secrets.html">
	How to protect your secrets
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-enable-vault.html">
	    Enable Vault
	  </a>
	</li>
	<li>
	  <a href="how-to-unseal-vault.html">
	    Unseal Vault
	  </a>
	</li>
      </ul>
      <strong>
	API reference
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="../../api/docs">
	    API documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-technical-reference.html">
	  MAAS technical reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="audit-event-log-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="maas-performance.html">
	    MAAS performance
	  </a>
	</li>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-provider-reference.html">
	    Terraform provider
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to enable Vault</h1><!-- "How to enable Vault" -->

<p>For MAAS to be able to integrate with Vault, a few steps are required.  Specifically, you must get a role_id and wrapped_token via Vault CLI (follow the instructions from <a href="https://learn.hashicorp.com/tutorials/vault/approle-best-practices?in=vault/auth-methods#approle-response-wrapping">Hashicorp Vault</a>).</p>
<p>As an example only, MAAS can be configured by a Vault admin using the <code>vault</code> CLI.</p>
<p>1) The <code>approle</code> engine must be enabled. This can be checked with:</p>
<pre><code class="language-nohighlight">$ vault auth list
</code></pre>
<p>You should verify that it&rsquo;s mounted under <code>approle/</code>.  If not, it can be enabled via:</p>
<pre><code class="language-nohighlight">$ vault auth enable approle
</code></pre>
<p>2) The KV v2 engine is mounted under the desired path (<code>secret/</code> by default, but can be configured as desired). A new KV engine can be mounted with:</p>
<pre><code class="language-nohighlight">$ vault secrets enable -path $SECRETS_MOUNT kv-v2
</code></pre>
<p>3) An appropriate policy that can be assigned to approles configured in MAAS should be configured, providing read/write access to the secrets paths that MAAS will use.  As an example, here is a minimal policy:</p>
<pre><code class="language-nohighlight">path &quot;$SECRETS_MOUNT/metadata/$SECRETS_PATH/&quot; {
    capabilities = [&quot;list&quot;]
}

path &quot;$SECRETS_MOUNT/metadata/$SECRETS_PATH/*&quot; {
    capabilities = [&quot;read&quot;, &quot;update&quot;, &quot;delete&quot;, &quot;list&quot;]
}

path &quot;$SECRETS_MOUNT/data/${SECRETS_PATH}/*&quot; {
    capabilities = [&quot;read&quot;, &quot;create&quot;, &quot;update&quot;, &quot;delete&quot;]
}
</code></pre>
<p>Here, <code>$SECRETS_PATH</code> is the desired path prefix under which MAAS will store secrets. This, together with <code>$SECRETS_MOUNT</code>, will be used when configuring MAAS later. Such a policy can be created in Vault as follows (assuming it was written to <code>$POLICY_FILE</code>):</p>
<pre><code class="language-nohighlight">$ vault policy write $MAAS_POLICY $POLICY_FILE
</code></pre>
<p>4) For each MAAS region controller, create a role using the policy created above:</p>
<pre><code class="language-nohighlight">$ vault write auth/approle/role/$ROLE_NAME \
policies=$MAAS_POLICY token_ttl=5m
</code></pre>
<p>Tthe TTL for tokens can be tweaked as desired.</p>
<p>While it&rsquo;s technically possible to use the same approle for all controllers, it&rsquo;s suggested to use different ones for each.  This increases security and reduces exposure in case credentials are leaked from one controller.</p>
<p>Fetch the role ID for the created role with the following command:</p>
<pre><code class="language-nohighlight">$ vault read auth/approle/role/$ROLE_NAME/role-id
</code></pre>
<p>5) For each created role, create a secret ID, returned with a wrapping token. This, together with the role ID, will be provided to the MAAS controller:</p>
<pre><code class="language-nohighlight">$ vault write -wrap-ttl=5m auth/approle/role/$ROLE_NAME/secret-id
</code></pre>
<p><a href="#heading--Integrating-Vault-with-MAAS"><h2 id="heading--Integrating-Vault-with-MAAS">Integrating Vault with MAAS</h2></a></p>
<p>Once MAAS is installed and configured, it&rsquo;s possible to integrate it with Vault with a few steps, using the CLI:</p>
<pre><code class="language-nohighlight">sudo maas config-vault configure $URL $APPROLE_ID $WRAPPED_TOKEN $SECRETS_PATH --secrets-mount $SECRET_MOUNT
</code></pre>
<p>where the <code>$APPROLE_ID</code> and <code>$WRAPPED_TOKEN</code> are the ones obtained by Vault in the previous steps.</p>
<p><strong>NOTE:</strong> 
This operation must be performed on each region controller before the integration process can continue.</p>
<p>Once this operation has been performed on all region controllers, it&rsquo;s possible to migrate secrets to Vault and complete the integration process, with the following command:</p>
<pre><code class="language-nohighlight">$ sudo maas config-vault migrate
</code></pre>
<p>During migration, MAAS might be offline for a few seconds, but it will refresh quickly.  After this command, MAAS will be fully integrated and functional with Vault. You can confirm success in the UI by checking <strong>Settings &ndash;&gt; Configuration &ndash;&gt; Security</strong>:</p>
<p><img alt="|649x586" src="https://lh3.googleusercontent.com/6huwJZKrnraNHM3hiiVGcrTgOSHD_b0KJOLL1N4s05rKnhQ09UYgMdQHuo5MT_N3lqKn02C_Qg7RQmfrELC4Xjj1pOjIo-N4mMBB8oRj1mfPLbyuw5oKO6jNvvAtUQxwrnKww5DDT1IYDfh9jFCwIoy6MLnOR831kzYHVsgDASfUNEMAW-dwJNdSAt_xTA"></p>
<p><strong>NOTE:</strong><br>
If you try to migrate secrets before all region controllers are configured with Vault, the migrate command will fail with an error message.</p>
<p>If you&rsquo;ve configured all region controllers with Vault, but haven&rsquo;t yet migrated the secrets, the integration process will simply remain incomplete.  The UI will remind you:</p>
<p><img alt="|670x338" src="https://lh3.googleusercontent.com/v2_glOaBx8hTy7TmhD3Y5qe34iFePJN5Z46ZeY6UvGXF7eD4m7chplXtbKIKZMchs2D5WAJSit0tlH27onPV1oUnLZVKwyVOncje3QaZ0n4d-1sjTV5sfuQFopuql_COE0FfvDSFTcKeElnThC3_gKIg6YlNQ-JKvLH6t9sgp6UwrTPAnHzoGpQ6eSmeBQ"></p>
<p><a href="#heading--Updating-secrets-directly"><h2 id="heading--Updating-secrets-directly">Updating secrets directly</h2></a></p>
<p>Secrets related to MAAS stored in Vault could be changed outside of MAAS, directly in Vault. If this happens, MAAS automatically uses the new value, as MAAS elements do not cache secrets &ndash; they are fetched every time they&rsquo;re needed.</p>
<p>MAAS deals with a number of secrets (user password, certificates and keys, API tokens, …). Those are currently stored in the database, which is not secure by default.</p>
    </div>
  </body>
</html>