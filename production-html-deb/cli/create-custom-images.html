<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;margin-top:0;margin-bottom:0;list-style-type:none;padding-left:20px;}
      li {margin: 4px 0;}
      details {margin-top:0;margin-bottom:0;}
      details > summary {
	  padding: 0px;
	  margin-top: 0px;
	  margin-bottom: 0px;
	  width: 200px;
	  background-color: #ffffff;
	  border: none;
	  cursor: pointer;
    	  list-style-type: "< ";
	  direction: rtl;
      }
      details[open] > summary {
	  list-style-type: "v ";
      }
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;
      <strong>Offline docs
      </strong>
      <a href="https://maas.io/docs">(switch to live docs)
      </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <a href="../ui/create-custom-images.html">
          UI-only
        </a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
          &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <ul>
	<li>
          <a href="maas-documentation.html"><b>MAAS Documentation</b></a>
	</li>
	<hr style="margin-top:15px;">
	<li>
          <details>
            <summary><a href="tutorials.html">Tutorials</a></summary>
            <ul>
              <li>
		<details>
                  <summary>Try out MAAS</summary>
		  <ul>
		    <li>
		      <a href="bootstrap-maas.html">Bootstrap MAAS</a>
		    </li>
		    <li>
		      <a href="get-to-know-your-machines.html">Get to know your machines</a>
		    </li>
		  </ul>
		</details>
              </li>
	      <li>
		<a href="try-out-the-maas-cli.html">Try out the MAAS CLI</a>
	      </li>
	      <li>
		<a href="create-custom-images.html">Create custom images</a>
	      </li>
	      <li>
		<a href="get-fancy-cli-output.html">Create custom images</a>
	      </li>
              <li>
		<details>
                  <summary>Primer tutorials</summary>
		  <ul>
		    <li>
		      <a href="osi-model-tutorial.html">OSI model tutorial</a>
		    </li>
		  </ul>
		</details>
              </li>
            </ul>
          </details>
	</li>
	<hr style="margin-top:15px;">
	<li>
          <details>
            <summary><a href="how-to-guides.html">How-to guides</a></summary>
            <ul>
              <li>
		<details>
                  <summary><a href="get-started-with-maas.thml">Get started with MAAS</a></summary>
		  <ul>
                    <li>
                      <a href="do-a-fresh-install-of-maas.html">Do a fresh install of MAAS</a>
		    </li>
		    <li>
                      <a href="upgrade-maas.html">Upgrade MAAS</a>
		    </li>
		    <li>
                      <a href="spin-up-maas-with-ansible.html">Spin up MAAS with Ansible</a>
		    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
                  <summary><a href="set-up-networks.html">Set up networks</a></summary>
		  <ul>
                    <li>
                      <a href="connect-maas-networks.html">Connect MAAS networks</a>
                    </li>
                    <li>
                      <a href="enable-dhcp.html">Enable DHCP</a>
                    </li>
                    <li>
                      <a href="use-availability-zones.html">Use availability zones</a>
                    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
                  <summary><a href="use-images.html">Use images</a></summary>
		  <ul>
                    <li>
                      <a href="use-standard-images.html">Use standard images</a>
                    </li>
                    <li>
                      <a href="mirror-images-locally.html">Mirror images locally</a>
                    </li>
                    <li>
                      <a href="customise-images.html">Customise images</a>
                    </li>
                    <li>
                      <a href="employ-vmware-images.html">Employ VMWare images</a>
                    </li>
                    <li>
                      <a href="deply-a-rt-kernel.html">Deploy a RT kernel</a>
                    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
                  <summary><a href="manage-controllers.html">Manage controllers</a></summary>
		  <ul>
		    <li>
		      <a href="configure-controllers.html">Configure controllers</a>
		    </li>
		    <li>
		      <a href="enable-high-availability.html">Enable high availability</a>
		    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
                  <summary><a href="manage-machines.html">Manage machines</a></summary>
		  <ul>
		    <li>
		      <a href="make-machines-available.html">Make machines available</a>
		    </li>
		    <li>
		      <a href="customise-machines.html">Customise machines</a>
		    </li>
		    <li>
		      <a href="put-machines-to-work.html">Put machines to work</a>
		    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
                  <summary><a href="use-virtual-machines.html">Use virtual machines</a></summary>
		  <ul>
		    <li>
		      <a href="set-up-lxd.html">Set up LXD</a>
		    </li>
		    <li>
		      <a href="manage-vm-hosts.html">Manage VM hosts</a>
		    </li>
		    <li>
		      <a href="manage-virtual-machines.html">Manage virtual machines</a>
		    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
                  <summary><a href="label-devices.html">Label devices</a></summary>
		  <ul>
		    <li>
		      <a href="tag-machines.html">Tag machines</a>
		    </li>
		    <li>
		      <a href="annotate-machines.html">Annotate machines</a>
		    </li>
		    <li>
		      <a href="use-machine-tags.html">Use machine tags</a>
		    </li>
		    <li>
		      <a href="use-controller-tags.html">Use controller tags</a>
		    </li>
		    <li>
		      <a href="use-storage-tags.html">Use storage tags</a>
		    </li>
		    <li>
		      <a href="use-network-tags.html">Use network tags</a>
		    </li>
		  </ul>
		</details>
              </li>
	      <li>
		<details>
                  <summary><a href="secure-maas.html">Secure MAAS</a></summary>
		  <ul>
		    <li>
		      <a href=.html"improve-MAAS-security.html">Improve MAAS security</a>
		    </li>
		    <li>
		      <a href="manage-user-accounts.html">Manage user accounts</a>
		    </li>
		    <li>
		      <a href="enable-MAAS-native TLS.html">Enable MAAS native TLS</a>
		    </li>
		    <li>
		      <a href="use-Vault-with-MAAS.html">Use Vault with MAAS</a>
		    </li>
		    <li>
		      <a href="set-up-an-air-gapped MAAS.html">Set up an air-gapped MAAS</a>
		    </li>
		  </ul>
		</details>
              </li>
            </ul>
          </details>
	</li>
	<hr style="margin-top:15px;">
	<li>
          <details>
            <summary><a href="reference.html">Reference</a></summary>
            <ul>
	      <details>
		<summary><a href="release-notes.html">Release notes</a></summary>
		<ul>
		  <li>
		    <a href="maas-3-4-release notes.html">MAAS 3.4 release notes</a>
              	  </li>
		  <li>
              	    <a href="maas-3-3-release notes.html">MAAS 3.3 release notes</a>
              	  </li>
		  <li>
              	    <a href="maas-3-2-release notes.html">MAAS 3.2 release notes</a>
              	  </li>
		  <li>
              	    <a href="maas-3-1-release notes.html">MAAS 3.1 release notes</a>
              	  </li>
		  <li>
              	    <a href="maas-3-0-release notes.html">MAAS 3.0 release notes</a>
              	  </li>
		  <li>
              	    <a href="maas-2-9-release notes.html">MAAS 2.9 release notes</a>
              	  </li>
		  <li>
              	    <a href="maas-2-8-release notes.html">MAAS 2.8 release notes</a>
              	  </li>
		  <li>
              	    <a href="maas-2-7-release notes.html">MAAS 2.7 release notes</a>
              	  </li>
		</ul>
	      </details>
              <li>
		<details>
                  <summary><a href="general-reference.html">General</a></summary>
		  <ul>
		    <li>
		      <a href="maas-settings.html">Settings</a>
		    </li>
		    <li>
		      <a href="https://launchpad.net/maas">Source code</a>
		    </li>
		    <li>
		      <a href="doc-style-guide.html">Doc style guide</a>
		    </li>
		    <li>
		      <a href="glossary.html">Glossary</a>
		    </li>
		    <li>
		      <a href="https://ubuntu.com/community/code-of-conduct">Code of conduct</a>
		    </li>
		  </ul>
		</details>
	      </li>
              <li>
		<details>
		  <summary><a href="api.html">API</a></summary>
		  <ul>
		    <li>
                      <a href="api-authentication.html">API authentication</a>
                    </li>
		    <li>
                      <a href="python-api-client.html">Python API client</a>
                    </li>
		    <li>
                      <a href="/docs/api">API documentation</a>
                    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
		  <summary><a href="scripts.html">Scripts</a></summary>
		  <ul>
		    <li>
                      <a href="commissioning-scripts.html">Commissioning scripts</a>
                    </li>
		    <li>
                      <a href="hardware-test-scripts.html">Hardware test scripts</a>
                    </li>
		    <li>
                      <a href="terraform.html">Terraform</a>
                    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
		  <summary><a href="logging.html">Logging</a></summary>
		  <ul>
		    <li>
                      <a href="event-logs.html">Event logs</a>
                    </li>
		    <li>
                      <a href="audit-event-logs.html">Audit event logs</a>
                    </li>
		    <li>
                      <a href="commissioning-logs.html">Commissioning logs</a>
                    </li>
		    <li>
                      <a href="testing-logs.html">Testing logs</a>
                    </li>
		  </ul>
		</details>
              </li>
              <li>
		<details>
		  <summary><a href="machine-parameters.html">machine-parameters</a></summary>
		  <ul>
		    <li>
                      <a href=.html"power-drivers.html">Power drivers</a>
                    </li>
		    <li>
                      <a href="storage-layouts.html">Storage layouts</a>
                    </li>
		    <li>
                      <a href="device-labelling.html">Device labelling</a>
                    </li>
		  </ul>
		</details>
              </li>
	    </ul>
	  </details>
	</li>
	<hr style="margin-top:15px;">
	<li>
	  <details>
	    <summary><a href="explanation.html">Explanation</a></summary>
	    <ul>
	      <li>
		<a href="maas.html">About MAAS</a>
		-           </li>
	      <li>
		<a href=.html"high-availability.html">High availability</a>
              </li>
	      <li>
		<details>
		  <summary>Networking</summary>
		  <ul>
		    <li>
		      <a href="maas-networks.html">MAAS networks</a>
		    </li>
		    <li>
		      <a href="tcp/IP-primer.html">TCP/IP primer</a>
		    </li>
		    <li>
		      <a href="dhcp-primer.html">DHCP primer</a>
		    </li>
		    <li>
		      <a href="cloud-networking-primer.html">Cloud networking primer</a>
		    </li>
		  </ul>
		</details>
	      </li>
	      <li>
		<a href="images.html">Images</a>
              </li>
	      <li>
		<a href="controllers.html">Controllers</a>
              </li>
	      <li>
		<a href="machines.html">Machines</a>
              </li>
	      <li>
		<a href="virtual-machines.html">Virtual machines</a>
              </li>
	      <li>
		<a href="device-labels.html">Device labels</a>
              </li>
	      <li>
		<a href="maas-events.html">Events</a>
              </li>
	      <li>
		<a href="audit-events.html">Audit events</a>
              </li>
	      <li>
		<a href="maas-logging.html">Logging</a>
              </li>
	      <li>
		<a href="maas-security.html">Security</a>
              </li>
	      <li>
		<a href="maas-performance.html">Performance</a>
              </li>
	      <li>
		<a href="ansible.html">Ansible</a>
              </li>
	    </ul>
	  </details>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
      <h1>Create a custom image</h1><!-- "Create a custom image" -->
<p>Custom OS image creation is often viewed as a complex task, but with <code>packer-maas</code>, the process can be simplified significantly. The <code>packer-maas</code> tool provides a robust interface for creating and deploying custom Ubuntu images on MAAS. With <code>packer-maas</code>, you can easily create and customize your own Ubuntu images with just a few simple commands.</p>
<p>Creating a custom Ubuntu image with <code>packer-maas</code> is a straightforward process. With <code>packer-maas</code>, you can create a new image from scratch or use an existing Ubuntu image as a base. You can then customize the image with any software packages, configuration files, or other modifications that you require. By simplifying the process of image creation and deployment, <code>packer-maas</code> makes it relatively easy to create customized images (Ubuntu and others) that meet your requirements.</p>
<p>Let&rsquo;s walk through the process, using a simple example, to get comfortable with the process.</p>
<p><a href="#heading--install-maas"><h2 id="heading--install-maas">First, install MAAS</h2></a></p>
<p>If we&rsquo;re going to create custom images for MAAS, then first, we&rsquo;ll need MAAS!  You can use <a href="how-to-do-a-fresh-install-of-maas.html">these instructions</a> to accomplish that, and get a feel for MAAS while you&rsquo;re at it.</p>
<p><a href="#heading--install-packer"><h2 id="heading--install-packer">Install packer</h2></a></p>
<p>The next step is to install the tool <code>packer</code>, which will do the heavy lifting for us.  Packer is easily installed from its Debian package:</p>
<pre><code class="language-nohighlight">sudo apt install packer
</code></pre>
<p>This should install with no additional prompts.</p>
<p><a href="#heading--install-dependencies"><h2 id="heading--install-dependencies">Install dependencies</h2></a></p>
<p>We&rsquo;re going to create a &ldquo;custom&rdquo; Ubuntu image for this build, so we&rsquo;ll want to install a few dependencies.  Enter the following commands.  Don&rsquo;t worry about any output between commands:</p>
<pre><code class="language-nohighlight">sudo apt install qemu-utils
sudo apt install qemu-system
sudo apt install ovmf
sudo apt install cloud-image-utils
</code></pre>
<p><a href="#heading--get-the-packer-templates"><h2 id="heading--get-the-packer-templates">Get the packer templates</h2></a></p>
<p>Packer uses &ldquo;templates&rdquo;, which are very much like scripts that build your custom image.  You can obtain the packer templates by cloning the <a href="https://github.com/canonical/packer-maas.git">packer-maas github repository</a><code>↗</code>, like this:</p>
<pre><code class="language-nohighlight">cd ~
mkdir -p tmp/git
cd tmp/git
git clone https://github.com/canonical/packer-maas.git
</code></pre>
<p>Make sure to pay attention to where the repository is cloned, in this case, <code>tmp/git</code> in your home directory.  The packer template in this cloned repository creates a Ubuntu AMD64 image for use with MAAS.</p>
<p><a href="#heading--build-an-image"><h2 id="heading--build-an-image">Build an Ubuntu image</h2></a></p>
<p>Now that we have that, let&rsquo;s build a custom Ubuntu image that we can deploy with MAAS.  Use these commands to do that:</p>
<pre><code class="language-nohighlight">cd ~/tmp/git/packer-maas/ubuntu
make custom-ubuntu-lvm.dd.gz
</code></pre>
<p>This <code>make</code> will run for a couple of minutes before attempting to boot the image.  While waiting for the image to boot, you will see terminal messages similar to this one for upwards of three to five minutes:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:46 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] SSH handshake err: ssh: handshake failed: ssh: unable to authenticate, attempted methods [none password], no supported methods remain
2022/05/09 15:50:50 packer-builder-qemu plugin: [DEBUG] Detected authentication error. Increasing handshake attempts.
</code></pre>
<p>That&rsquo;s expected.  Eventually, you should see a successful SSH connection:</p>
<pre><code class="language-nohighlight">2022/05/09 15:50:57 packer-builder-qemu plugin: [INFO] Attempting SSH connection to 127.0.0.1:2351...
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] reconnecting to TCP connection for SSH
2022/05/09 15:50:57 packer-builder-qemu plugin: [DEBUG] handshaking with SSH
2022/05/09 15:51:17 packer-builder-qemu plugin: [DEBUG] handshake complete!
</code></pre>
<p>After this, a few more commands will run.  Eventually the terminal screen will clear and show just one line, as follows:</p>
<pre><code class="language-nohighlight">rm OVMF_VARS.fd
</code></pre>
<p>That means you&rsquo;ve successfully built the image!  Just to prove it to ourselves, let&rsquo;s take a couple of additional steps.</p>
<p><a href="#heading--validate-the-build"><h2 id="heading--validate-the-build">Validate the build</h2></a></p>
<p>You can check the validity of the operation with a simple <code>ls</code> command in <code>~/tmp/git/packer-maas/ubuntu</code> (where you ran the <code>make</code> command), like this:</p>
<pre><code class="language-nohighlight">stormrider@neuromancer:~/mnt/Dropbox/src/git/packer-maas/ubuntu$ ls
custom-ubuntu-lvm.dd.gz  packages      seeds-lvm.iso     user-data-lvm
http                     packer_cache  ubuntu-flat.json
Makefile                 README.md     ubuntu-lvm.json
meta-data                scripts       user-data-flat
</code></pre>
<p>See the <code>custom-ubuntu-lvm.dd.gz</code> file?  That&rsquo;s our image, ready to try out.</p>
<p><a href="#heading--upload-to-maas"><h2 id="heading--upload-to-maas">Upload the image to MAAS</h2></a></p>
<p>You can upload your newly-created image with the following command:</p>
<pre><code class="language-nohighlight">$ maas admin boot-resources create \
    name='custom/ubuntu-raw' \
    title='Ubuntu Custom RAW' \
    architecture='amd64/generic' \
    filetype='ddgz' \
    content@=custom-ubuntu-lvm.dd.gz
</code></pre>
<p><a href="#heading--deploy-your-image"><h2 id="heading--deploy-your-image">Deploy the image in MAAS</h2></a></p>
<p>What good is an image if we can&rsquo;t deploy it?  Pick one of the VMs you created in the <a href="try-out-the-maas-cli.html">last tutorial</a> and deploy your new OS image to it.  Then use a command like this one to see it running:</p>
<pre><code class="language-nohighlight">maas admin machines read | jq -r '([&quot;HOSTNAME&quot;,&quot;SYSID&quot;,&quot;POWER&quot;,&quot;STATUS&quot;,
&quot;OWNER&quot;, &quot;OS&quot;, &quot;DISTRO&quot;] | (., map(length*&quot;-&quot;))),
(.[] | [.hostname, .system_id, .power_state, .status_name, .owner // &quot;-&quot;,
.osystem, .distro_series]) | @tsv' | column -t

HOSTNAME     SYSID   POWER  STATUS    OWNER  OS      DISTRO
--------     -----   -----  ------    -----  --      ------
valued-moth  e86c7h  on     Deployed  admin  ubuntu  focal
open-gannet  nk7x8y  on     Deployed  admin  custom  ubuntu-raw
</code></pre>
<p>It&rsquo;s the machine named <code>open-gannet</code> in the listing above, but your machine name and $SYSID will be unique to your instance.</p>
<p><a href="#heading--thats-all-there-is-to-it"><h2 id="heading--thats-all-there-is-to-it">That&rsquo;s all there is to it!</h2></a></p>
<p>In a few simple steps, you&rsquo;ve used packer to create a custom Ubuntu image, upload it to a running MAAS, and deploy it.  There are many different custom images that can be deployed with MAAS &ndash; check <a href="how-to-customise-images.html">this guide</a> to learn more.</p>
    </div>
  </body>
</html>