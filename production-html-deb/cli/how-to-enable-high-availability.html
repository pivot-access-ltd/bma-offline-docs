<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" type="text/css" href="css/stylesheet.css" />
    <style>
      #selector a:link{color:black;}
      #selector a:visited{color:black;}
      #selector a:active{color:black;}
      #selector a:hover{color:blue;}
      #sidebar a:link{color:black;}
      #sidebar a:visited{color:black;}
      #sidebar a:active{color:black;}
      #sidebar a:hover{color:blue;}
      ul {margin-left:0;list-style-type:none;}
      li {margin: 4px 0;}
    </style>
  </head>
  <body>
    <div id="selector" style="top:0; position:fixed; float:right; background-color:#d9d9d9; width:100%;border-bottom:1px solid black;">
      &nbsp;&nbsp;<strong>Offline docs</strong>
      <a href="https://maas.io/docs">(switch to live docs)</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<a href="../ui/how-to-enable-high-availability.html">
	  UI-only
	</a>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
      <span style="background-color:white;border-top:1px solid black; border-left:1px solid black; border-right:1px solid black; border-bottom:5px solid white;">
	  &nbsp;CLI-only&nbsp;
      </span>
    </div>
    <div id="sidebar" style="float:left; width:25%;margin-top:40px; margin-left:20px">
      <strong>
	<a href="maas-documentation-25.html">
	  Home
	</a>
      </strong>
      <ul>
	<li>
	  <a href="what-is-new-with-maas.html">
	    Release notes
	  </a>
	</li>
	<li>
	  <a href="maas-installation-requirements.html">
	    Installation requirements
	  </a>
	</li>
	<li>
	  <a href="maas-glossary.html">
	    Glossary
	  </a>
	</li>
      </ul>
      <strong>
	<a href="basic-tutorials.html">
	  Basic tutorials
	</a>
      </strong>
      <ul>
	<li>
	  <a href="maas-bootstrap-tutorial.html">
	    MAAS bootstrap tutorial
	  </a>
	</li>
	<li>
	  <a href="try-out-the-maas-cli.html">
	    Try out the MAAS CLI
	  </a>
	</li>
	<li>
	  <a href="custom-image-tutorial.html">
	    Custom image tutorial
	  </a>
	</li>
	<li>
	  <a href="using-jq-with-the-maas-cli.html">
	    Using jq with the MAAS CLI
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-get-started-with-maas.html">
	  How to get started with MAAS
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-spin-up-maas-with-ansible.html">
	    Spin up MAAS with Ansible
	  </a>
	</li>
	<li>
	  <a href="how-to-install-maas.html">
	    Install MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-upgrade-maas.html">
	    Upgrade MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-change-maas-settings.html">
	    Change MAAS settings
	  </a>
	</li>
	<li>
	  <a href="how-to-get-help.html">
	    Ask for help
	  </a>
	</li>
	<li>
	  <a href="how-to-request-a-feature.html">
	    Request a feature
	  </a>
	</li>
	<li>
	  <a href="how-to-report-a-bug.html">
	    Report a bug
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-set-up-networks.html">
	  How to set up networks
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-connect-maas-networks.html">
	    Connect MAAS networks
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-dhcp.html">
	    Enable DHCP
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-availability-zones.html">
	    Manage zones (AZs)
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-acquire-images.html">
	  How to acquire images
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-use-standard-images.html">
	    Use standard images
	  </a>
	</li>
	<li>
	  <a href="how-to-mirror-images-locally.html">
	    Mirror images locally
	  </a>
	</li>
	<li>
	  <a href="how-to-build-custom-images.html">
	    Build custom images
	  </a>
	</li>
	<li>
	  <a href="how-to-employ-vmware-images.html">
	    Employ VMWare images
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-tune-controllers.html">
	  How to tune controllers
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-adjust-your-controllers.html">
	    Adjust your controllers
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-high-availability.html">
	    Enable HA
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-physical-machines.html">
	  How to deploy physical machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-make-machines-available.html">
	    Make machines available
	  </a>
	</li>
	<li>
	  <a href="how-to-customise-machines.html">
	    Customise machines
	  </a>
	</li>
	<li>
	  <a href="how-to-put-machines-to-work.html">
	    Put machines to work
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-deploy-virtual-machines.html">
	  How to deploy virtual machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-set-up-lxd.html">
	    Set up LXD
	  </a>
	</li>
	<li>
	  <a href="how-to-create-vm-hosts.html">
	    Create VM hosts
	  </a>
	</li>
	<li>
	  <a href="how-to-create-and-manage-vms.html">
	    Create and manage VMs
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-label-and-find-machines.html">
	  How to label and find machines
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-tag-machines.html">
	    Tag machines
	  </a>
	</li>
	<li>
	  <a href="how-to-annotate-machines.html">
	    Annotate machines
	  </a>
	</li>
	<li>
	  <a href="how-to-use-machine-tags.html">
	    Use machine tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-controller-tags.html">
	    Use controller tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-storage-tags.html">
	    Use storage tags
	  </a>
	</li>
	<li>
	  <a href="how-to-use-network-tags.html">
	    Use network tags
	  </a>
	</li>
	<li>
	  <a href="how-to-find-machines.html">
	    Find machines
	  </a>
	</li>
      </ul>
      <strong>
	How to diagnose issues
      </strong>
      <ul>
	<li>
	  <a href="how-to-work-with-log-files.html">
	    Work with log files
	  </a>
	</li>
	<li>
	  <a href="how-to-work-with-audit-event-logs.html">
	    Work with audit event logs
	  </a>
	</li>
	<li>
	  <a href="how-to-troubleshoot-maas.html">
	    Troubleshoot MAAS
	  </a>
	</li>
      </ul>
      <strong>
	How to work securely
      </strong>
      <ul>
	<li>
	  <a href="how-to-improve-maas-security.html">
	    Improve MAAS security
	  </a>
	</li>
	<li>
	  <a href="how-to-enable-maas-native-tls.html">
	    Enable MAAS native TLS
	  </a>
	</li>
	<li>
	  <a href="how-to-set-up-an-air-gapped-maas.html">
	    Set up an air-gapped MAAS
	  </a>
	</li>
	<li>
	  <a href="how-to-manage-user-accounts.html">
	    Manage user accounts
	  </a>
	</li>
      </ul>
      <strong>
	How to operate reliably
      </strong>
      <ul>
	<li>
	  <a href="how-to-keep-maas-backed-up.html">
	    Keep MAAS backed up
	  </a>
	</li>
	<li>
	  <a href="how-to-observe-a-live-maas.html">
	    Observe a live MAAS
	  </a>
	</li>
      </ul>
      <strong>
	<a href="how-to-protect-your-secrets.html">
	How to protect your secrets
	</a>
      </strong>
      <ul>
	<li>
	  <a href="how-to-enable-vault.html">
	    Enable Vault
	  </a>
	</li>
	<li>
	  <a href="how-to-unseal-vault.html">
	    Unseal Vault
	  </a>
	</li>
      </ul>
      <strong>
	API reference
      </strong>
      <ul>
	<li>
	  <a href="api-authentication-reference.html">
	    API authentication
	  </a>
	</li>
	<li>
	  <a href="python-api-client-reference.html">
	    API client
	  </a>
	</li>
	<li>
	  <a href="../../api/docs">
	    API documentation
	  </a>
	</li>
      </ul>
      <strong>
	<a href="maas-technical-reference.html">
	  MAAS technical reference
	</a>
      </strong>
      <ul>
	<li>
	  <a href="commissioning-scripts-reference.html">
	    Commissioning scripts
	  </a>
	</li>
	<li>
	  <a href="hardware-test-scripts-reference.html">
	    Hardware test scripts
	  </a>
	</li>
	<li>
	  <a href="audit-event-log-reference.html">
	    Audit event logs
	  </a>
	</li>
	<li>
	  <a href="maas-performance.html">
	    MAAS performance
	  </a>
	</li>
	<li>
	  <a href="power-management-reference.html">
	    Power management
	  </a>
	</li>
	<li>
	  <a href="storage-layouts-reference.html">
	    Storage layouts
	  </a>
	</li>
	<li>
	  <a href="maas-terraform-provider-reference.html">
	    Terraform provider
	  </a>
	</li>
      </ul>
    </div>
    <div class="container" style="float:right; width:65%; margin-top:40px; margin-right:30px">
  <h1>How to enable high availability</h1><!-- "How to enable high availability" -->
<p>High availability is built into MAAS: region and rack controllers balance the load and execute failover as part of normal operations. This article will help you understand how to take advantage of these built-in features.</p>
<p><a href="#heading--rack-controller-ha"><h2 id="heading--rack-controller-ha">How to put MAAS in HA mode</h2></a></p>
<p>You only need to <a href="how-to-adjust-your-controllers.html#heading--install-a-rack-controller">install multiple rack controllers</a> to achieve real high availability.  Once that&rsquo;s done, you automatically gain highly-available BMC control and highly-available DHCP.  MAAS is constantly trying to answer three questions:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>How many racks is each region managing?</li>
<li>How many connections does a given rack controller have?</li>
<li>How many regions &ndash; and region &ldquo;worker processes&rdquo; are running right now?</li>
</ul>
<p>With just one rack, most of the logic can&rsquo;t function.  On the other hand, when you have multiple racks (and especially multiple regions), MAAS will continuously balance the load.</p>
<p>Every time a rack controller connects to a region controller to do something, MAAS checks whether racks and regions are balanced.  If the ratio for one rack-region connection is above a moderate threshold, compared to other connections, MAAS will re-balance.  This activity includes balancing not only discrete region controllers, but also re-distributing connections so that no single worker process has an uneven share of the load.</p>
<p>Rebalancing is also done at various other opportune times.  For example, if a network change happens (like toggling DHCP or changing a VLAN), MAAS will also re-balance the load.  And MAAS can maintain primary and secondary rack designations, so that faster, more nuanced load-balancing can occur.</p>
<p><a href="#heading--bmc-ha"><h3 id="heading--bmc-ha">How to enable highly-available BMC</h3></a></p>
<p>You can also enable HA for BMC control (node power cycling) just by adding a second rack controller. MAAS will automatically identify which rack controller is responsible for a BMC, continuously balancing the connections.</p>
<p><a href="#heading--dhcp-ha"><h3 id="heading--dhcp-ha">How to enable highly-available DHCP services</h3></a></p>
<p>You can enable highly-availalbe DHCP services by using MAAS-managed DHCP, and adding rack controllers.  This DHCP HA affects the way MAAS manages nodes, including enlistment, commissioning and deployment. It enables primary and secondary DHCP instances to serve the same VLAN. This VLAN replicates all lease information is between rack controllers, so there&rsquo;s a bit of performance boost for large networks.</p>
<p>MAAS DHCP automatically creates failover peers, using mostly standard parameters:</p>
<pre><code class="language-nohighlight">failover peer &quot;failover-partner&quot; {
     primary;
     address dhcp-primary.example.com;
     peer address dhcp-secondary.example.com;
     max-response-delay 60;
     max-unacked-updates 10;
     mclt 3600;
     split 255;
     load balance max seconds 3;
}
failover peer &quot;failover-partner&quot; {
     secondary;
     address dhcp-secondary.example.com;
     peer address dhcp-primary.example.com;
     max-response-delay 60;
     max-unacked-updates 10;
     load balance max seconds 3;
}
</code></pre>
<p>Note that the only difference from a standard 50/50 split (<code>split 128</code>) is that the primary DHCP server answers any requests that it can (<code>split 255</code>), within the maximum response delay of 60 seconds and an unacknowledged update count of 10.  In this sense, highly-available MAAS DHCP fails over only when absolutely necessary.</p>
<p>If you are enabling DHCP for the first time after adding a second rack controller, please read <a href="how-to-enable-dhcp.html#heading--enabling-dhcp">Enabling DHCP</a>.  On the other hand, if you have already enabled DHCP on your initial rack controller, you&rsquo;ll need to reconfigure DHCP to get optimum results.</p>
<p><a href="#heading--multiple-region-endpoints"><h3 id="heading--multiple-region-endpoints">How to configure multiple region endpoints</h3></a></p>
<pre><code>.
.
.
maas_url:
  - http://&lt;ip 1&gt;:&lt;port&gt;/MAAS/
  - http://&lt;ip 2&gt;:&lt;port&gt;/MAAS/
.
.
.
</code></pre>
<p>The setup of highly-available DHCP is now complete.  Note that, for HA purposes, DHCP provisioning will take into account multiple DNS services when there is more than one region controller on a single region.</p>
<p><a href="#heading--region-controller-ha"><h2 id="heading--region-controller-ha">How to make region controllers highly available</h2></a></p>
<p>Implementing highly-available region control is possible when you learn:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li><a href="#heading--postgresql-ha">How to enable highly-available PostgreSQL</a></li>
<li><a href="#heading--secondary-api-servers">How to enable highly-available API services</a></li>
<li><a href="#heading--load-balancing-with-haproxy-optional">How to set up load balancing with HAProxy (optional)</a></li>
</ul>
<p>Load balancing is optional, but is highly recommended.</p>
<p><a href="#heading--postgresql-ha"><h3 id="heading--postgresql-ha">How to enable highly-available PostgreSQL</h3></a></p>
<p>MAAS stores all state information in the PostgreSQL database. It is therefore recommended to run it in HA mode. Configuring HA for PostgreSQL is external to MAAS. You will, therefore, need to study the <a href="https://www.postgresql.org/docs/9.5/static/high-availability.html">PostgreSQL documentation</a><code>↗</code> and implement the variant of HA that makes you feel most comfortable.</p>
<p>Each region controller uses up to 40 connections to PostgreSQL in high load situations. Running two region controllers requires no modifications to the <code>max_connections</code> in <code>postgresql.conf</code>. More than two region controllers require that <code>max_connections</code> be adjusted to add 40 more connections per added region controller.</p>
<p><a href="#heading--secondary-api-servers"><h3 id="heading--secondary-api-servers">How to enable highly-available API services</h3></a></p>
<p><a href="#heading--load-balancing-with-haproxy-optional"><h3 id="heading--load-balancing-with-haproxy-optional">How to enable load balancing for API services</h3></a></p>
<p>You can add load balancing with <a href="http://www.haproxy.org/">HAProxy</a><code>↗</code> load-balancing software to support multiple API servers. In this setup, HAProxy provides access to the MAAS web UI and API.</p>
<p><strong>NOTE:</strong> 
If you happen to have Apache running on the same server where you intend to install HAProxy, you will need to stop and disable <code>apache2</code>, because HAProxy binds to port 80.</p>
<p><a href="#heading--install"><h4 id="heading--install">How to install HAProxy</h4></a></p>
<pre><code class="language-bash">sudo apt install haproxy
</code></pre>
<p><a href="#heading--configure"><h4 id="heading--configure">How to configure HAProxy</h4></a></p>
<p>Configure each API server&rsquo;s load balancer by copying the following into <code>/etc/haproxy/haproxy.cfg</code> (see the <a href="http://cbonte.github.io/haproxy-dconv/1.6/configuration.html">upstream configuration manual (external link)</a><code>↗</code> as a reference). Replace $PRIMARY_API_SERVER_IP and $SECONDARY_API_SERVER_IP with their respective IP addresses:</p>
<pre><code class="language-yaml">frontend maas
    bind    *:80
    retries 3
    option  redispatch
    option  http-server-close
    default_backend maas

backend maas
    timeout server 90s
    balance source
    hash-type consistent
    server localhost localhost:5240 check
    server maas-api-1 $PRIMARY_API_SERVER_IP:5240 check
    server maas-api-2 $SECONDARY_API_SERVER_IP:5240 check
</code></pre>
<p>where <code>maas-api-1</code> and <code>maas-api-2</code> are arbitrary server labels.</p>
<p>Now restart the load balancer to have these changes take effect:</p>
<pre><code class="language-bash">sudo systemctl restart haproxy
</code></pre>
<p>The configuration of region controller HA is now complete.</p>
<p><strong>The API server(s) must be now be referenced (e.g. web UI, MAAS CLI) using port 80 (as opposed to port 5240).</strong></p>
<p><a href="#heading--move-rack-controller"><h2 id="heading--move-rack-controller">Move a rack controller from one MAAS instance to another</h2></a></p>
<p>Next, you must register a new rack controller, which is always done from the command line.</p>
<p><a href="#heading--move-rack-controller"><h3 id="heading--dangers-moving-rack-controller">How to avoid the potential pitfalls of moving a rack controller</h3></a></p>
<p>There are dangers associate with moving a rack controller &ndash; dangers that may generate errors, get you into a non-working state, or cause you significant data loss.  These dangers are precipitated by one caveat and two potential mistakes:</p>
<ul style="margin-left:4px; list-style-type:disc;">
<li>
<p><strong>Using the same system as a rack controller and a VM host:</strong> While not forbidden or inherently dangerous, using the same machine as both a rack controller and a VM host may cause resource contention and poor performance.  If the resources on the system are not more than adequate to cover both tasks, you may see slowdowns (or even apparent &ldquo;freeze&rdquo; events) on the system.</p>
</li>
<li>
<p><strong>Moving a rack controller from one version of MAAS to another:</strong> MAAS rack controller software is an integral part of each version of MAAS.  If you delete a rack controller from, say, a 2.6 version of MAAS, and attempt to register that 2.6 version of the rack controller code to, say, a 2.9 version of MAAS, you may experience errors and potential data loss.  Using the above example, if you are running both a VM host and a rack controller for MAAS 2.6 on one system, and you suddenly decide to delete that rack controller from 2.6 and attempt to register the same code to a 2.9 MAAS, the VM host may fail or disappear.  This will possibly delete all the VMs you have created or connected to that VM host &ndash; which may result in data loss.  This action is not supported.</p>
</li>
<li>
<p><strong>Connecting one instance of a rack controller to two instances of MAAS, regardless of version:</strong> Trying to connect a single rack controller to two different instances of MAAS can result in all sorts of unpredictable (and potentially catastrophic) behaviour.  It is not a supported configuration.</p>
</li>
</ul>
<p>Take these warnings to heart.  It may seem like a faster approach to &ldquo;bridge&rdquo; your existing rack controllers from one MAAS to another &ndash; or from one version of MAAS to another &ndash; while they&rsquo;re running.  Ultimately, though, it will probably result in more work than just following the recommended approach.</p>
    </div>
  </body>
</html>